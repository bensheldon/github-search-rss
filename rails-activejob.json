{
    "version": "https://jsonfeed.org/version/1",
    "title": "rails/rails: Issues containing 'ActiveJob Job'",
    "home_page_url": "https://github.com/search?q=ActiveJob+Job+repo%3Arails%2Frails+is%3Aissue&type=Issues",
    "feed_url": "https://bensheldon.github.io/github-search-rss/rails-activejob.json",
    "description": "rails/rails: Issues containing 'ActiveJob Job' on GitHub",
    "items": [
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/79303?u=99e3bc7887879138e88a4538ca623b0a3d7538cb&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Summary</h3>\n<p>Like many folks, I set this in my <code>config/environments/test.rb</code> file:</p>\n<div class=\"highlight highlight-source-ruby position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"config.active_job.queue_adapter = :inline  \n\"><pre><span class=\"pl-en\">config</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">active_job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_adapter</span> <span class=\"pl-c1\">=</span> <span class=\"pl-pds\">:inline</span>  </pre></div>\n<p>The reason I do this is to have easy-to-test, deterministic behavior of any potentially async delayed jobs triggered by the application. Under Rails 5, all of my tests (children of <code>ActiveSupport::TestCase</code> and <code>ActionDispatch::SystemTestCase</code> alike) would respect this queue adapter. However, under Rails 6, any built-in Rails test case that includes <code>ActiveJob::TestHelper</code> will also override this setting for all descendants of <code>ActiveJob::Base</code> (<a href=\"https://github.com/rails/rails/blob/master/activejob/lib/active_job/test_helper.rb#L39-L41\">relevant source</a>).</p>\n<p>The net effect of this is that my <code>perform_later</code> and <code>deliver_later</code> calls to jobs aren't being fired synchronously (or, in fact, at all) during my system tests, which is leading to test failures upon upgrading to Rails 6.</p>\n<h3>Steps to reproduce</h3>\n<p>Here are two tests that demonstrates the problem:</p>\n<div class=\"highlight highlight-source-ruby position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"require &quot;test_helper&quot;\n\nclass JobTest &lt; ActiveSupport::TestCase\n  class SomeJob &lt; ActiveJob::Base\n    cattr_accessor :job_ran\n\n    def perform\n      @@job_ran = true\n    end\n  end\n\n  def test_some_job\n    assert_equal :inline, Rails.application.config.active_job.queue_adapter\n    assert_equal ActiveJob::QueueAdapters::InlineAdapter, SomeJob.queue_adapter.class\n\n    SomeJob.perform_later\n\n    assert_equal true, SomeJob.job_ran\n  end\nend\n\nclass JobSystemTest &lt; ActionDispatch::SystemTestCase\n  class OtherJob &lt; ActiveJob::Base\n    cattr_accessor :job_ran\n\n    def perform\n      @@job_ran = true\n    end\n  end\n\n  def test_other_job\n    assert_equal :inline, Rails.application.config.active_job.queue_adapter\n    assert_equal ActiveJob::QueueAdapters::InlineAdapter, OtherJob.queue_adapter.class\n\n    OtherJob.perform_later\n\n    assert_equal true, OtherJob.job_ran\n  end\nend\n\"><pre><span class=\"pl-en\">require</span> <span class=\"pl-s\">\"test_helper\"</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">JobTest</span> &lt; <span class=\"pl-v\">ActiveSupport</span>::<span class=\"pl-v\">TestCase</span>\n  <span class=\"pl-k\">class</span> <span class=\"pl-v\">SomeJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n    <span class=\"pl-en\">cattr_accessor</span> <span class=\"pl-pds\">:job_ran</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span>\n      <span class=\"pl-c1\">@@job_ran</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">true</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_some_job</span>\n    <span class=\"pl-en\">assert_equal</span> <span class=\"pl-pds\">:inline</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">Rails</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">application</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">config</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">active_job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_adapter</span>\n    <span class=\"pl-en\">assert_equal</span> <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">QueueAdapters</span>::<span class=\"pl-v\">InlineAdapter</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">SomeJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_adapter</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">class</span>\n\n    <span class=\"pl-v\">SomeJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n\n    <span class=\"pl-en\">assert_equal</span> <span class=\"pl-c1\">true</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">SomeJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">job_ran</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">JobSystemTest</span> &lt; <span class=\"pl-v\">ActionDispatch</span>::<span class=\"pl-v\">SystemTestCase</span>\n  <span class=\"pl-k\">class</span> <span class=\"pl-v\">OtherJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n    <span class=\"pl-en\">cattr_accessor</span> <span class=\"pl-pds\">:job_ran</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span>\n      <span class=\"pl-c1\">@@job_ran</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">true</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_other_job</span>\n    <span class=\"pl-en\">assert_equal</span> <span class=\"pl-pds\">:inline</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">Rails</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">application</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">config</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">active_job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_adapter</span>\n    <span class=\"pl-en\">assert_equal</span> <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">QueueAdapters</span>::<span class=\"pl-v\">InlineAdapter</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">OtherJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_adapter</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">class</span>\n\n    <span class=\"pl-v\">OtherJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n\n    <span class=\"pl-en\">assert_equal</span> <span class=\"pl-c1\">true</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">OtherJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">job_ran</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3>Expected behavior</h3>\n<p>I would expect the behavior to have remained as it did under Rails 5, where the <code>active_job.queue_adapter</code> setting would be respected for all of Rails' test types.</p>\n<h3>Actual behavior</h3>\n<p>The first test, which descends from <code>ActiveSupport::TestCase</code> will pass and behave as it did under Rails 5. However, the second test, descending from from <code>ActionDispatch::SystemTestCase</code> will now fail under Rails 6, because <code>OtherJob</code>'s <code>queue_adapter</code> will have been reset by <code>ActiveJob::TestHelper</code> to be an instance of <code>TestAdapter</code></p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"JobSystemTest#test_other_job [/Users/justin/code/testdouble/present/test/lib/job_test.rb:33]:\n--- expected\n+++ actual\n@@ -1 +1 @@\n-ActiveJob::QueueAdapters::InlineAdapter\n+ActiveJob::QueueAdapters::TestAdapter\n\"><pre><code>JobSystemTest#test_other_job [/Users/justin/code/testdouble/present/test/lib/job_test.rb:33]:\n--- expected\n+++ actual\n@@ -1 +1 @@\n-ActiveJob::QueueAdapters::InlineAdapter\n+ActiveJob::QueueAdapters::TestAdapter\n</code></pre></div>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: 6.0.0 as well as <a href=\"https://github.com/rails/rails/tree/2bc6a948a2f46f8cf2d44506af1be235691c84b5\">6-0-stable</a>, as of today.</p>\n<p><strong>Ruby version</strong>: ruby 2.6.3p62 (2019-04-16 revision 67580) [x86_64-darwin18]</p>",
            "url": "https://github.com/rails/rails/issues/37270",
            "title": "Rails 6 inconsistently overrides ActiveJob queue_adapter setting with TestAdapter",
            "date_modified": "2021-10-01T18:19:42.000Z",
            "date_published": "2019-09-23T05:29:13.000Z",
            "author": {
                "name": "searls",
                "url": "https://github.com/searls"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/6344545?u=61028be60885dc53cf7b17e8170912fba3e8910c&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p><a href=\"https://github.com/rails/rails/blob/6-0-stable/activejob/lib/rails/generators/job/templates/application_job.rb.tt\">https://github.com/rails/rails/blob/6-0-stable/activejob/lib/rails/generators/job/templates/application_job.rb.tt</a>:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"# Most jobs are safe to ignore if the underlying records are no longer available\n# discard_on ActiveJob::DeserializationError\n\"><pre><span class=\"pl-c\"># Most jobs are safe to ignore if the underlying records are no longer available</span>\n<span class=\"pl-c\"># discard_on ActiveJob::DeserializationError</span></pre></div>\n<p>This error is raised for any errors during deserialization, not exclusively for AR records that are no longer available.</p>\n<p><a href=\"https://github.com/rails/rails/blob/6-0-stable/activejob/lib/active_job/arguments.rb\">https://github.com/rails/rails/blob/6-0-stable/activejob/lib/active_job/arguments.rb</a>:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"   # Deserializes a set of arguments. Intrinsic types that can safely be\n    # deserialized without mutation are returned as-is. Arrays/Hashes are\n    # deserialized element by element. All other types are deserialized using\n    # GlobalID.\n    def deserialize(arguments)\n      arguments.map { |argument| deserialize_argument(argument) }\n    rescue\n      raise DeserializationError\n    end\n\"><pre>   <span class=\"pl-c\"># Deserializes a set of arguments. Intrinsic types that can safely be</span>\n    <span class=\"pl-c\"># deserialized without mutation are returned as-is. Arrays/Hashes are</span>\n    <span class=\"pl-c\"># deserialized element by element. All other types are deserialized using</span>\n    <span class=\"pl-c\"># GlobalID.</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">deserialize</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">arguments</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-s1\">arguments</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">map</span> <span class=\"pl-kos\">{</span> |<span class=\"pl-s1\">argument</span>| <span class=\"pl-en\">deserialize_argument</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">argument</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">}</span>\n    <span class=\"pl-k\">rescue</span>\n      <span class=\"pl-en\">raise</span> <span class=\"pl-v\">DeserializationError</span>\n    <span class=\"pl-k\">end</span></pre></div>\n<p>Say the database is slow to respond and the query times out, then this would raise a <code>DeserializationError</code> error as well.</p>",
            "url": "https://github.com/rails/rails/issues/40318",
            "title": "Inaccurate comment in ApplicationJob template",
            "date_modified": "2021-10-15T16:22:21.000Z",
            "date_published": "2020-10-02T06:48:29.000Z",
            "author": {
                "name": "ce07c3",
                "url": "https://github.com/ce07c3"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/3839713?u=a0cb80715ca875a270386491197a302c0411b116&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>I took the liberty of creating a PR to address the issue <a href=\"https://github.com/rails/rails/pull/42973\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/42973/hovercard\">here</a>.</p>\n<h3>Steps to reproduce</h3>\n<ol>\n<li>Follow the instructions <a href=\"https://github.com/rails/rails-dev-box\">here</a> to set up a new instance of <code>rails-dev-box</code>, run <code>vagrant up</code> and <code>vagrant ssh</code>, etc. (not sure if this is necessary or not; you may see the same behavior I observed from your current rails-dev-box setup regardless of how fresh it is).</li>\n<li>From within your local clone of the Rails repo contained in your Vagrant VM, run <code>cd activejob &amp;&amp; bin/test</code>.</li>\n</ol>\n<h3>Expected behavior</h3>\n<p>No errors or failures should be returned.</p>\n<h3>Actual behavior</h3>\n<p>I see the following results:</p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"Error:\nQueuingTest#test_should_supply_a_provider_job_id_when_available_for_delayed_jobs:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a012607f18&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:87:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:86\n\nE\n\nError:\nQueuingTest#test_should_supply_a_wrapped_class_name_to_Sidekiq:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01261af28&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:31:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:30\n\nE\n\nError:\nQueuingTest#test_current_timezone_is_kept_while_running_perform_later:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01262e7f8&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:110:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:109\n\nS.SE\n\nError:\nQueuingTest#test_should_run_job_with_higher_priority_first:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01264b5b0&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:126:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:125\n\nE\n\nError:\nQueuingTest#test_should_run_job_with_higher_priority_first_in_Backburner:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a012663b38&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:138:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:137\n\nE\n\nError:\nQueuingTest#test_current_locale_is_kept_while_running_perform_later:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01267b3a0&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:93:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:92\n\nE\n\nError:\nQueuingTest#test_should_access_provider_job_id_inside_Sidekiq_job:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01268a968&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:41:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:40\n\nE\n\nError:\nQueuingTest#test_should_run_job_enqueued_in_the_future_at_the_specified_time:\nNameError: uninitialized constant QueuingTest::TestJob\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:71:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:70\n\nE\n\nError:\nQueuingTest#test_should_supply_a_provider_job_id_when_available_for_immediate_jobs:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01149a2d0&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:81:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:80\n\n.E\n\nError:\nQueuingTest#test_should_not_run_job_enqueued_in_the_future:\nNameError: uninitialized constant QueuingTest::TestJob\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:63:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:62\n\nE\n\nError:\nQueuingTest#test_should_run_jobs_enqueued_on_a_listening_queue:\nNameError: uninitialized constant QueuingTest::TestJob\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:11:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:10\n\n.E\n\nError:\nQueuingTest#test_should_not_run_jobs_queued_on_a_non-listening_queue:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a011146e30&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:17:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:16\n\nE\n\nError:\nQueuingTest#test_should_supply_a_wrapped_class_name_to_DelayedJob:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a0111d42f8&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:49:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:48\n\nE\n\nError:\nQueuingTest#test_resque_JobWrapper_should_have_instance_variable_queue:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a010f34a98&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:56:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:55\n\n..\n\nFinished in 0.412302s, 916.8031 runs/s, 1903.9428 assertions/s.\n378 runs, 785 assertions, 0 failures, 14 errors, 27 skips\n\"><pre><code>Error:\nQueuingTest#test_should_supply_a_provider_job_id_when_available_for_delayed_jobs:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a012607f18&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:87:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:86\n\nE\n\nError:\nQueuingTest#test_should_supply_a_wrapped_class_name_to_Sidekiq:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01261af28&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:31:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:30\n\nE\n\nError:\nQueuingTest#test_current_timezone_is_kept_while_running_perform_later:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01262e7f8&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:110:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:109\n\nS.SE\n\nError:\nQueuingTest#test_should_run_job_with_higher_priority_first:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01264b5b0&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:126:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:125\n\nE\n\nError:\nQueuingTest#test_should_run_job_with_higher_priority_first_in_Backburner:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a012663b38&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:138:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:137\n\nE\n\nError:\nQueuingTest#test_current_locale_is_kept_while_running_perform_later:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01267b3a0&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:93:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:92\n\nE\n\nError:\nQueuingTest#test_should_access_provider_job_id_inside_Sidekiq_job:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01268a968&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:41:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:40\n\nE\n\nError:\nQueuingTest#test_should_run_job_enqueued_in_the_future_at_the_specified_time:\nNameError: uninitialized constant QueuingTest::TestJob\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:71:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:70\n\nE\n\nError:\nQueuingTest#test_should_supply_a_provider_job_id_when_available_for_immediate_jobs:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a01149a2d0&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:81:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:80\n\n.E\n\nError:\nQueuingTest#test_should_not_run_job_enqueued_in_the_future:\nNameError: uninitialized constant QueuingTest::TestJob\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:63:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:62\n\nE\n\nError:\nQueuingTest#test_should_run_jobs_enqueued_on_a_listening_queue:\nNameError: uninitialized constant QueuingTest::TestJob\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:11:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:10\n\n.E\n\nError:\nQueuingTest#test_should_not_run_jobs_queued_on_a_non-listening_queue:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a011146e30&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:17:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:16\n\nE\n\nError:\nQueuingTest#test_should_supply_a_wrapped_class_name_to_DelayedJob:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a0111d42f8&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:49:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:48\n\nE\n\nError:\nQueuingTest#test_resque_JobWrapper_should_have_instance_variable_queue:\nNoMethodError: undefined method `adapter_is?' for #&lt;QueuingTest:0x000055a010f34a98&gt;\n    /vagrant/rails/activejob/test/integration/queuing_test.rb:56:in `block in &lt;class:QueuingTest&gt;'\n\n\nbin/test test/integration/queuing_test.rb:55\n\n..\n\nFinished in 0.412302s, 916.8031 runs/s, 1903.9428 assertions/s.\n378 runs, 785 assertions, 0 failures, 14 errors, 27 skips\n</code></pre></div>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>:</p>\n<p>From the <code>Tags</code> list in my fork of the <code>Rails</code> repo:</p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"v6.1.4 release\n on Jun 24  8321702  zip  tar.gz\n\"><pre><code>v6.1.4 release\n on Jun 24  8321702  zip  tar.gz\n</code></pre></div>\n<p><strong>Ruby version</strong>:<br>\nVersion on my machine- ruby 2.3.3p222 (2016-11-21 revision 56859) [x86_64-darwin19]<br>\nVersion inside Vagrant- ruby 2.7.2p137 (2020-10-01 revision 5445e04352) [x86_64-linux-gnu]</p>",
            "url": "https://github.com/rails/rails/issues/42974",
            "title": "Errors in ActiveJob test suite after a clean install of rails-dev-box - \"undefined method 'adapter_is?' for #<QueuingTest...\"",
            "date_modified": "2021-08-14T20:08:12.000Z",
            "date_published": "2021-08-08T23:43:38.000Z",
            "author": {
                "name": "richiethomas",
                "url": "https://github.com/richiethomas"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/6321?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>On the <a href=\"https://petition.parliament.uk\" rel=\"nofollow\">UK Parliament and Government petitions website</a> we're queuing up emails to be sent using a background job and <code>deliver_later</code> so that the email sending is not limited to one worker thread. Essentially the code looks somewhat like this:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"class EmailSignees &lt; ActiveJob::Base\n  def perform(petition)\n    petition.signatures.find_each do |signature|\n      PetitionMailer.notify_signee_of_response(petition, signature),deliver_later\n    end\n  end\nend\n\"><pre><span class=\"pl-k\">class</span> <span class=\"pl-v\">EmailSignees</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">petition</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-s1\">petition</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">signatures</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">find_each</span> <span class=\"pl-k\">do</span> |<span class=\"pl-s1\">signature</span>|\n      <span class=\"pl-v\">PetitionMailer</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">notify_signee_of_response</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">petition</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">signature</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span><span class=\"pl-en\">deliver_later</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p>The problem is that even though we are using <code>find_each</code>, because Active Job uses a single log subscriber for both <code>enqueue</code> and <code>perform</code> events the <code>deliver_later</code> call gets treated as a child event of the <code>perform</code>event so eventually we end up with 100,000+ objects in the event object even though we're using <code>find_each</code>. This obviously causes the worker to eventually crash due to a lack of memory.</p>\n<p>The questions are:</p>\n<ol>\n<li>is this behaviour intentional?</li>\n<li>do we want to keep this behaviour, given the above scenario?</li>\n<li>if it is intentional and we want to keep it, what's the solution?</li>\n</ol>\n<p>For question 3 there are multiple ways of working round it I can think of, just wondering what our recommendation would be.</p>",
            "url": "https://github.com/rails/rails/issues/21036",
            "title": "Enqueuing jobs inside a job can lead to memory bloat",
            "date_modified": "2016-03-11T18:46:47.000Z",
            "date_published": "2015-07-27T07:20:45.000Z",
            "author": {
                "name": "pixeltrix",
                "url": "https://github.com/pixeltrix"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/2741?u=387c085565dc648f11d835558ad1b6d524ddc91d&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>This is a common source of job errors:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"class Project &lt; ApplicationRecord\n  after_create -&gt; { NotifyProjectParticipants.perform_later self }\nend\n\nclass NotifyProjectParticipants &lt; ApplicationJob\n  def perform(project)\n    # This will explode with a ActiveJob::DeserializationError,\n    #  if the job runs before the INSERT transaction for the new project completes.\n  end\nend\n\"><pre><span class=\"pl-k\">class</span> <span class=\"pl-v\">Project</span> &lt; <span class=\"pl-v\">ApplicationRecord</span>\n  <span class=\"pl-en\">after_create</span> <span class=\"pl-c1\">-&gt;</span> <span class=\"pl-kos\">{</span> <span class=\"pl-v\">NotifyProjectParticipants</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span> <span class=\"pl-smi\">self</span> <span class=\"pl-kos\">}</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">NotifyProjectParticipants</span> &lt; <span class=\"pl-v\">ApplicationJob</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">project</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-c\"># This will explode with a ActiveJob::DeserializationError,</span>\n    <span class=\"pl-c\">#  if the job runs before the INSERT transaction for the new project completes.</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p>It's insidious too. Because it'll often work in development, then fail in production, when your job queue is really fast, and your database might be bogged down.</p>\n<p>The proper way is of course:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"class Project &lt; ApplicationRecord\n  after_create_commit -&gt; { NotifyProjectParticipants.perform_later self }\nend\n\"><pre><span class=\"pl-k\">class</span> <span class=\"pl-v\">Project</span> &lt; <span class=\"pl-v\">ApplicationRecord</span>\n  <span class=\"pl-en\">after_create_commit</span> <span class=\"pl-c1\">-&gt;</span> <span class=\"pl-kos\">{</span> <span class=\"pl-v\">NotifyProjectParticipants</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span> <span class=\"pl-smi\">self</span> <span class=\"pl-kos\">}</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p>But that's easy to forget. So I suggest that we create a new default that disallow jobs from being scheduled within transactions. You should be able to turn that off, but it would be a better default, since it would catch this class for errors for more people before they deploy to production.</p>",
            "url": "https://github.com/rails/rails/issues/26045",
            "title": "Prevent jobs from being scheduled within transactions",
            "date_modified": "2021-03-09T23:05:04.000Z",
            "date_published": "2016-08-03T17:21:16.000Z",
            "author": {
                "name": "dhh",
                "url": "https://github.com/dhh"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/46325145?u=c65fb69f50b9f9eea2f9eb61b0693266e136f56d&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>I'm currently having an issue when trying to upload and subsequently retrieve an image linked to a record. I'm manually assigning the image to the entity as in <code>@entity.main_image = params[:main_image]</code> being <code>main_image</code> the value of a file field. Later even after the browser successfully redirected me to the success page I get the following error in the console</p>\n<p><code>[ActiveJob] [ActiveStorage::AnalyzeJob] [dd84c5a8-7a93-4f08-9198-b5236bf2ae66] Error performing ActiveStorage::AnalyzeJob (Job ID: dd84c5a8-7a93-4f08-9198-b5236bf2ae66) from Async(default) in 5.39ms: ActiveStorage::FileNotFoundError (ActiveStorage::FileNotFoundError): </code></p>\n<p>As a testing stance I created a dummy app and used the same set up and gem versions but everything ran smoothly then.</p>\n<h3>Steps to reproduce</h3>\n<ul>\n<li>Integrate Activerecord normally</li>\n<li>Upload an image</li>\n<li>Assign image manually</li>\n</ul>\n<h3>Expected behavior</h3>\n<ul>\n<li>AnalyzeJob should finish correctly and Image should be retrievable</li>\n</ul>\n<h3>Actual behavior</h3>\n<ul>\n<li>AnnalyzeJob fails with FileNotFoundError and Image is not retrievable</li>\n</ul>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>:  6.0.22</p>\n<p><strong>Ruby version</strong>: 2.6.5</p>",
            "url": "https://github.com/rails/rails/issues/42003",
            "title": "Active Storage: FileNotFoundError on AnalyzeJob and resulting/being cause of  missing image",
            "date_modified": "2021-10-05T14:09:48.000Z",
            "date_published": "2021-04-16T19:25:56.000Z",
            "author": {
                "name": "sebastian-echeverria-lenio",
                "url": "https://github.com/sebastian-echeverria-lenio"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/474554?u=a02b1be665c890745d65404f43e4e86ea929ec34&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<div class=\"highlight highlight-source-ruby position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"ActiveJob::Base.queue_adapter = :async\n\nclass MyJob &lt; ActiveJob::Base\n  queue_as :default\n\n  def perform\n    puts queue_name\n  end\nend\n\"><pre><span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_adapter</span> <span class=\"pl-c1\">=</span> <span class=\"pl-pds\">:async</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">MyJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-en\">queue_as</span> <span class=\"pl-pds\">:default</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span>\n    <span class=\"pl-en\">puts</span> <span class=\"pl-en\">queue_name</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p>When using <code>set().perform_now</code>, the options passed to <code>set</code> are not retrievable in the job instance:</p>\n<div class=\"highlight highlight-source-ruby position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"&gt; MyJob.set(queue: :another_queue).perform_now\nPerforming MyJob (...) from Async(default) enqueued at\ndefault\nPerformed MyJob (...) from Async(default) in 0.29ms\n\"><pre>&gt; <span class=\"pl-v\">MyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">queue</span>: <span class=\"pl-pds\">:another_queue</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_now</span>\n<span class=\"pl-v\">Performing</span> <span class=\"pl-v\">MyJob</span> <span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">default</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">enqueued</span> <span class=\"pl-en\">at</span>\n<span class=\"pl-en\">default</span>\n<span class=\"pl-v\">Performed</span> <span class=\"pl-v\">MyJob</span> <span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">default</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">in</span> <span class=\"pl-c1\">0.29</span><span class=\"pl-kos\"></span><span class=\"pl-en\">ms</span></pre></div>\n<h3>Expected behavior</h3>\n<p>The behavior is expected to be the same when using <code>perform_now</code> or <code>perform_later</code> on a configured job.</p>\n<div class=\"highlight highlight-source-ruby position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"&gt; MyJob.set(queue: :another_queue).perform_later\nEnqueued MyJob (...) to Async(another_queue)\nPerforming MyJob (...) from Async(another_queue) enqueued at 2021-10-05...\nanother_queue\nPerformed MyJob (...) from Async(another_queue) in 0.26ms\n\n&gt; MyJob.set(queue: :another_queue).perform_now\nPerforming MyJob (...) from Async(another_queue) enqueued at\nanother_queue\nPerformed MyJob (...) from Async(another_queue) in 0.29ms\n\"><pre>&gt; <span class=\"pl-v\">MyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">queue</span>: <span class=\"pl-pds\">:another_queue</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n<span class=\"pl-v\">Enqueued</span> <span class=\"pl-v\">MyJob</span> <span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span> <span class=\"pl-en\">to</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">another_queue</span><span class=\"pl-kos\">)</span>\n<span class=\"pl-v\">Performing</span> <span class=\"pl-v\">MyJob</span> <span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">another_queue</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">enqueued</span> <span class=\"pl-en\">at</span> <span class=\"pl-c1\">2021</span>-<span class=\"pl-c1\">10</span>-<span class=\"pl-c1\">05</span>...\n<span class=\"pl-en\">another_queue</span>\n<span class=\"pl-v\">Performed</span> <span class=\"pl-v\">MyJob</span> <span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">another_queue</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">in</span> <span class=\"pl-c1\">0.26</span><span class=\"pl-kos\"></span><span class=\"pl-en\">ms</span>\n\n&gt; <span class=\"pl-v\">MyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">queue</span>: <span class=\"pl-pds\">:another_queue</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_now</span>\n<span class=\"pl-v\">Performing</span> <span class=\"pl-v\">MyJob</span> <span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">another_queue</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">enqueued</span> <span class=\"pl-en\">at</span>\n<span class=\"pl-en\">another_queue</span>\n<span class=\"pl-v\">Performed</span> <span class=\"pl-v\">MyJob</span> <span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">another_queue</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">in</span> <span class=\"pl-c1\">0.29</span><span class=\"pl-kos\"></span><span class=\"pl-en\">ms</span></pre></div>\n<p>It might seem useless because the job is performed synchronously, but it's not when building complex jobs flows, which is mixing <code>perform_now</code> and<code> perform_later</code> methods, in the same given queue.</p>\n<div class=\"highlight highlight-source-ruby position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"class MyJob &lt; ActiveJob::Base\n  queue_as :default\n\n  def perform\n    if something_is_not_ready?\n      MyJob.set(queue: queue_name, wait: 1.minute).perform_later\n    else\n      ...\n      MyOtherJob.set(queue: queue_name).perform_now\n    end\n  end\nend\n\"><pre><span class=\"pl-k\">class</span> <span class=\"pl-v\">MyJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-en\">queue_as</span> <span class=\"pl-pds\">:default</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span>\n    <span class=\"pl-k\">if</span> <span class=\"pl-en\">something_is_not_ready?</span>\n      <span class=\"pl-v\">MyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">queue</span>: <span class=\"pl-en\">queue_name</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">wait</span>: <span class=\"pl-c1\">1</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">minute</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n    <span class=\"pl-k\">else</span>\n      ...\n      <span class=\"pl-v\">MyOtherJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">queue</span>: <span class=\"pl-en\">queue_name</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_now</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3>System configuration</h3>\n<p>Rails 6.1.4.1<br>\nAlso reproductible in master</p>\n<h3>Solution proposal</h3>\n<p>I'll propose the following suggestion in a coming PR :</p>\n<div class=\"highlight highlight-source-ruby position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"module ActiveJob\n  class ConfiguredJob\n    ...\n\n    def perform_now(...)\n      instantiate(...).perform_now\n    end\n\n    def perform_later(...)\n      instantiate(...).enqueue\n    end\n\n    private\n\n    def instantiate(...)\n      job = @job_class.new(...)\n      self.class.configure(job, @options)\n    end\n\n    def self.configure(job, options = {})\n      job.scheduled_at = options[:wait].seconds.from_now.to_f if options[:wait]\n      job.scheduled_at = options[:wait_until].to_f if options[:wait_until]\n      job.queue_name   = self.class.queue_name_from_part(options[:queue]) if options[:queue]\n      job.priority     = options[:priority].to_i if options[:priority]\n      job      \n    end\n  end\n\n  module Enqueuing\n    def enqueue(options = {})\n      ActiveJob::ConfiguredJob.configure(self, options)\n      ...\n    end\n  end\nend\n\"><pre><span class=\"pl-k\">module</span> <span class=\"pl-v\">ActiveJob</span>\n  <span class=\"pl-k\">class</span> <span class=\"pl-v\">ConfiguredJob</span>\n    <span class=\"pl-kos\">.</span>..\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform_now</span><span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span>\n      <span class=\"pl-en\">instantiate</span><span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_now</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform_later</span><span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span>\n      <span class=\"pl-en\">instantiate</span><span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">enqueue</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-k\">private</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">instantiate</span><span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span>\n      <span class=\"pl-en\">job</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">@job_class</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span>...<span class=\"pl-kos\">)</span>\n      <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">class</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">configure</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">job</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">@options</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">configure</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">job</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">options</span> <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">{</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-s1\">job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">scheduled_at</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:wait</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">seconds</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">from_now</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">to_f</span> <span class=\"pl-k\">if</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:wait</span><span class=\"pl-kos\">]</span>\n      <span class=\"pl-s1\">job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">scheduled_at</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:wait_until</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">to_f</span> <span class=\"pl-k\">if</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:wait_until</span><span class=\"pl-kos\">]</span>\n      <span class=\"pl-s1\">job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_name</span>   <span class=\"pl-c1\">=</span> <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">class</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_name_from_part</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:queue</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">if</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:queue</span><span class=\"pl-kos\">]</span>\n      <span class=\"pl-s1\">job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">priority</span>     <span class=\"pl-c1\">=</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:priority</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">to_i</span> <span class=\"pl-k\">if</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:priority</span><span class=\"pl-kos\">]</span>\n      <span class=\"pl-s1\">job</span>      \n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">module</span> <span class=\"pl-v\">Enqueuing</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">enqueue</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">options</span> <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">{</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">ConfiguredJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">configure</span><span class=\"pl-kos\">(</span><span class=\"pl-smi\">self</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">)</span>\n      ...\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>",
            "url": "https://github.com/rails/rails/issues/43376",
            "title": "ActiveJob::Base.set doesn't configure jobs when using perform_now",
            "date_modified": "2021-10-12T21:16:10.000Z",
            "date_published": "2021-10-05T09:20:51.000Z",
            "author": {
                "name": "inkstak",
                "url": "https://github.com/inkstak"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/3263575?u=92ee5d4a6a643b31856ac542ba409309c5389493&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>I am trying to handle the case where the last step of a direct upload fails (the <code>PATCH</code> call to my model), and I have noticed an odd behaviour. Here goes:</p>\n<h3>Steps to reproduce</h3>\n<ul>\n<li>Set up the <code>Profile</code> model with <code>has_one_attached :document</code>.</li>\n<li>Create an instance of <code>Profile</code> (referred to as <code>profile</code>)</li>\n<li>Use a direct upload form to attach a document to <code>profile</code> (controller and view code below)</li>\n<li>Everything works fine so far, I can see the image and its filename.</li>\n<li>Force a failure in the <code>PATCH</code> call to <code>/profile/document</code>: intentionally modify a validation in the Profile model so that any call to Profile#update fails</li>\n<li>Upload another document for the same Profile, and watch the <code>PATCH</code> fail.</li>\n</ul>\n<h3>Expected behavior</h3>\n<p>When this last step fails, I'd expect the whole state of my app to go back to its state from before the beginning of the upload process (the <code>POST</code> call to <code>rails/active_storage/direct_uploads</code>).</p>\n<p>I'd also expect the former file to still be there on the storage, and the new one to not be there.</p>\n<h3>Actual behavior</h3>\n<p>The Attachment record for my Profile is still the same, but the original Blob was destroyed, and replaced by a new one (created by the first <code>POST</code> to <code>rails/active_storage/direct_uploads</code>). The Attachment points to the destroyed Blob.</p>\n<p><code>profile.document.attached?</code> returns <code>true</code>, but other methods, e.g. <code>filename</code> or <code>service_url</code> are undefined. This breaks my views: the if passes, the statements inside break.</p>\n<p>S3/Disk contains the new file, and does not contain the former one.</p>\n<p>The logs tell me that the first call from the client to <code>/rails/active_storage/direct_uploads</code> creates a Blob. Then, after the upload to S3 is done, the <code>PATCH</code> call to <code>/profile/document</code> destroys the former Attachment and creates a new one, but this is all rolled back when my validation fails. However, it also enqueues a job that purges the former Blob, instead of purging the newly created one.</p>\n<p>From my understanding, what this job does should depend upon the success of the <code>PATCH</code> call. Is this an actual bug, or am I supposed to handle this manually? Or maybe there's just another way to write things and make it work automagically?</p>\n<p>One workaround I found is to call purge or detach on the document when the update fails. From a user's point of view it removes the former document, which isn't so nice, but at least my views don't break. The Attachment is destroyed, the Blob remains, the former file is destroyed, the new one is stored. This fix is commented out in the code sample.</p>\n<h3>System configuration</h3>\n<p>I get the bug on my local environment, both with S3 and Disk as targets.</p>\n<p><strong>Rails version</strong>:<br>\nRails 5.2.0.rc1</p>\n<p><strong>Ruby version</strong>:<br>\nruby 2.5.0p0 (2017-12-25 revision 61468) [x86_64-darwin17]</p>\n<h3>Code samples</h3>\n<p>Adapted for better readability.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"class ProfilesController &lt; ApplicationController\n  def update\n    if current_user.profile.update(document_params)\n      flash[:notice] = &quot;Your document was successfully uploaded&quot;\n    else\n      # current_profile.reload.identity_document.purge # The fix\n      flash[:alert] = &quot;Something went wrong.&quot;\n    end\n    redirect_to my_form_url\n  end\n\n  private\n\n  def document_params\n    params.require(:profile).permit(:document)\n  end\nend\n\"><pre><code>class ProfilesController &lt; ApplicationController\n  def update\n    if current_user.profile.update(document_params)\n      flash[:notice] = \"Your document was successfully uploaded\"\n    else\n      # current_profile.reload.identity_document.purge # The fix\n      flash[:alert] = \"Something went wrong.\"\n    end\n    redirect_to my_form_url\n  end\n\n  private\n\n  def document_params\n    params.require(:profile).permit(:document)\n  end\nend\n</code></pre></div>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"&lt;% if @profile.document.attached? %&gt;\n    &lt;%= @profile.document.filename %&gt;\n    &lt;%= image_tag @profile.document %&gt;\n&lt;% else %&gt;\n    No document yet\n&lt;% end %&gt;\n\n&lt;%= form_for @profile do |f| %&gt;\n    &lt;%= f.file_field :document, direct_upload: true %&gt;\n    &lt;%= f.submit %&gt;\n&lt;% end %&gt;\n\"><pre><code>&lt;% if @profile.document.attached? %&gt;\n    &lt;%= @profile.document.filename %&gt;\n    &lt;%= image_tag @profile.document %&gt;\n&lt;% else %&gt;\n    No document yet\n&lt;% end %&gt;\n\n&lt;%= form_for @profile do |f| %&gt;\n    &lt;%= f.file_field :document, direct_upload: true %&gt;\n    &lt;%= f.submit %&gt;\n&lt;% end %&gt;\n</code></pre></div>\n<p>Thanks in advance for your help!</p>",
            "url": "https://github.com/rails/rails/issues/31985",
            "title": "ActiveStorage: invalid Attachment when last step of direct upload fails",
            "date_modified": "2021-02-03T21:45:07.000Z",
            "date_published": "2018-02-13T17:56:05.000Z",
            "author": {
                "name": "SimonFrr",
                "url": "https://github.com/SimonFrr"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/58794487?u=05c4631c63c592c91ed47388ea1f261ca4aea578&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<ul>\n<li>any app, or <a href=\"https://github.com/dorianmariefr/bank\">https://github.com/dorianmariefr/bank</a> for instance</li>\n<li>enqueing <code>Class.new</code> as a parameter of a job</li>\n</ul>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"irb(main):002:0&gt; TestingSerializationJob.perform_later Class.new\nEnqueued TestingSerializationJob (Job ID: 1ebda54a-7875-4599-b0d7-b7be9bf4b0d6) to Async(default) with arguments: #&lt;Class:0x00007f8306725b60&gt;\n=&gt; \n#&lt;TestingSerializationJob:0x00007f8306725660\n @arguments=[#&lt;Class:0x00007f8306725b60&gt;],\n @exception_executions={},\n @executions=0,\n @job_id=&quot;1ebda54a-7875-4599-b0d7-b7be9bf4b0d6&quot;,\n @priority=nil,\n @provider_job_id=&quot;2fa47f8c-0e21-4298-a506-a4b516eac087&quot;,\n @queue_name=&quot;default&quot;,\n @successfully_enqueued=true,\n @timezone=&quot;UTC&quot;&gt;\nirb(main):003:0&gt; Error performing TestingSerializationJob (Job ID: 1ebda54a-7875-4599-b0d7-b7be9bf4b0d6) from Async(default) in 1.94ms: ActiveJob::DeserializationError (Error while trying to deserialize arguments: undefined method `constantize' for nil:NilClass):\n/Users/dorianmariefr/.rvm/gems/ruby-3.0.2/bundler/gems/rails-014347620db4/activejob/lib/active_job/serializers/module_serializer.rb:11:in `deserialize'\n\"><pre><span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:002</span><span class=\"pl-pds\">:0</span>&gt; <span class=\"pl-v\">TestingSerializationJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span> <span class=\"pl-v\">Class</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span>\n<span class=\"pl-en\">Enqueued</span> <span class=\"pl-en\">TestingSerializationJob</span> <span class=\"pl-kos\">(</span><span class=\"pl-en\">Job</span> <span class=\"pl-pds\">ID</span>: <span class=\"pl-c1\">1</span><span class=\"pl-en\">ebda54a</span>-<span class=\"pl-c1\">7875</span>-<span class=\"pl-c1\">4599</span>-<span class=\"pl-en\">b0d7</span>-<span class=\"pl-en\">b7be9bf4b0d6</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">to</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">default</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">with</span> <span class=\"pl-pds\">arguments</span>: <span class=\"pl-c\">#&lt;Class:0x00007f8306725b60&gt;</span>\n<span class=\"pl-c1\">=&gt;</span> \n<span class=\"pl-c\">#&lt;TestingSerializationJob:0x00007f8306725660</span>\n <span class=\"pl-c1\">@arguments</span><span class=\"pl-c1\">=</span><span class=\"pl-kos\">[</span><span class=\"pl-c\">#&lt;Class:0x00007f8306725b60&gt;],</span>\n <span class=\"pl-c1\">@exception_executions</span><span class=\"pl-c1\">=</span><span class=\"pl-kos\">{</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span>\n <span class=\"pl-c1\">@executions</span><span class=\"pl-c1\">=</span><span class=\"pl-c1\">0</span><span class=\"pl-kos\">,</span>\n <span class=\"pl-c1\">@job_id</span><span class=\"pl-c1\">=</span><span class=\"pl-s\">\"1ebda54a-7875-4599-b0d7-b7be9bf4b0d6\"</span><span class=\"pl-kos\">,</span>\n <span class=\"pl-c1\">@priority</span><span class=\"pl-c1\">=</span><span class=\"pl-c1\">nil</span><span class=\"pl-kos\">,</span>\n <span class=\"pl-c1\">@provider_job_id</span><span class=\"pl-c1\">=</span><span class=\"pl-s\">\"2fa47f8c-0e21-4298-a506-a4b516eac087\"</span><span class=\"pl-kos\">,</span>\n <span class=\"pl-c1\">@queue_name</span><span class=\"pl-c1\">=</span><span class=\"pl-s\">\"default\"</span><span class=\"pl-kos\">,</span>\n <span class=\"pl-c1\">@successfully_enqueued</span><span class=\"pl-c1\">=</span><span class=\"pl-c1\">true</span><span class=\"pl-kos\">,</span>\n <span class=\"pl-c1\">@timezone</span><span class=\"pl-c1\">=</span><span class=\"pl-s\">\"UTC\"</span>&gt;\n<span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:003</span><span class=\"pl-pds\">:0</span>&gt; <span class=\"pl-v\">Error</span> <span class=\"pl-en\">performing</span> <span class=\"pl-v\">TestingSerializationJob</span> <span class=\"pl-kos\">(</span><span class=\"pl-en\">Job</span> <span class=\"pl-pds\">ID</span>: <span class=\"pl-c1\">1</span><span class=\"pl-en\">ebda54a</span>-<span class=\"pl-c1\">7875</span>-<span class=\"pl-c1\">4599</span>-<span class=\"pl-en\">b0d7</span>-<span class=\"pl-en\">b7be9bf4b0d6</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Async</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">default</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">in</span> <span class=\"pl-c1\">1.94</span><span class=\"pl-pds\">ms</span>: <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">DeserializationError</span> <span class=\"pl-kos\">(</span><span class=\"pl-v\">Error</span> <span class=\"pl-k\">while</span> <span class=\"pl-en\">trying</span> <span class=\"pl-en\">to</span> <span class=\"pl-en\">deserialize</span> <span class=\"pl-pds\">arguments</span>: <span class=\"pl-en\">undefined</span> <span class=\"pl-en\">method</span> `<span class=\"pl-en\">constantize</span><span class=\"pl-s\">' for nil:NilClass):</span>\n<span class=\"pl-s\">/Users/dorianmariefr/.rvm/gems/ruby-3.0.2/bundler/gems/rails-014347620db4/activejob/lib/active_job/serializers/module_serializer.rb:11:in `deserialize'</span></pre></div>\n<h3>Expected behavior</h3>\n<ul>\n<li>says that a class name is required</li>\n<li>or decodes the class without a name</li>\n</ul>\n<h3>Actual behavior</h3>\n<ul>\n<li>raises an obscure error</li>\n</ul>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: Rails 7.0.0.alpha2<br>\n<strong>Ruby version</strong>: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-darwin20]</p>\n<hr>\n<p>The faulty code in question:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"# frozen_string_literal: true\n\nmodule ActiveJob\n  module Serializers\n    class ModuleSerializer &lt; ObjectSerializer # :nodoc:\n      def serialize(constant)\n        super(&quot;value&quot; =&gt; constant.name)\n      end\n\n      def deserialize(hash)\n        hash[&quot;value&quot;].constantize # HERE hash[&quot;value&quot;] is nil\n      end\n\n      private\n        def klass\n          Module\n        end\n    end\n  end\nend\n\"><pre><span class=\"pl-c\"># frozen_string_literal: true</span>\n\n<span class=\"pl-k\">module</span> <span class=\"pl-v\">ActiveJob</span>\n  <span class=\"pl-k\">module</span> <span class=\"pl-v\">Serializers</span>\n    <span class=\"pl-k\">class</span> <span class=\"pl-v\">ModuleSerializer</span> &lt; <span class=\"pl-v\">ObjectSerializer</span> <span class=\"pl-c\"># :nodoc:</span>\n      <span class=\"pl-k\">def</span> <span class=\"pl-en\">serialize</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">constant</span><span class=\"pl-kos\">)</span>\n        <span class=\"pl-smi\">super</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"value\"</span> <span class=\"pl-c1\">=&gt;</span> <span class=\"pl-s1\">constant</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">name</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-k\">end</span>\n\n      <span class=\"pl-k\">def</span> <span class=\"pl-en\">deserialize</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">hash</span><span class=\"pl-kos\">)</span>\n        <span class=\"pl-s1\">hash</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"value\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">constantize</span> <span class=\"pl-c\"># HERE hash[\"value\"] is nil</span>\n      <span class=\"pl-k\">end</span>\n\n      <span class=\"pl-k\">private</span>\n        <span class=\"pl-k\">def</span> <span class=\"pl-en\">klass</span>\n          <span class=\"pl-v\">Module</span>\n        <span class=\"pl-k\">end</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>",
            "url": "https://github.com/rails/rails/issues/43306",
            "title": "Enqueuing Class.new raises an obscure error",
            "date_modified": "2021-10-14T15:06:13.000Z",
            "date_published": "2021-09-25T10:42:39.000Z",
            "author": {
                "name": "dorianmariefr",
                "url": "https://github.com/dorianmariefr"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/619324?u=d70bb67108fff36394d8534f91610daf31ea17fe&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<ol>\n<li>\n<p>Generate a new application:</p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"rails new AsyncDestroyTestApp --skip-action-mailer --skip-action-mailbox --skip-action-text --skip-active-storage --skip-action-cable --skip-sprockets --skip-spring --skip-listen --skip-javascript --skip-turbolinks --skip-jbuilder --skip-test --skip-system-test --skip-bootsnap\n\"><pre><code>rails new AsyncDestroyTestApp --skip-action-mailer --skip-action-mailbox --skip-action-text --skip-active-storage --skip-action-cable --skip-sprockets --skip-spring --skip-listen --skip-javascript --skip-turbolinks --skip-jbuilder --skip-test --skip-system-test --skip-bootsnap\n</code></pre></div>\n</li>\n<li>\n<p>Apply the following diff (add models):</p>\n<div class=\"highlight highlight-source-diff position-relative\" data-snippet-clipboard-copy-content=\"diff --git a/app/models/book.rb b/app/models/book.rb\nnew file mode 100644\nindex 0000000..f1e2a65\n--- /dev/null\n+++ b/app/models/book.rb\n@@ -0,0 +1,3 @@\n+class Book &lt; ApplicationRecord\n+  has_many :tags, dependent: :destroy_async\n+end\ndiff --git a/app/models/tag.rb b/app/models/tag.rb\nnew file mode 100644\nindex 0000000..7b23605\n--- /dev/null\n+++ b/app/models/tag.rb\n@@ -0,0 +1,2 @@\n+class Tag &lt; ApplicationRecord\n+end\ndiff --git a/db/migrate/20210609112034_add_books_and_tags.rb b/db/migrate/20210609112034_add_books_and_tags.rb\nnew file mode 100644\nindex 0000000..baed2c0\n--- /dev/null\n+++ b/db/migrate/20210609112034_add_books_and_tags.rb\n@@ -0,0 +1,8 @@\n+class AddBooksAndTags &lt; ActiveRecord::Migration[6.1]\n+  def change\n+    create_table :books\n+    create_table :tags do |t|\n+      t.references :book, foreign_key: true, null: true\n+    end\n+  end\n+end\ndiff --git a/db/schema.rb b/db/schema.rb\nnew file mode 100644\nindex 0000000..fca4c69\n--- /dev/null\n+++ b/db/schema.rb\n@@ -0,0 +1,24 @@\n+# This file is auto-generated from the current state of the database. Instead\n+# of editing this file, please use the migrations feature of Active Record to\n+# incrementally modify your database, and then regenerate this schema definition.\n+#\n+# This file is the source Rails uses to define your schema when running `bin/rails\n+# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to\n+# be faster and is potentially less error prone than running all of your\n+# migrations from scratch. Old migrations may fail to apply correctly if those\n+# migrations use external dependencies or application code.\n+#\n+# It's strongly recommended that you check this file into your version control system.\n+\n+ActiveRecord::Schema.define(version: 2021_06_09_112034) do\n+\n+  create_table &quot;books&quot;, force: :cascade do |t|\n+  end\n+\n+  create_table &quot;tags&quot;, force: :cascade do |t|\n+    t.integer &quot;book_id&quot;\n+    t.index [&quot;book_id&quot;], name: &quot;index_tags_on_book_id&quot;\n+  end\n+\n+  add_foreign_key &quot;tags&quot;, &quot;books&quot;\n+end\n\"><pre><span class=\"pl-c1\">diff --git a/app/models/book.rb b/app/models/book.rb</span>\nnew file mode 100644\nindex 0000000..f1e2a65\n<span class=\"pl-md\">--- /dev/null</span>\n<span class=\"pl-mi1\">+++ b/app/models/book.rb</span>\n<span class=\"pl-mdr\">@@ -0,0 +1,3 @@</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>class Book &lt; ApplicationRecord</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  has_many :tags, dependent: :destroy_async</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>end</span>\n<span class=\"pl-c1\">diff --git a/app/models/tag.rb b/app/models/tag.rb</span>\nnew file mode 100644\nindex 0000000..7b23605\n<span class=\"pl-md\">--- /dev/null</span>\n<span class=\"pl-mi1\">+++ b/app/models/tag.rb</span>\n<span class=\"pl-mdr\">@@ -0,0 +1,2 @@</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>class Tag &lt; ApplicationRecord</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>end</span>\n<span class=\"pl-c1\">diff --git a/db/migrate/20210609112034_add_books_and_tags.rb b/db/migrate/20210609112034_add_books_and_tags.rb</span>\nnew file mode 100644\nindex 0000000..baed2c0\n<span class=\"pl-md\">--- /dev/null</span>\n<span class=\"pl-mi1\">+++ b/db/migrate/20210609112034_add_books_and_tags.rb</span>\n<span class=\"pl-mdr\">@@ -0,0 +1,8 @@</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>class AddBooksAndTags &lt; ActiveRecord::Migration[6.1]</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  def change</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    create_table :books</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    create_table :tags do |t|</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>      t.references :book, foreign_key: true, null: true</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    end</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  end</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>end</span>\n<span class=\"pl-c1\">diff --git a/db/schema.rb b/db/schema.rb</span>\nnew file mode 100644\nindex 0000000..fca4c69\n<span class=\"pl-md\">--- /dev/null</span>\n<span class=\"pl-mi1\">+++ b/db/schema.rb</span>\n<span class=\"pl-mdr\">@@ -0,0 +1,24 @@</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># This file is auto-generated from the current state of the database. Instead</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># of editing this file, please use the migrations feature of Active Record to</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># incrementally modify your database, and then regenerate this schema definition.</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>#</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># This file is the source Rails uses to define your schema when running `bin/rails</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># be faster and is potentially less error prone than running all of your</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># migrations from scratch. Old migrations may fail to apply correctly if those</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># migrations use external dependencies or application code.</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>#</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span># It's strongly recommended that you check this file into your version control system.</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>ActiveRecord::Schema.define(version: 2021_06_09_112034) do</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  create_table \"books\", force: :cascade do |t|</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  end</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  create_table \"tags\", force: :cascade do |t|</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    t.integer \"book_id\"</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    t.index [\"book_id\"], name: \"index_tags_on_book_id\"</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  end</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  add_foreign_key \"tags\", \"books\"</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>end</span></pre></div>\n</li>\n</ol>\n<h3>Expected behavior</h3>\n<p>Consistent behavior when removing records asynchronously via passing a new list to the <code>has_many</code> association (replacing). When you delete an object using <code>parent.has_many_attr.first.destroy!</code>, Active Record will update the child's foreign key to <code>nil</code> and schedule a job to delete an associated record from the database. However, when you will replace the \"has many\" association and delete the child (using <code>parent.update!(has_many_attr: [])</code>) it will only update the foreign key. It won't actually cleanup them from the database:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"irb(main):001:0&gt; book = Book.create!(tags: [Tag.new, Tag.new])\n   (2.4ms)  SELECT sqlite_version(*)\n  TRANSACTION (0.1ms)  begin transaction\n  Book Create (1.4ms)  INSERT INTO &quot;books&quot; DEFAULT VALUES\n  Tag Create (1.2ms)  INSERT INTO &quot;tags&quot; (&quot;book_id&quot;) VALUES (?)  [[&quot;book_id&quot;, 1]]\n  Tag Create (0.2ms)  INSERT INTO &quot;tags&quot; (&quot;book_id&quot;) VALUES (?)  [[&quot;book_id&quot;, 1]]\n  TRANSACTION (2.1ms)  commit transaction\n=&gt; #&lt;Book:0x00007fcfa24c0c60 id: 1&gt;\nirb(main):002:0&gt; Tag.all\n  Tag Load (0.3ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot;\n=&gt; [#&lt;Tag:0x00007fcfa258a420 id: 1, book_id: 1&gt;, #&lt;Tag:0x00007fcfa258a2b8 id: 2, book_id: 1&gt;]\nirb(main):003:0&gt; book.tags.last.destroy!\n  TRANSACTION (0.1ms)  begin transaction\n  Tag Destroy (0.8ms)  DELETE FROM &quot;tags&quot; WHERE &quot;tags&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 2]]\n  TRANSACTION (1.5ms)  commit transaction\n=&gt; #&lt;Tag:0x00007fcfa24c31b8 id: 2, book_id: 1&gt;\nirb(main):004:0&gt; Tag.all\n  Tag Load (0.2ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot;\n=&gt; [#&lt;Tag:0x00007fcfa26c37b0 id: 1, book_id: 1&gt;]\nirb(main):005:0&gt; book.update!(tags: [])\n  TRANSACTION (0.1ms)  begin transaction\n  Tag Update All (1.0ms)  UPDATE &quot;tags&quot; SET &quot;book_id&quot; = ? WHERE &quot;tags&quot;.&quot;book_id&quot; = ? AND &quot;tags&quot;.&quot;id&quot; IN (?, ?)  [[&quot;book_id&quot;, nil], [&quot;book_id&quot;, 1], [nil, 1], [nil, 2]]\n  TRANSACTION (1.5ms)  commit transaction\n=&gt; true\nirb(main):006:0&gt; Tag.all\n  Tag Load (0.2ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot;\n=&gt; [#&lt;Tag:0x00007fcfa25288b0 id: 1, book_id: nil&gt;]\nirb(main):007:0&gt; book.update!(tags: [Tag.new])\n  TRANSACTION (0.1ms)  begin transaction\n  Tag Create (1.2ms)  INSERT INTO &quot;tags&quot; (&quot;book_id&quot;) VALUES (?)  [[&quot;book_id&quot;, 1]]\n  TRANSACTION (9.4ms)  commit transaction\n=&gt; true\nirb(main):008:0&gt; Tag.all\n  Tag Load (0.3ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot;\n=&gt; [#&lt;Tag:0x00007fcfa2e5b3d8 id: 1, book_id: nil&gt;, #&lt;Tag:0x00007fcfa2e5b310 id: 3, book_id: 1&gt;]\n\"><pre><span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:001</span><span class=\"pl-pds\">:0</span>&gt; <span class=\"pl-s1\">book</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Book</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">create!</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">tags</span>: <span class=\"pl-kos\">[</span><span class=\"pl-v\">Tag</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">Tag</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">)</span>\n   <span class=\"pl-kos\">(</span><span class=\"pl-c1\">2.4</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\"></span>  <span class=\"pl-en\">SELECT</span> <span class=\"pl-en\">sqlite_version</span><span class=\"pl-kos\">(</span>*<span class=\"pl-kos\">)</span>\n  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-k\">begin</span> <span class=\"pl-en\">transaction</span>\n  <span class=\"pl-en\">Book</span> <span class=\"pl-en\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">1.4</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">INSERT</span> <span class=\"pl-en\">INTO</span> <span class=\"pl-s\">\"books\"</span> <span class=\"pl-en\">DEFAULT</span> <span class=\"pl-c1\">VALUES</span>\n  <span class=\"pl-v\">Tag</span> <span class=\"pl-v\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">1.2</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">INSERT</span> <span class=\"pl-c1\">INTO</span> <span class=\"pl-s\">\"tags\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">VALUES</span> <span class=\"pl-kos\">(</span>?)  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-en\">Tag</span> <span class=\"pl-en\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.2</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">INSERT</span> <span class=\"pl-en\">INTO</span> <span class=\"pl-s\">\"tags\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-c1\">VALUES</span> <span class=\"pl-kos\">(</span>?)  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-en\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">2.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">commit</span> <span class=\"pl-en\">transaction</span>\n<span class=\"pl-c1\">=&gt;</span> <span class=\"pl-c\">#&lt;Book:0x00007fcfa24c0c60 id: 1&gt;</span>\n<span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:002</span><span class=\"pl-pds\">:0</span>&gt; <span class=\"pl-v\">Tag</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">all</span>\n  <span class=\"pl-en\">Tag</span> <span class=\"pl-en\">Load</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.3</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">SELECT</span> <span class=\"pl-s\">\"tags\"</span><span class=\"pl-kos\">.</span>* <span class=\"pl-en\">FROM</span> <span class=\"pl-s\">\"tags\"</span>\n<span class=\"pl-c1\">=&gt;</span> <span class=\"pl-kos\">[</span><span class=\"pl-c\">#&lt;Tag:0x00007fcfa258a420 id: 1, book_id: 1&gt;, #&lt;Tag:0x00007fcfa258a2b8 id: 2, book_id: 1&gt;]</span>\n<span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:003</span><span class=\"pl-pds\">:0</span>&gt; <span class=\"pl-s1\">book</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">tags</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">last</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">destroy!</span>\n  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-k\">begin</span> <span class=\"pl-en\">transaction</span>\n  <span class=\"pl-en\">Tag</span> <span class=\"pl-en\">Destroy</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.8</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">DELETE</span> <span class=\"pl-en\">FROM</span> <span class=\"pl-s\">\"tags\"</span> <span class=\"pl-c1\">WHERE</span> <span class=\"pl-s\">\"tags\"</span><span class=\"pl-kos\">.</span>\"<span class=\"pl-en\">id</span><span class=\"pl-s\">\" = ?  [[\"</span><span class=\"pl-en\">id</span><span class=\"pl-s\">\", 2]]</span>\n<span class=\"pl-s\">  TRANSACTION (1.5ms)  commit transaction</span>\n<span class=\"pl-s\">=&gt; #&lt;Tag:0x00007fcfa24c31b8 id: 2, book_id: 1&gt;</span>\n<span class=\"pl-s\">irb(main):004:0&gt; Tag.all</span>\n<span class=\"pl-s\">  Tag Load (0.2ms)  SELECT \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\".* FROM \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\"</span>\n<span class=\"pl-s\">=&gt; [#&lt;Tag:0x00007fcfa26c37b0 id: 1, book_id: 1&gt;]</span>\n<span class=\"pl-s\">irb(main):005:0&gt; book.update!(tags: [])</span>\n<span class=\"pl-s\">  TRANSACTION (0.1ms)  begin transaction</span>\n<span class=\"pl-s\">  Tag Update All (1.0ms)  UPDATE \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\" SET \"</span><span class=\"pl-en\">book_id</span><span class=\"pl-s\">\" = ? WHERE \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\".\"</span><span class=\"pl-en\">book_id</span><span class=\"pl-s\">\" = ? AND \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\".\"</span><span class=\"pl-en\">id</span><span class=\"pl-s\">\" IN (?, ?)  [[\"</span><span class=\"pl-en\">book_id</span><span class=\"pl-s\">\", nil], [\"</span><span class=\"pl-en\">book_id</span><span class=\"pl-s\">\", 1], [nil, 1], [nil, 2]]</span>\n<span class=\"pl-s\">  TRANSACTION (1.5ms)  commit transaction</span>\n<span class=\"pl-s\">=&gt; true</span>\n<span class=\"pl-s\">irb(main):006:0&gt; Tag.all</span>\n<span class=\"pl-s\">  Tag Load (0.2ms)  SELECT \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\".* FROM \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\"</span>\n<span class=\"pl-s\">=&gt; [#&lt;Tag:0x00007fcfa25288b0 id: 1, book_id: nil&gt;]</span>\n<span class=\"pl-s\">irb(main):007:0&gt; book.update!(tags: [Tag.new])</span>\n<span class=\"pl-s\">  TRANSACTION (0.1ms)  begin transaction</span>\n<span class=\"pl-s\">  Tag Create (1.2ms)  INSERT INTO \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\" (\"</span><span class=\"pl-en\">book_id</span><span class=\"pl-s\">\") VALUES (?)  [[\"</span><span class=\"pl-en\">book_id</span><span class=\"pl-s\">\", 1]]</span>\n<span class=\"pl-s\">  TRANSACTION (9.4ms)  commit transaction</span>\n<span class=\"pl-s\">=&gt; true</span>\n<span class=\"pl-s\">irb(main):008:0&gt; Tag.all</span>\n<span class=\"pl-s\">  Tag Load (0.3ms)  SELECT \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\".* FROM \"</span><span class=\"pl-en\">tags</span>\"\n<span class=\"pl-c1\">=&gt;</span> <span class=\"pl-kos\">[</span><span class=\"pl-c\">#&lt;Tag:0x00007fcfa2e5b3d8 id: 1, book_id: nil&gt;, #&lt;Tag:0x00007fcfa2e5b310 id: 3, book_id: 1&gt;]</span></pre></div>\n<p>Note that the tag with id = 1 is still there while Active Record should clean it up after calling <code>book.update!(tags: [])</code>.</p>\n<h3>Actual behavior</h3>\n<p>Inconsistent behavior when replacing \"has many\" association (deleting some records asynchronously). Associated records are updated with the <code>null</code> value for the foreign key when replacing the association as the whole, but there are no delete jobs scheduled.</p>\n<p>Note that using <code>dependant: :destroy</code> works as expected:</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"irb(main):001:0&gt; book = Book.create!(tags: [Tag.new, Tag.new])\n   (1.2ms)  SELECT sqlite_version(*)\n  TRANSACTION (0.1ms)  begin transaction\n  Book Create (1.3ms)  INSERT INTO &quot;books&quot; DEFAULT VALUES\n  Tag Create (0.4ms)  INSERT INTO &quot;tags&quot; (&quot;book_id&quot;) VALUES (?)  [[&quot;book_id&quot;, 1]]\n  Tag Create (0.3ms)  INSERT INTO &quot;tags&quot; (&quot;book_id&quot;) VALUES (?)  [[&quot;book_id&quot;, 1]]\n  TRANSACTION (1.6ms)  commit transaction\n=&gt; #&lt;Book:0x00007fd0d6be2e78 id: 1&gt;\nirb(main):002:0&gt; book.update!(tags: [])\n  TRANSACTION (0.1ms)  begin transaction\n  Tag Destroy (1.3ms)  DELETE FROM &quot;tags&quot; WHERE &quot;tags&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 1]]\n  Tag Destroy (0.4ms)  DELETE FROM &quot;tags&quot; WHERE &quot;tags&quot;.&quot;id&quot; = ?  [[&quot;id&quot;, 2]]\n  TRANSACTION (10.0ms)  commit transaction\n=&gt; true\nirb(main):003:0&gt; Tag.all\n  Tag Load (0.3ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot;\n=&gt; []\nirb(main):004:0&gt;\n\"><pre><span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:001</span><span class=\"pl-pds\">:0</span>&gt; <span class=\"pl-s1\">book</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Book</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">create!</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">tags</span>: <span class=\"pl-kos\">[</span><span class=\"pl-v\">Tag</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">Tag</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">)</span>\n   <span class=\"pl-kos\">(</span><span class=\"pl-c1\">1.2</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\"></span>  <span class=\"pl-en\">SELECT</span> <span class=\"pl-en\">sqlite_version</span><span class=\"pl-kos\">(</span>*<span class=\"pl-kos\">)</span>\n  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-k\">begin</span> <span class=\"pl-en\">transaction</span>\n  <span class=\"pl-en\">Book</span> <span class=\"pl-en\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">1.3</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">INSERT</span> <span class=\"pl-en\">INTO</span> <span class=\"pl-s\">\"books\"</span> <span class=\"pl-en\">DEFAULT</span> <span class=\"pl-c1\">VALUES</span>\n  <span class=\"pl-v\">Tag</span> <span class=\"pl-v\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.4</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">INSERT</span> <span class=\"pl-c1\">INTO</span> <span class=\"pl-s\">\"tags\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">VALUES</span> <span class=\"pl-kos\">(</span>?)  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-en\">Tag</span> <span class=\"pl-en\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.3</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">INSERT</span> <span class=\"pl-en\">INTO</span> <span class=\"pl-s\">\"tags\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-c1\">VALUES</span> <span class=\"pl-kos\">(</span>?)  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"book_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-en\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">1.6</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">commit</span> <span class=\"pl-en\">transaction</span>\n<span class=\"pl-c1\">=&gt;</span> <span class=\"pl-c\">#&lt;Book:0x00007fd0d6be2e78 id: 1&gt;</span>\n<span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:002</span><span class=\"pl-pds\">:0</span>&gt; <span class=\"pl-s1\">book</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">update!</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">tags</span>: <span class=\"pl-kos\">[</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-k\">begin</span> <span class=\"pl-en\">transaction</span>\n  <span class=\"pl-en\">Tag</span> <span class=\"pl-en\">Destroy</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">1.3</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-en\">DELETE</span> <span class=\"pl-en\">FROM</span> <span class=\"pl-s\">\"tags\"</span> <span class=\"pl-c1\">WHERE</span> <span class=\"pl-s\">\"tags\"</span><span class=\"pl-kos\">.</span>\"<span class=\"pl-en\">id</span><span class=\"pl-s\">\" = ?  [[\"</span><span class=\"pl-en\">id</span><span class=\"pl-s\">\", 1]]</span>\n<span class=\"pl-s\">  Tag Destroy (0.4ms)  DELETE FROM \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\" WHERE \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\".\"</span><span class=\"pl-en\">id</span><span class=\"pl-s\">\" = ?  [[\"</span><span class=\"pl-en\">id</span><span class=\"pl-s\">\", 2]]</span>\n<span class=\"pl-s\">  TRANSACTION (10.0ms)  commit transaction</span>\n<span class=\"pl-s\">=&gt; true</span>\n<span class=\"pl-s\">irb(main):003:0&gt; Tag.all</span>\n<span class=\"pl-s\">  Tag Load (0.3ms)  SELECT \"</span><span class=\"pl-en\">tags</span><span class=\"pl-s\">\".* FROM \"</span><span class=\"pl-en\">tags</span>\"\n<span class=\"pl-c1\">=&gt;</span> <span class=\"pl-kos\">[</span><span class=\"pl-kos\">]</span>\n<span class=\"pl-en\">irb</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">main</span><span class=\"pl-kos\">)</span><span class=\"pl-pds\">:004</span><span class=\"pl-pds\">:0</span>&gt;<span class=\"pl-en\"></span></pre></div>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: 6.1.3.2</p>\n<p><strong>Ruby version</strong>: 3.0.1</p>",
            "url": "https://github.com/rails/rails/issues/42430",
            "title": "Inconsistent behavior of `dependent: :destroy_async` for  the`has_many` association",
            "date_modified": "2021-09-09T12:24:22.000Z",
            "date_published": "2021-06-09T11:33:37.000Z",
            "author": {
                "name": "smt116",
                "url": "https://github.com/smt116"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/21235090?u=89134f923570b6f52573ba0eef5e0c87c5d056ce&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<p>There are various ways to reproduce this. What I did was render an Action Text content field with an image attachment within a Turbo stream using the <code>broadcasts_to</code> class method (which renders in a background job).</p>\n<p>Other issues referring to this behavior:</p>\n<ul>\n<li><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"776056318\" data-permission-text=\"Title is private\" data-url=\"https://github.com/hotwired/turbo-rails/issues/54\" data-hovercard-type=\"issue\" data-hovercard-url=\"/hotwired/turbo-rails/issues/54/hovercard\" href=\"https://github.com/hotwired/turbo-rails/issues/54\">hotwired/turbo-rails#54</a> (closed by the person who opened the issue, who found a workaround for other uses of Active Storage but not for the Action Text case)</li>\n<li><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"296738214\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/31979\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/31979/hovercard\" href=\"https://github.com/rails/rails/issues/31979\">#31979</a> (closed by stale bot, contains full repro steps)</li>\n<li><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"419738384\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/35578\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/35578/hovercard\" href=\"https://github.com/rails/rails/issues/35578\">#35578</a> (fixed, but only for Action Mailer)</li>\n</ul>\n<p>It appears that this issue has been around for some time, and that it affects multiple out-of-the box uses of Rails.</p>\n<h3>Expected behavior</h3>\n<p>The url in the image tag <code>&lt;src&gt;</code> generated from the attachment should use the default host. In the case of my example from dev mode, it should be 'localhost'.</p>\n<h3>Actual behavior</h3>\n<p>The attachment host in the <code>&lt;src&gt;</code> url is 'example.org'. This differs from the behavior when rendering from a controller.</p>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: 6.1.3.1</p>\n<p><strong>Ruby version</strong>: 3.0.0</p>",
            "url": "https://github.com/rails/rails/issues/41795",
            "title": "Rendering a partial outside of a controller results in the wrong host being used in Active Storage URLs",
            "date_modified": "2021-09-02T19:28:52.000Z",
            "date_published": "2021-03-30T04:43:54.000Z",
            "author": {
                "name": "brian-kephart",
                "url": "https://github.com/brian-kephart"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/287640?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>I've been looking at the source to see if this is already being done and can't find it anywhere.  Proposal is:</p>\n<p>Wrap <code>ActiveSupport::Cache::Strategy::LocalCache.with_local_cache</code> around <code>ActiveJob.perform</code>.</p>\n<p>Seems like it should be fairly straightforward, and may introduce nice performance wins.  Happy to assist if this makes sense!</p>",
            "url": "https://github.com/rails/rails/issues/42875",
            "title": "Wrap LocalCache around ActiveJob's",
            "date_modified": "2021-08-02T22:50:38.000Z",
            "date_published": "2021-07-26T12:42:23.000Z",
            "author": {
                "name": "chaffeqa",
                "url": "https://github.com/chaffeqa"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/1596233?u=895b9005c28914b8779abe9580c1adbdda079c8f&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<ol>\n<li>Define a model with an attached file</li>\n<li>Create a new record with an attachment</li>\n<li>Destroy the record before <code>ActiveStorage::AnalyzeJob</code> has run</li>\n</ol>\n<h3>Expected behavior</h3>\n<p>The job should succeed, perhaps logging that it did nothing because the blob doesn't exist anymore.</p>\n<h3>Actual behavior</h3>\n<p>The job fails with the following error:</p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"Error while trying to deserialize arguments: Couldn't find ActiveStorage::Blob with 'id'=&lt;blah&gt;\n\"><pre><code>Error while trying to deserialize arguments: Couldn't find ActiveStorage::Blob with 'id'=&lt;blah&gt;\n</code></pre></div>\n<p>This, in itself, isn't too much of an issue. However, backends (such as Sidekiq) are expected to retry failed jobs, so the queued job is likely to fail many times with no hope of ever succeeding.</p>\n<p>Again, in isolation, this isn't too much of an issue. In our use case we regularly expect attachments to<br>\nbe destroyed fairly quickly after creation as they pass through a chain of processing jobs. This has ended up in 100s of <code>ActiveStorage::AnalyzeJob</code>s building up and being retried repeatedly.</p>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: Rails 6.0.0</p>\n<p><strong>Ruby version</strong>: Ruby 2.6.3</p>",
            "url": "https://github.com/rails/rails/issues/37613",
            "title": "ActiveStorage::AnalyzeJob fails if blob has been destroyed",
            "date_modified": "2021-10-14T18:52:52.000Z",
            "date_published": "2019-10-31T14:24:15.000Z",
            "author": {
                "name": "ball-hayden",
                "url": "https://github.com/ball-hayden"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/981825?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<ol>\n<li>Reboot a Redis cluster while pointing a <code>RedisCacheStore</code> to it.</li>\n<li>Observe<code>Redis::CannotConnectError</code> and likely downtime the moment a new Redis cache connection needs to be established during the reboot event. eg:</li>\n</ol>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"Redis::CannotConnectError: Error connecting to Redis on some-redis-host.com:6379 (Errno::ECONNREFUSED)\n  from redis (4.3.1) lib/redis/client.rb:382:in `rescue in establish_connection'\n\"><pre><code>Redis::CannotConnectError: Error connecting to Redis on some-redis-host.com:6379 (Errno::ECONNREFUSED)\n  from redis (4.3.1) lib/redis/client.rb:382:in `rescue in establish_connection'\n</code></pre></div>\n<h3>Expected behavior</h3>\n<p>The <code>RedisCacheStore</code> documentation <a href=\"https://api.rubyonrails.org/classes/ActiveSupport/Cache/RedisCacheStore.html\" rel=\"nofollow\">states</a>:</p>\n<blockquote>\n<p>Fault tolerant. If the Redis server is unavailable, no exceptions are raised. Cache fetches are all misses and writes are dropped.</p>\n</blockquote>\n<p>Based on this guidance, we would assume connect attempt errors were transparently handled in a way that would not be end-user noticable.</p>\n<h3>Actual behavior</h3>\n<p>We see the connection errors stemming from the Redis client during operational events that propagate into downtime for our application. We have tried the standard driver as well as <code>hiredis</code> and both behave in the same fashion. Quickly reviewing the <a href=\"https://github.com/rails/rails/blob/main/activesupport/lib/active_support/cache/redis_cache_store.rb\">source</a> and the use of <code>failsafe</code> it appears that this may be too low-level for the cache store to address.</p>\n<p>Is this the case, and should documentation be clarified, or is this a legitimate bug / environmental configuration issue?</p>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>:<br>\n6.1.3.2</p>\n<p><strong>Ruby version</strong>:<br>\n2.7.4 - Alpine Linux 3.14</p>",
            "url": "https://github.com/rails/rails/issues/42818",
            "title": "Failsafe expectations of `RedisCacheStore`?",
            "date_modified": "2021-08-03T15:44:51.000Z",
            "date_published": "2021-07-19T19:41:13.000Z",
            "author": {
                "name": "booleanbetrayal",
                "url": "https://github.com/booleanbetrayal"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/1710795?u=ba3804cd0d8bb86f4422a1a20efc6947aa06a7f6&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>Trying to use a new feature for Rails 6 <a href=\"https://github.com/rails/rails/pull/30941\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/30941/hovercard\">Introduce custom serializers to ActiveJob arguments</a> and I am getting a warning when I add a serializer to the <code>custom_serializer</code> list.</p>\n<h3>Steps to reproduce</h3>\n<p>Included the 5 steps for setup before the actual issue under test in \"testing\"</p>\n<h3>Setup</h3>\n<ol>\n<li><code>rails new custom_serializer_warning</code></li>\n<li><code>cd custom_serializer_warning &amp;&amp; git add . &amp;&amp; git commit -m \"initial commit\"</code></li>\n<li><code>mkdir app/serializers &amp;&amp; touch app/serializers/money_serializer.rb</code></li>\n<li><a href=\"https://edgeguides.rubyonrails.org/active_job_basics.html#serializers\" rel=\"nofollow\">copy money_serializer from active_job_basics docs</a>.</li>\n<li>Add the serializer - Either of initializer file or directly into application.rb. The guide doesn't make it clear if there's a preferred way (both are in the example repo):</li>\n</ol>\n<p>a. Initializer file</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"#config/initializers/custom_serializer.rb\n\nRails.application.config.active_job.custom_serializers &lt;&lt; MoneySerializer\n\"><pre><span class=\"pl-c\">#config/initializers/custom_serializer.rb</span>\n\n<span class=\"pl-v\">Rails</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">application</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">config</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">active_job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">custom_serializers</span> &lt;&lt; <span class=\"pl-v\">MoneySerializer</span></pre></div>\n<p>b. Adding to<code> application.rb</code> directly</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\" # application.rb\n\n class Application &lt; Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n     config.load_defaults 6.0\n+    config.active_job.custom_serializers &lt;&lt; MoneySerializer\n   end\n\"><pre> <span class=\"pl-c\"># application.rb</span>\n\n <span class=\"pl-k\">class</span> <span class=\"pl-v\">Application</span> &lt; <span class=\"pl-v\">Rails</span>::<span class=\"pl-v\">Application</span>\n     <span class=\"pl-c\"># Initialize configuration defaults for originally generated Rails version.</span>\n     <span class=\"pl-en\">config</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">load_defaults</span> <span class=\"pl-c1\">6.0</span>\n+    <span class=\"pl-en\">config</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">active_job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">custom_serializers</span> &lt;&lt; <span class=\"pl-v\">MoneySerializer</span>\n   <span class=\"pl-k\">end</span></pre></div>\n<p>This way gives a different behaviour to (a) in that the loading error exception stops me going into rails console at all (see below)</p>\n<p><a href=\"https://github.com/notapatch/custom_serializer_warning\">I have a minimal rails example</a></p>\n<hr>\n<h3>Testing</h3>\n<ol>\n<li><code>DISABLE_SPRING=1 rails test</code></li>\n</ol>\n<ul>\n<li>Without the DISABLE_SPRING you only see it the first time.</li>\n</ul>\n<p>Included the <code>MoneySerializer</code> part of <code>Rails.autoloaders.log!</code></p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"DEPRECATION WARNING: Initialization autoloaded the constant MoneySerializer.\n(see below for full message)\n...\nPlease, check the &quot;Autoloading and Reloading Constants&quot; guide for solutions.\n (called from &lt;main&gt; at \n...\nZeitwerk@rails.main: autoload set for MoneySerializer, to be loaded from\n /.../custom_serializer_warning/app/serializers/money_serializer.rb\n\"><pre><code>DEPRECATION WARNING: Initialization autoloaded the constant MoneySerializer.\n(see below for full message)\n...\nPlease, check the \"Autoloading and Reloading Constants\" guide for solutions.\n (called from &lt;main&gt; at \n...\nZeitwerk@rails.main: autoload set for MoneySerializer, to be loaded from\n /.../custom_serializer_warning/app/serializers/money_serializer.rb\n</code></pre></div>\n<ol start=\"2\">\n<li>Rails console</li>\n</ol>\n<p>When adding to custom serializer with the initializer file (a) it loads without warning (the autoload does not try to load it). When you do force it to use MoneySerializer it loads without warning.</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"m = MoneySerializer\nZeitwerk@rails.main: constant MoneySerializer loaded from file \n/../custom_serializer_warning/app/serializers/money_serializer.rb\n=&gt; MoneySerializer\n\"><pre><span class=\"pl-s1\">m</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">MoneySerializer</span>\n<span class=\"pl-en\">Zeitwerk</span><span class=\"pl-c1\">@rails</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">main</span>: <span class=\"pl-en\">constant</span> <span class=\"pl-en\">MoneySerializer</span> <span class=\"pl-en\">loaded</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">file</span> \n<span class=\"pl-pds\">/../custom</span><span class=\"pl-kos\"></span><span class=\"pl-en\">_serializer_warning</span>/<span class=\"pl-en\">app</span>/<span class=\"pl-en\">serializers</span>/<span class=\"pl-en\">money_serializer</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">rb</span>\n<span class=\"pl-c1\">=&gt;</span> <span class=\"pl-v\">MoneySerializer</span></pre></div>\n<p>When adding to custom serializer with application.rb (b) it errors out</p>\n<div class=\"highlight highlight-source-ruby position-relative\" data-snippet-clipboard-copy-content=\"uninitialized constant\n      CustomSerializerWarning::Application::MoneySerializer (NameError)\n\"><pre><span class=\"pl-en\">uninitialized</span> <span class=\"pl-en\">constant</span>\n      <span class=\"pl-v\">CustomSerializerWarning</span>::<span class=\"pl-v\">Application</span>::<span class=\"pl-v\">MoneySerializer</span> <span class=\"pl-kos\">(</span><span class=\"pl-v\">NameError</span><span class=\"pl-kos\">)</span></pre></div>\n<h3>Variations which make no difference</h3>\n<p>This makes no difference to the warning</p>\n<ul>\n<li>Rails 6.0.1 / Rails master</li>\n<li>directory \"serializers\" doesn't matter I have created other directories below <code>app</code> without changing anything</li>\n<li>Full Serializer class  as with <code>MoneySerializer</code>  or an empty class <code>class MySerializer; end</code>  makes no difference.</li>\n<li>Adding serializer in <code>config/environments/test.rb </code> it behaved like (a) adding via initializer file.</li>\n<li><code>Rails.autoloaders.log! </code> present / absent</li>\n</ul>\n<h3>Expected behavior</h3>\n<p>When a custom serializer is added to custom serializers no warning is given. Or failing that I would expect guide to reassure that what I am doing shouldn't break in the near future.</p>\n<h3>Actual behavior</h3>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"DEPRECATION WARNING: Initialization autoloaded the constant &lt;FooSerializer&gt;.\n\nBeing able to do this is deprecated. Autoloading during initialization is going\nto be an error condition in future versions of Rails.\n\nReloading does not reboot the application, and therefore code executed during\ninitialization does not run again. So, if you reload &lt;FooSerializer&gt;, for example,\nthe expected changes won't be reflected in that stale Class object.\n\nThis autoloaded constant has been unloaded.\n\"><pre><code>DEPRECATION WARNING: Initialization autoloaded the constant &lt;FooSerializer&gt;.\n\nBeing able to do this is deprecated. Autoloading during initialization is going\nto be an error condition in future versions of Rails.\n\nReloading does not reboot the application, and therefore code executed during\ninitialization does not run again. So, if you reload &lt;FooSerializer&gt;, for example,\nthe expected changes won't be reflected in that stale Class object.\n\nThis autoloaded constant has been unloaded.\n</code></pre></div>\n<h3>System configuration</h3>\n<p>Rails 6.0.1 (but also tested on master)<br>\nRuby 2.6.5p114</p>\n<h3>References</h3>\n<p><a href=\"https://github.com/rails/rails/pull/30941\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/30941/hovercard\">Introduce custom serializers to ActiveJob arguments</a></p>",
            "url": "https://github.com/rails/rails/issues/37690",
            "title": "Adding custom serializer to list generates autoload deprecation warning",
            "date_modified": "2021-10-11T01:01:43.000Z",
            "date_published": "2019-11-12T11:51:11.000Z",
            "author": {
                "name": "notapatch",
                "url": "https://github.com/notapatch"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/87186?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<p>This is a possible feature request. I just installed Rails 5.2.0 beta2 and created a project with the <code>-O</code> option because I want to use Mongo instead of a relational database. What I noticed is that ActiveStorage, which I wanted to try out, was also disabled. I just saw that the gem is depending on ActiveRecord exclusively.</p>\n<h3>Expected behavior</h3>\n<p>Create a project with <code>-O</code> but not with <code>--skip-active-storage</code> and have ActiveStorage available, while ActiveRecord is disabled.</p>\n<h3>Actual behavior</h3>\n<p>ActiveStorage is not available.</p>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: 5.2.0.beta2</p>\n<p><strong>Ruby version</strong>: ruby 2.4.2p198 (2017-09-14 revision 59899) [x86_64-darwin16]</p>",
            "url": "https://github.com/rails/rails/issues/31408",
            "title": "ActiveStorage and Mongo",
            "date_modified": "2021-10-11T14:33:11.000Z",
            "date_published": "2017-12-12T04:55:42.000Z",
            "author": {
                "name": "aledalgrande",
                "url": "https://github.com/aledalgrande"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/58794487?u=05c4631c63c592c91ed47388ea1f261ca4aea578&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<ul>\n<li>have an app with active storage</li>\n</ul>\n<h3>Expected behavior</h3>\n<ul>\n<li>no errors from active storage</li>\n</ul>\n<h3>Actual behavior</h3>\n<ul>\n<li><code>ActiveStorage::FileNotFoundError</code>s</li>\n</ul>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: Rails 6.1.4</p>\n<p><strong>Ruby version</strong>: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-darwin20]</p>\n<p>I'm not sure which file I should delete and how to not receive this type of errors</p>",
            "url": "https://github.com/rails/rails/issues/42923",
            "title": "`on_rescue ActiveStorage::FileNotFoundError, :delete`",
            "date_modified": "2021-08-11T05:46:04.000Z",
            "date_published": "2021-07-31T05:15:11.000Z",
            "author": {
                "name": "dorianmariefr",
                "url": "https://github.com/dorianmariefr"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/942021?u=d099ba1c38319f844f48501622a491480da20ce5&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<ul>\n<li>Start rails server and let ActionCable establish a connection to Redis.</li>\n<li>Restart/Stop the Redis instance.</li>\n</ul>\n<h3>Expected behavior</h3>\n<p>If the connection between ActionCable and Redis is interrupted or lost the server process tries to re-establish the connection, informs web socket connections about the disconnection (or re-establishes subscriptions) and does not abort.</p>\n<h3>Actual behavior</h3>\n<p>If the connection between ActionCable and Redis is interrupted or lost the server <a href=\"https://github.com/rails/rails/blob/master/actioncable/lib/action_cable/subscription_adapter/redis.rb#L143\">process is aborted</a>, without trying to re-establish the connection.</p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"RoomChannel is transmitting the subscription confirmation\nRoomChannel is streaming from room:123\nExiting\n2.3.3/gems/redis-3.3.2/lib/redis/client.rb:257:in `rescue in io': Connection lost (ECONNRESET) (Redis::ConnectionError)\n  gems/redis-3.3.2/lib/redis/client.rb:250:in `io'\n  gems/redis-3.3.2/lib/redis/client.rb:261:in `read'\n  gems/redis-3.3.2/lib/redis/client.rb:136:in `block (3 levels) in call_loop'\n  gems/redis-3.3.2/lib/redis/client.rb:135:in `loop'\n  gems/redis-3.3.2/lib/redis/client.rb:135:in `block (2 levels) in call_loop'\n  gems/redis-3.3.2/lib/redis/client.rb:231:in `block (2 levels) in process'\n  gems/redis-3.3.2/lib/redis/client.rb:367:in `ensure_connected'\n  gems/redis-3.3.2/lib/redis/client.rb:221:in `block in process'\n  gems/redis-3.3.2/lib/redis/client.rb:306:in `logging'\n  gems/redis-3.3.2/lib/redis/client.rb:220:in `process'\n  gems/redis-3.3.2/lib/redis/client.rb:134:in `block in call_loop'\n  gems/redis-3.3.2/lib/redis/client.rb:280:in `with_socket_timeout'\n  gems/redis-3.3.2/lib/redis/client.rb:133:in `call_loop'\n  gems/redis-3.3.2/lib/redis/subscribe.rb:43:in `subscription'\n  gems/redis-3.3.2/lib/redis/subscribe.rb:12:in `subscribe'\n  gems/redis-3.3.2/lib/redis.rb:2765:in `_subscription'\n  gems/redis-3.3.2/lib/redis.rb:2143:in `block in subscribe'\n  gems/redis-3.3.2/lib/redis.rb:58:in `block in synchronize'\n  from .rubies/ruby-2.3.3/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'\n  gems/redis-3.3.2/lib/redis.rb:58:in `synchronize'\n  gems/redis-3.3.2/lib/redis.rb:2142:in `subscribe'\n  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:75:in `block in listen'\n  gems/redis-3.3.2/lib/redis/client.rb:293:in `with_reconnect'\n  gems/redis-3.3.2/lib/redis.rb:64:in `block in with_reconnect'\n  gems/redis-3.3.2/lib/redis.rb:58:in `block in synchronize'\n  from .rubies/ruby-2.3.3/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'\n  gems/redis-3.3.2/lib/redis.rb:58:in `synchronize'\n  gems/redis-3.3.2/lib/redis.rb:63:in `with_reconnect'\n  gems/redis-3.3.2/lib/redis.rb:70:in `without_reconnect'\n  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:72:in `listen'\n  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:146:in `block in ensure_listener_running'\n\"><pre><code>RoomChannel is transmitting the subscription confirmation\nRoomChannel is streaming from room:123\nExiting\n2.3.3/gems/redis-3.3.2/lib/redis/client.rb:257:in `rescue in io': Connection lost (ECONNRESET) (Redis::ConnectionError)\n  gems/redis-3.3.2/lib/redis/client.rb:250:in `io'\n  gems/redis-3.3.2/lib/redis/client.rb:261:in `read'\n  gems/redis-3.3.2/lib/redis/client.rb:136:in `block (3 levels) in call_loop'\n  gems/redis-3.3.2/lib/redis/client.rb:135:in `loop'\n  gems/redis-3.3.2/lib/redis/client.rb:135:in `block (2 levels) in call_loop'\n  gems/redis-3.3.2/lib/redis/client.rb:231:in `block (2 levels) in process'\n  gems/redis-3.3.2/lib/redis/client.rb:367:in `ensure_connected'\n  gems/redis-3.3.2/lib/redis/client.rb:221:in `block in process'\n  gems/redis-3.3.2/lib/redis/client.rb:306:in `logging'\n  gems/redis-3.3.2/lib/redis/client.rb:220:in `process'\n  gems/redis-3.3.2/lib/redis/client.rb:134:in `block in call_loop'\n  gems/redis-3.3.2/lib/redis/client.rb:280:in `with_socket_timeout'\n  gems/redis-3.3.2/lib/redis/client.rb:133:in `call_loop'\n  gems/redis-3.3.2/lib/redis/subscribe.rb:43:in `subscription'\n  gems/redis-3.3.2/lib/redis/subscribe.rb:12:in `subscribe'\n  gems/redis-3.3.2/lib/redis.rb:2765:in `_subscription'\n  gems/redis-3.3.2/lib/redis.rb:2143:in `block in subscribe'\n  gems/redis-3.3.2/lib/redis.rb:58:in `block in synchronize'\n  from .rubies/ruby-2.3.3/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'\n  gems/redis-3.3.2/lib/redis.rb:58:in `synchronize'\n  gems/redis-3.3.2/lib/redis.rb:2142:in `subscribe'\n  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:75:in `block in listen'\n  gems/redis-3.3.2/lib/redis/client.rb:293:in `with_reconnect'\n  gems/redis-3.3.2/lib/redis.rb:64:in `block in with_reconnect'\n  gems/redis-3.3.2/lib/redis.rb:58:in `block in synchronize'\n  from .rubies/ruby-2.3.3/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'\n  gems/redis-3.3.2/lib/redis.rb:58:in `synchronize'\n  gems/redis-3.3.2/lib/redis.rb:63:in `with_reconnect'\n  gems/redis-3.3.2/lib/redis.rb:70:in `without_reconnect'\n  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:72:in `listen'\n  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:146:in `block in ensure_listener_running'\n</code></pre></div>\n<h3>Additional information</h3>\n<p>As soon as the redis instance is unavailable and redis-rb receives the EOF from reading the socket the <a href=\"https://github.com/rails/rails/blob/master/actioncable/lib/action_cable/subscription_adapter/redis.rb#L71\">Listener</a> aborts <a href=\"https://github.com/rails/rails/blob/master/actioncable/lib/action_cable/subscription_adapter/redis.rb#L143\">as intended? here</a>.</p>\n<p>The redis-rb client offers the option to specify <code>reconnect_attempts</code> during initialisation, but in case of a disconnection, after a successful one, <a href=\"https://github.com/redis/redis-rb/blob/master/lib/redis/client.rb#L371\">the client doesn't attempt a reconnection</a>. Even if it did, it might be too aggressive to allow a re-establishment since there is no delay.</p>\n<p>A work-around is something like:</p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"    def listen_with_retry(conn)\n      listen conn\n    rescue ::Redis::ConnectionError, ::Redis::CannotConnectError =&gt; e\n      ActionCable.server.connections.each(&amp;:close)\n      sleep 1\n      retry\n    end\n\"><pre><code>    def listen_with_retry(conn)\n      listen conn\n    rescue ::Redis::ConnectionError, ::Redis::CannotConnectError =&gt; e\n      ActionCable.server.connections.each(&amp;:close)\n      sleep 1\n      retry\n    end\n</code></pre></div>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>: Rails 5.0.1</p>\n<p><strong>Ruby version</strong>: ruby 2.3.3p222</p>",
            "url": "https://github.com/rails/rails/issues/27659",
            "title": "ActionCable's SubscriptionAdpater for Redis does not reconnect after a connection loss.",
            "date_modified": "2021-10-10T07:44:53.000Z",
            "date_published": "2017-01-12T18:03:48.000Z",
            "author": {
                "name": "wpp",
                "url": "https://github.com/wpp"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/4380544?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3>Steps to reproduce</h3>\n<p>rails new my_api --api<br>\ncreate action and a view of type and format <code>.json.jbuilder</code> containing anything , i.e.<br>\n<code>json.foo 'bar'</code></p>\n<h3>Expected behavior</h3>\n<ol>\n<li>\n<p>render my <code>.json.jbuilder</code> views per usual when uncommenting  installing recommended gem in Gemfile</p>\n</li>\n<li>\n<p>Gemfile should reference compatible version</p>\n</li>\n</ol>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"# Build JSON APIs with ease. Read more: https://github.com/rails/jbuilder  \ngem 'jbuilder', '~&gt; 2.11', '&gt;= 2.11.2'\n\"><pre><code># Build JSON APIs with ease. Read more: https://github.com/rails/jbuilder  \ngem 'jbuilder', '~&gt; 2.11', '&gt;= 2.11.2'\n</code></pre></div>\n<h3>Actual behavior</h3>\n<p>installed jbuilder 2.7 which uses new signature only available in 2.11.2+.<br>\nsee <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-secondary\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/rails/rails/blob/03add891e6853decb842954bc7e9439c7f120af6/railties/lib/rails/generators/app_base.rb#L290\">rails/railties/lib/rails/generators/app_base.rb</a>\n    </p>\n    <p class=\"mb-0 color-text-tertiary\">\n         Line 290\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/rails/rails/commit/03add891e6853decb842954bc7e9439c7f120af6\">03add89</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L290\" class=\"blob-num border-0 px-3 py-0 color-bg-primary js-line-number\" data-line-number=\"290\"></td>\n          <td id=\"LC290\" class=\"blob-code border-0 px-3 py-0 color-bg-primary blob-code-inner js-file-line\"> <span class=\"pl-v\">GemfileEntry</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span> <span class=\"pl-s\">\"jbuilder\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"~&gt; 2.7\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">comment</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">{</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span> <span class=\"pl-en\">options</span><span class=\"pl-kos\">[</span><span class=\"pl-pds\">:api</span><span class=\"pl-kos\">]</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p>updated jbuilder template call signature here:<br>\nsee <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/rails/jbuilder/commit/3481da6b9fcb1785c900c8467a39a25d6f7ed169/hovercard\" href=\"https://github.com/rails/jbuilder/commit/3481da6b9fcb1785c900c8467a39a25d6f7ed169\">rails/jbuilder@<tt>3481da6</tt></a></p>\n<p>error output: <code>ActionView::Template::Error: wrong number of arguments</code></p>\n<h3>System configuration</h3>\n<p><strong>Rails version</strong>:<br>\nrails (6.1.4.1)</p>\n<p><strong>Ruby version</strong>:<br>\n2.5.1</p>",
            "url": "https://github.com/rails/rails/issues/43298",
            "title": "api project references incompatible jbuilder version 2.7",
            "date_modified": "2021-09-24T14:00:22.000Z",
            "date_published": "2021-09-23T21:40:56.000Z",
            "author": {
                "name": "guillaumenel",
                "url": "https://github.com/guillaumenel"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/3640027?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p>Rails 6 ActiveJob in conjunction with the Resque backend fails (entirely silently) to perform the defined Jobs - no error messages at all, even with all verbose modes on.</p>\n<p>To get my Jobs performed, I had to change the Job class syntax to Resque's \"proprietary\" language, as follows (commented out = the non-working ActiveJob syntax, as per Rails guides)</p>\n<div class=\"snippet-clipboard-content position-relative\" data-snippet-clipboard-copy-content=\"# class TestJob &lt; ApplicationJob\nclass TestJob\n  # queue_as :default\n  @queue = :default\n\n  # def perform(*args)\n  def self.perform(*args)\n    Rails.logger.info &quot;Doing the job...&quot;\n  end\nend\n\"><pre><code># class TestJob &lt; ApplicationJob\nclass TestJob\n  # queue_as :default\n  @queue = :default\n\n  # def perform(*args)\n  def self.perform(*args)\n    Rails.logger.info \"Doing the job...\"\n  end\nend\n</code></pre></div>\n<p>System configuration</p>\n<ul>\n<li>Rails 6.0.3.6</li>\n<li>ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-linux]</li>\n<li>resque (2.0.0)</li>\n<li>resque-scheduler (4.4.0)</li>\n<li>redis (4.2.5)</li>\n</ul>",
            "url": "https://github.com/rails/rails/issues/42073",
            "title": "Rails 6 ActiveJob with Resque backend fails silently",
            "date_modified": "2021-05-12T20:04:45.000Z",
            "date_published": "2021-04-25T19:32:13.000Z",
            "author": {
                "name": "john-999",
                "url": "https://github.com/john-999"
            }
        }
    ]
}