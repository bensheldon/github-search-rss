{
    "version": "https://jsonfeed.org/version/1",
    "title": "rails/rails: Issues containing 'ActiveJob Job'",
    "home_page_url": "https://github.com/search?q=ActiveJob+Job+repo%3Arails%2Frails+is%3Aissue&type=Issues",
    "feed_url": "https://bensheldon.github.io/github-search-rss/rails-activejob.json",
    "description": "rails/rails: Issues containing 'ActiveJob Job' on GitHub",
    "items": [
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/5077225?u=d56fa4ee81065e962478080385d7d9a08ec15f51&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Steps to reproduce</h3>\n<p dir=\"auto\">Run the test case script below:</p>\n\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"# frozen_string_literal: true\n\nrequire &quot;bundler/inline&quot;\n\ngemfile(true) do\n  source &quot;https://rubygems.org&quot;\n\n  gem &quot;rails&quot;, &quot;8.0.0.rc1&quot;\n  # If you want to test against edge Rails replace the previous line with this:\n  # gem &quot;rails&quot;, github: &quot;rails/rails&quot;, branch: &quot;main&quot;\nend\n\nrequire &quot;active_job&quot;\nrequire &quot;minitest/autorun&quot;\n\n$buffer = []\n\nclass DefaultsError &lt; StandardError; end\n\nclass RetryJob &lt; ActiveJob::Base\n  retry_on DefaultsError, attempts: 2\n\n  def perform(raising, *)\n    $buffer &lt;&lt; [raising, executions]\n\n    raise raising\n  end\nend\n\nclass BuggyJobTest &lt; ActiveJob::TestCase\n  def test_stuff\n    out, err = capture_subprocess_io do\n      perform_enqueued_jobs do\n        assert_raises DefaultsError do\n          RetryJob.perform_later DefaultsError\n        end\n      end\n    end\n\n    # The logs show job performed twice before being stopped\n    lines = out.split(&quot;\\n&quot;)\n\n    assert_match(\n      /Performing RetryJob \\(Job ID: .{36}\\)/,\n      lines[0]\n    )\n    assert_match(\n      /Performing RetryJob \\(Job ID: .{36}\\)/,\n      lines[1]\n    )\n    assert_match(\n      /Stopped retrying RetryJob \\(Job ID: .{36}\\)/,\n      lines[2]\n    )\n\n    assert_equal(\n      [[DefaultsError, 1], [DefaultsError, 2]],\n      $buffer\n    )\n\n    # However, the logs aren't appropriately tagged, as retried jobs duplicate the job tags\n    assert_match(\n      /\\[ActiveJob\\] \\[RetryJob\\] \\[.{36}\\] Performing RetryJob \\(Job ID: .{36}\\) from Test\\(default\\) enqueued at .{30} with arguments: DefaultsError/,\n      lines[0]\n    )\n    assert_match(\n      /\\[ActiveJob\\] \\[RetryJob\\] \\[.{36}\\] Performing RetryJob \\(Job ID: .{36}\\) from Test\\(default\\) enqueued at .{30} with arguments: DefaultsError/,\n      lines[1]\n    )\n    assert_match(\n      /\\[ActiveJob\\] \\[RetryJob\\] \\[.{36}\\] Stopped retrying RetryJob \\(Job ID: .{36}\\) due to a DefaultsError \\(DefaultsError\\), which reoccurred on 2 attempts/,\n      lines[2]\n    )\n    # logs look like this instead:\n    # [ActiveJob] [RetryJob] [{{job_id}}] Performing RetryJob (Job ID: {{job_id}}) from Test(default) enqueued at {{timestamp}} with arguments: DefaultsError\n    # [ActiveJob] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] Performing RetryJob (Job ID: {{job_id}}) from Test(default) enqueued at {{timestamp}} with arguments: DefaultsError\n    # [ActiveJob] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] Stopped retrying RetryJob (Job ID: {{job_id}}) due to a DefaultsError (DefaultsError), which reoccurred on 2 attempts.\n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-c\"># frozen_string_literal: true</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"bundler/inline\"</span>\n\n<span class=\"pl-en\">gemfile</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">true</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n  <span class=\"pl-en\">source</span> <span class=\"pl-s\">\"https://rubygems.org\"</span>\n\n  <span class=\"pl-en\">gem</span> <span class=\"pl-s\">\"rails\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"8.0.0.rc1\"</span>\n  <span class=\"pl-c\"># If you want to test against edge Rails replace the previous line with this:</span>\n  <span class=\"pl-c\"># gem \"rails\", github: \"rails/rails\", branch: \"main\"</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"active_job\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"minitest/autorun\"</span>\n\n$buffer <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">[</span><span class=\"pl-kos\">]</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">DefaultsError</span> &lt; <span class=\"pl-v\">StandardError</span><span class=\"pl-kos\">;</span> <span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">RetryJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-en\">retry_on</span> <span class=\"pl-v\">DefaultsError</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">attempts</span>: <span class=\"pl-c1\">2</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">raising</span><span class=\"pl-kos\">,</span> *<span class=\"pl-kos\">)</span>\n    $buffer &lt;&lt; <span class=\"pl-kos\">[</span><span class=\"pl-s1\">raising</span><span class=\"pl-kos\">,</span> <span class=\"pl-en\">executions</span><span class=\"pl-kos\">]</span>\n\n    <span class=\"pl-en\">raise</span> <span class=\"pl-s1\">raising</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">BuggyJobTest</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">TestCase</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_stuff</span>\n    <span class=\"pl-s1\">out</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">err</span> <span class=\"pl-c1\">=</span> <span class=\"pl-en\">capture_subprocess_io</span> <span class=\"pl-k\">do</span>\n      <span class=\"pl-en\">perform_enqueued_jobs</span> <span class=\"pl-k\">do</span>\n        <span class=\"pl-en\">assert_raises</span> <span class=\"pl-v\">DefaultsError</span> <span class=\"pl-k\">do</span>\n          <span class=\"pl-v\">RetryJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span> <span class=\"pl-v\">DefaultsError</span>\n        <span class=\"pl-k\">end</span>\n      <span class=\"pl-k\">end</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-c\"># The logs show job performed twice before being stopped</span>\n    <span class=\"pl-s1\">lines</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s1\">out</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">split</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"<span class=\"pl-cce\">\\n</span>\"</span><span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">assert_match</span><span class=\"pl-kos\">(</span>\n      <span class=\"pl-sr\">/Performing RetryJob <span class=\"pl-cce\">\\(</span>Job ID: .{36}<span class=\"pl-cce\">\\)</span>/</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-s1\">lines</span><span class=\"pl-kos\">[</span><span class=\"pl-c1\">0</span><span class=\"pl-kos\">]</span>\n    <span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">assert_match</span><span class=\"pl-kos\">(</span>\n      <span class=\"pl-sr\">/Performing RetryJob <span class=\"pl-cce\">\\(</span>Job ID: .{36}<span class=\"pl-cce\">\\)</span>/</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-s1\">lines</span><span class=\"pl-kos\">[</span><span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span>\n    <span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">assert_match</span><span class=\"pl-kos\">(</span>\n      <span class=\"pl-sr\">/Stopped retrying RetryJob <span class=\"pl-cce\">\\(</span>Job ID: .{36}<span class=\"pl-cce\">\\)</span>/</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-s1\">lines</span><span class=\"pl-kos\">[</span><span class=\"pl-c1\">2</span><span class=\"pl-kos\">]</span>\n    <span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">assert_equal</span><span class=\"pl-kos\">(</span>\n      <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-v\">DefaultsError</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-v\">DefaultsError</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">2</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n      $buffer\n    <span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-c\"># However, the logs aren't appropriately tagged, as retried jobs duplicate the job tags</span>\n    <span class=\"pl-en\">assert_match</span><span class=\"pl-kos\">(</span>\n      <span class=\"pl-sr\">/<span class=\"pl-cce\">\\[</span>ActiveJob<span class=\"pl-cce\">\\]</span> <span class=\"pl-cce\">\\[</span>RetryJob<span class=\"pl-cce\">\\]</span> <span class=\"pl-cce\">\\[</span>.{36}<span class=\"pl-cce\">\\]</span> Performing RetryJob <span class=\"pl-cce\">\\(</span>Job ID: .{36}<span class=\"pl-cce\">\\)</span> from Test<span class=\"pl-cce\">\\(</span>default<span class=\"pl-cce\">\\)</span> enqueued at .{30} with arguments: DefaultsError/</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-s1\">lines</span><span class=\"pl-kos\">[</span><span class=\"pl-c1\">0</span><span class=\"pl-kos\">]</span>\n    <span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">assert_match</span><span class=\"pl-kos\">(</span>\n      <span class=\"pl-sr\">/<span class=\"pl-cce\">\\[</span>ActiveJob<span class=\"pl-cce\">\\]</span> <span class=\"pl-cce\">\\[</span>RetryJob<span class=\"pl-cce\">\\]</span> <span class=\"pl-cce\">\\[</span>.{36}<span class=\"pl-cce\">\\]</span> Performing RetryJob <span class=\"pl-cce\">\\(</span>Job ID: .{36}<span class=\"pl-cce\">\\)</span> from Test<span class=\"pl-cce\">\\(</span>default<span class=\"pl-cce\">\\)</span> enqueued at .{30} with arguments: DefaultsError/</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-s1\">lines</span><span class=\"pl-kos\">[</span><span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span>\n    <span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">assert_match</span><span class=\"pl-kos\">(</span>\n      <span class=\"pl-sr\">/<span class=\"pl-cce\">\\[</span>ActiveJob<span class=\"pl-cce\">\\]</span> <span class=\"pl-cce\">\\[</span>RetryJob<span class=\"pl-cce\">\\]</span> <span class=\"pl-cce\">\\[</span>.{36}<span class=\"pl-cce\">\\]</span> Stopped retrying RetryJob <span class=\"pl-cce\">\\(</span>Job ID: .{36}<span class=\"pl-cce\">\\)</span> due to a DefaultsError <span class=\"pl-cce\">\\(</span>DefaultsError<span class=\"pl-cce\">\\)</span>, which reoccurred on 2 attempts/</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-s1\">lines</span><span class=\"pl-kos\">[</span><span class=\"pl-c1\">2</span><span class=\"pl-kos\">]</span>\n    <span class=\"pl-kos\">)</span>\n    <span class=\"pl-c\"># logs look like this instead:</span>\n    <span class=\"pl-c\"># [ActiveJob] [RetryJob] [{{job_id}}] Performing RetryJob (Job ID: {{job_id}}) from Test(default) enqueued at {{timestamp}} with arguments: DefaultsError</span>\n    <span class=\"pl-c\"># [ActiveJob] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] Performing RetryJob (Job ID: {{job_id}}) from Test(default) enqueued at {{timestamp}} with arguments: DefaultsError</span>\n    <span class=\"pl-c\"># [ActiveJob] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] Stopped retrying RetryJob (Job ID: {{job_id}}) due to a DefaultsError (DefaultsError), which reoccurred on 2 attempts.</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\"><a href=\"https://gist.github.com/fractaledmind/353699ed05fa1151e5b5fec6bccefadc\">gist</a></p>\n<h3 dir=\"auto\">Expected behavior</h3>\n<p dir=\"auto\">Active Job should only log one set of job-related tags, even on retries.</p>\n<h3 dir=\"auto\">Actual behavior</h3>\n<p dir=\"auto\">Active Job logs N job-related tags, one per retry. So, on the second performance after a retry, the log looks like:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\" [ActiveJob] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] Performing RetryJob (Job ID: {{job_id}}) from Test(default) enqueued at {{timestamp}} with arguments: DefaultsError\"><pre class=\"notranslate\"><code class=\"notranslate\"> [ActiveJob] [RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}] Performing RetryJob (Job ID: {{job_id}}) from Test(default) enqueued at {{timestamp}} with arguments: DefaultsError\n</code></pre></div>\n<p dir=\"auto\">The issue is the <code class=\"notranslate\">[RetryJob] [{{job_id}}] [RetryJob] [{{job_id}}]</code>, which is duplicated.</p>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: Tested against both versions 8.0.0.rc1, 7.2.1.2, and 7.2.1.1</p>\n<p dir=\"auto\"><strong>Ruby version</strong>: 3.3.4</p>",
            "url": "https://github.com/rails/rails/issues/53443",
            "title": "Active Job duplicates job-related logging tags on retries",
            "date_modified": "2024-10-28T05:12:59.000Z",
            "date_published": "2024-10-24T19:33:15.000Z",
            "author": {
                "name": "fractaledmind",
                "url": "https://github.com/fractaledmind"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/2575027?u=e7a9fe052c03fa59da09e064fdfacf2b1f627c2f&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">By the time an <code class=\"notranslate\">ActiveJob::Base#perform</code> method is invoked, Active<br>\nRecord instances are already deserialized and reified through GlobalID<br>\nintegration.</p>\n<p dir=\"auto\">For example, consider the following model and job classes:</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class ApplicationRecord &lt; ActiveRecord::Base\n  self.strict_loading_by_default = true\nend\n\nclass Article &lt; ApplicationRecord\n  has_and_belongs_to_many :tags\nend\n\nclass Tag &lt; ApplicationRecord\n  has_and_belongs_to_many :articles\nend\n\nclass PublishJob &lt; ApplicationJob\n  def perform(article)\n    article.tags.each do |tag|\n      # ...\n    end\n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">ApplicationRecord</span> &lt; <span class=\"pl-v\">ActiveRecord</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">strict_loading_by_default</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">true</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">Article</span> &lt; <span class=\"pl-v\">ApplicationRecord</span>\n  <span class=\"pl-en\">has_and_belongs_to_many</span> <span class=\"pl-pds\">:tags</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">Tag</span> &lt; <span class=\"pl-v\">ApplicationRecord</span>\n  <span class=\"pl-en\">has_and_belongs_to_many</span> <span class=\"pl-pds\">:articles</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">PublishJob</span> &lt; <span class=\"pl-v\">ApplicationJob</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">article</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-s1\">article</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">tags</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">each</span> <span class=\"pl-k\">do</span> |<span class=\"pl-s1\">tag</span>|\n      <span class=\"pl-c\"># ...</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\">Since application code does not have an opportunity to configure<br>\nanything about that loading process (including which associations are<br>\neagerly loaded), it's common for Active Job executions to raise Active<br>\nRecord strict loading errors:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"ActiveRecord::StrictLoadingViolationError: `Article` is marked for strict_loading. The Tag association named `:tags` cannot be lazily loaded.\"><pre class=\"notranslate\"><code class=\"notranslate\">ActiveRecord::StrictLoadingViolationError: `Article` is marked for strict_loading. The Tag association named `:tags` cannot be lazily loaded.\n</code></pre></div>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">The <code class=\"notranslate\">GlobalID::Locator.locate</code> interface supports optional keyword<br>\noptions that configure how to query Active Record during the location<br>\nprocess. For example, the <a href=\"https://github.com/rails/globalid/tree/main?tab=readme-ov-file#options\"><code class=\"notranslate\">includes:</code> keyword argument</a> is transformed<br>\ninto a call to <a href=\"https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-includes\" rel=\"nofollow\">includes</a> while constructing the Active Record query.</p>\n<p dir=\"auto\">This commit introduces the <code class=\"notranslate\">ActiveJob::Base.locator_options</code> method to<br>\nconfigure how each test class wants to load records deserialized from<br>\nGlobalID values.</p>\n<div class=\"highlight highlight-source-diff notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class PublishJob &lt; ApplicationJob\n+  locator_options &quot;Article&quot;, includes: :tags\n+\n   def perform(article)\n     article.tags.each do |tag|\n       # ...\n     end\n   end\n end\"><pre class=\"notranslate\">class PublishJob &lt; ApplicationJob\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>  locator_options \"Article\", includes: :tags</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n   def perform(article)\n     article.tags.each do |tag|\n       # ...\n     end\n   end\n end</pre></div>\n<p dir=\"auto\">The first argument is a class name (in the style of the Active Record<br>\n<code class=\"notranslate\">:class_name</code> option for associations), and subsequent keyword options<br>\nare forwarded to <a href=\"https://github.com/rails/globalid/tree/main?tab=readme-ov-file#options\">GlobalID::Locator.locate</a>.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/50341",
            "title": "Introduce `ActiveJob::Base.locator_options`",
            "date_modified": "2024-12-18T15:42:27.000Z",
            "date_published": "2023-12-13T00:02:07.000Z",
            "author": {
                "name": "seanpdoyle",
                "url": "https://github.com/seanpdoyle"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/420607?u=fc189aa6783f3d53051efccd5d3f4de5715d1e50&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">After file attachment <code class=\"notranslate\">ActiveStorage::AnalyzeJob</code> always throws <code class=\"notranslate\">ActiveStorage::FileNotFoundError</code>. My guess is that <code class=\"notranslate\">ActiveStorage::AnalyzeJob</code> starts before file appear on a file system. Except this exception everything else works as expected, file get saved and attached.</p>\n<h3 dir=\"auto\">Steps to reproduce</h3>\n<ul dir=\"auto\">\n<li>only in production environment (must be race condition related issue)</li>\n<li>good_job to handle background jobs</li>\n<li>service: 'Disk'</li>\n<li>model with the <code class=\"notranslate\">has_one_attached :img, dependent: :destroy</code></li>\n<li>form with the file input</li>\n<li>submit form with the image</li>\n<li>Check background job status, should be  <code class=\"notranslate\">ActiveStorage::FileNotFoundError: ActiveStorage::FileNotFoundError</code></li>\n</ul>\n<h3 dir=\"auto\">Full trace</h3>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:152:in `rescue in stream'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:145:in `stream'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:31:in `block in download'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `block in instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `instrument'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service.rb:165:in `instrument'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:30:in `download'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:32:in `download'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:13:in `block in open'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:24:in `open_tempfile'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:12:in `open'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service.rb:92:in `open'\n/usr/local/bundle/gems/activestorage-8.0.1/app/models/active_storage/blob.rb:305:in `open'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/analyzer.rb:35:in `download_blob_to_tempfile'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/analyzer/image_analyzer/vips.rb:20:in `read_image'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/analyzer/image_analyzer.rb:20:in `metadata'\n/usr/local/bundle/gems/activestorage-8.0.1/app/models/active_storage/blob/analyzable.rb:52:in `extract_metadata_via_analyzer'\n/usr/local/bundle/gems/activestorage-8.0.1/app/models/active_storage/blob/analyzable.rb:30:in `analyze'\n/usr/local/bundle/gems/activestorage-8.0.1/app/jobs/active_storage/analyze_job.rb:11:in `perform'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:68:in `block in _perform_job'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:120:in `block in run_callbacks'\n/usr/local/bundle/gems/i18n-1.14.6/lib/i18n.rb:353:in `with_locale'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/translation.rb:9:in `block (2 levels) in &lt;module:Translation&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `instance_exec'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/core_ext/time/zones.rb:65:in `use_zone'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/timezones.rb:9:in `block (2 levels) in &lt;module:Timezones&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `instance_exec'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:140:in `run_callbacks'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:67:in `_perform_job'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:32:in `_perform_job'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:51:in `perform_now'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:26:in `block in perform_now'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/railties/job_runtime.rb:13:in `block in instrument'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:40:in `block in instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:212:in `instrument'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:39:in `instrument'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/railties/job_runtime.rb:11:in `instrument'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:26:in `perform_now'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/logging.rb:32:in `block in perform_now'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/tagged_logging.rb:143:in `block in tagged'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/tagged_logging.rb:38:in `tagged'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/tagged_logging.rb:143:in `tagged'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/broadcast_logger.rb:241:in `method_missing'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/logging.rb:39:in `tag_logger'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/logging.rb:32:in `perform_now'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:29:in `block in execute'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:120:in `block in run_callbacks'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/railtie.rb:95:in `block (4 levels) in &lt;class:Railtie&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:77:in `block in wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/execution_wrapper.rb:87:in `wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:74:in `wrap'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/railtie.rb:94:in `block (3 levels) in &lt;class:Railtie&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `instance_exec'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:140:in `run_callbacks'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:27:in `execute'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:605:in `block (3 levels) in perform'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `block in instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `instrument'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:604:in `block (2 levels) in perform'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/current_thread.rb:113:in `within'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:562:in `block in perform'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:120:in `block in run_callbacks'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/batch.rb:80:in `within_thread'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:747:in `reset_batch_values'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:140:in `run_callbacks'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:556:in `perform'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:299:in `block in perform_with_advisory_lock'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/concerns/good_job/advisory_lockable.rb:180:in `block in with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:1373:in `_scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:548:in `scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/scoping/default.rb:51:in `unscoped'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/concerns/good_job/advisory_lockable.rb:180:in `with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `block in with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:1373:in `_scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:548:in `scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `with_advisory_lock'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:293:in `perform_with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `block in perform_with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:1373:in `_scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:548:in `scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `perform_with_advisory_lock'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/job_performer.rb:35:in `block in next'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/capsule_tracker.rb:94:in `register'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/job_performer.rb:34:in `next'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/scheduler.rb:287:in `block (2 levels) in create_task'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:77:in `block in wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/execution_wrapper.rb:91:in `wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:74:in `wrap'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/scheduler.rb:286:in `block in create_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/safe_task_executor.rb:24:in `block in execute'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:48:in `block in synchronize'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:48:in `synchronize'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:48:in `synchronize'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/safe_task_executor.rb:22:in `execute'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/ivar.rb:170:in `safe_execute'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/scheduled_task.rb:298:in `process_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/timer_set.rb:98:in `block in ns_post_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in `run_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in `block (3 levels) in create_worker'\n&lt;internal:kernel&gt;:187:in `loop'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in `block (2 levels) in create_worker'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in `catch'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in `block in create_worker'\"><pre class=\"notranslate\"><code class=\"notranslate\">/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:152:in `rescue in stream'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:145:in `stream'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:31:in `block in download'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `block in instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `instrument'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service.rb:165:in `instrument'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service/disk_service.rb:30:in `download'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:32:in `download'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:13:in `block in open'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:24:in `open_tempfile'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/downloader.rb:12:in `open'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/service.rb:92:in `open'\n/usr/local/bundle/gems/activestorage-8.0.1/app/models/active_storage/blob.rb:305:in `open'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/analyzer.rb:35:in `download_blob_to_tempfile'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/analyzer/image_analyzer/vips.rb:20:in `read_image'\n/usr/local/bundle/gems/activestorage-8.0.1/lib/active_storage/analyzer/image_analyzer.rb:20:in `metadata'\n/usr/local/bundle/gems/activestorage-8.0.1/app/models/active_storage/blob/analyzable.rb:52:in `extract_metadata_via_analyzer'\n/usr/local/bundle/gems/activestorage-8.0.1/app/models/active_storage/blob/analyzable.rb:30:in `analyze'\n/usr/local/bundle/gems/activestorage-8.0.1/app/jobs/active_storage/analyze_job.rb:11:in `perform'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:68:in `block in _perform_job'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:120:in `block in run_callbacks'\n/usr/local/bundle/gems/i18n-1.14.6/lib/i18n.rb:353:in `with_locale'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/translation.rb:9:in `block (2 levels) in &lt;module:Translation&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `instance_exec'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/core_ext/time/zones.rb:65:in `use_zone'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/timezones.rb:9:in `block (2 levels) in &lt;module:Timezones&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `instance_exec'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:140:in `run_callbacks'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:67:in `_perform_job'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:32:in `_perform_job'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:51:in `perform_now'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:26:in `block in perform_now'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/railties/job_runtime.rb:13:in `block in instrument'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:40:in `block in instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:212:in `instrument'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:39:in `instrument'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/railties/job_runtime.rb:11:in `instrument'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/instrumentation.rb:26:in `perform_now'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/logging.rb:32:in `block in perform_now'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/tagged_logging.rb:143:in `block in tagged'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/tagged_logging.rb:38:in `tagged'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/tagged_logging.rb:143:in `tagged'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/broadcast_logger.rb:241:in `method_missing'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/logging.rb:39:in `tag_logger'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/logging.rb:32:in `perform_now'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:29:in `block in execute'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:120:in `block in run_callbacks'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/railtie.rb:95:in `block (4 levels) in &lt;class:Railtie&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:77:in `block in wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/execution_wrapper.rb:87:in `wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:74:in `wrap'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/railtie.rb:94:in `block (3 levels) in &lt;class:Railtie&gt;'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `instance_exec'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:140:in `run_callbacks'\n/usr/local/bundle/gems/activejob-8.0.1/lib/active_job/execution.rb:27:in `execute'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:605:in `block (3 levels) in perform'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `block in instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/notifications.rb:210:in `instrument'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:604:in `block (2 levels) in perform'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/current_thread.rb:113:in `within'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:562:in `block in perform'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:120:in `block in run_callbacks'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/batch.rb:80:in `within_thread'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:747:in `reset_batch_values'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:129:in `block in run_callbacks'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/callbacks.rb:140:in `run_callbacks'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:556:in `perform'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:299:in `block in perform_with_advisory_lock'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/concerns/good_job/advisory_lockable.rb:180:in `block in with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:1373:in `_scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:548:in `scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/scoping/default.rb:51:in `unscoped'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/concerns/good_job/advisory_lockable.rb:180:in `with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `block in with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:1373:in `_scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:548:in `scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `with_advisory_lock'\n/usr/local/bundle/gems/good_job-4.6.0/app/models/good_job/job.rb:293:in `perform_with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `block in perform_with_advisory_lock'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:1373:in `_scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation.rb:548:in `scoping'\n/usr/local/bundle/gems/activerecord-8.0.1/lib/active_record/relation/delegation.rb:81:in `perform_with_advisory_lock'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/job_performer.rb:35:in `block in next'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/capsule_tracker.rb:94:in `register'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/job_performer.rb:34:in `next'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/scheduler.rb:287:in `block (2 levels) in create_task'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:77:in `block in wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/execution_wrapper.rb:91:in `wrap'\n/usr/local/bundle/gems/activesupport-8.0.1/lib/active_support/reloader.rb:74:in `wrap'\n/usr/local/bundle/gems/good_job-4.6.0/lib/good_job/scheduler.rb:286:in `block in create_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/safe_task_executor.rb:24:in `block in execute'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:48:in `block in synchronize'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:48:in `synchronize'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:48:in `synchronize'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/safe_task_executor.rb:22:in `execute'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/ivar.rb:170:in `safe_execute'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/scheduled_task.rb:298:in `process_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/timer_set.rb:98:in `block in ns_post_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in `run_task'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in `block (3 levels) in create_worker'\n&lt;internal:kernel&gt;:187:in `loop'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in `block (2 levels) in create_worker'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in `catch'\n/usr/local/bundle/gems/concurrent-ruby-1.3.4/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in `block in create_worker'\n</code></pre></div>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: 8.0.1</p>\n<p dir=\"auto\"><strong>Ruby version</strong>: 3.3.6</p>",
            "url": "https://github.com/rails/rails/issues/54028",
            "title": "[activestorage] ActiveStorage::FileNotFoundError",
            "date_modified": "2024-12-23T14:22:16.000Z",
            "date_published": "2024-12-22T10:46:13.000Z",
            "author": {
                "name": "jonas-jasas",
                "url": "https://github.com/jonas-jasas"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/803765?u=1068ad3fe7323acb63e9fe65e558ba0aabe5d3fe&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">I realized that retrying a job from GoodJob would enqueue it in the current locale of the GoodJob dashboard, even if the job was originally enqueued in a different locale.</p>\n<p dir=\"auto\">For instance, it was enqueued in <code class=\"notranslate\">:fr</code>, and failed. When I retried it from the dashboard that was in <code class=\"notranslate\">:en</code>, it was enqueued with an <code class=\"notranslate\">:en</code> locale ( I noticed it because it failed again with a missing translation error)</p>\n<p dir=\"auto\">I tracked it down to the <code class=\"notranslate\">serialize</code> method of <code class=\"notranslate\">ActiveJob</code> who always sets <code class=\"notranslate\">locale</code> from <code class=\"notranslate\">I18n.locale</code></p>\n<p dir=\"auto\">This PR changes the serialize method to actually return the original local from the job if it is set, and default to the current locale if not.</p>",
            "url": "https://github.com/rails/rails/pull/52121",
            "title": "Include the actual ActiveJob locale when serializing rather than I18n locale",
            "date_modified": "2025-01-10T14:33:31.000Z",
            "date_published": "2024-06-13T20:17:11.000Z",
            "author": {
                "name": "Intrepidd",
                "url": "https://github.com/Intrepidd"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/212648?u=26fba345a54b891629623ec9549fc0c54a2c2950&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">This Pull Request has been created because I needed <code class=\"notranslate\">retry_on attempts:</code> to use more complex logic than an Integer.</p>\n<p dir=\"auto\">In my specific case I was creating a concern for Jobs that would use <code class=\"notranslate\">retry_on</code> to allow jobs to quietly fail and retry. The concern was going to use a method to allow attempts to be customized in individual jobs.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    included do\n      retry_on(QuietRetryError, wait: :exponentially_longer, attempts: quiet_retry_attempts) do\n        # ...\n      end\n    end\"><pre class=\"notranslate\"><code class=\"notranslate\">    included do\n      retry_on(QuietRetryError, wait: :exponentially_longer, attempts: quiet_retry_attempts) do\n        # ...\n      end\n    end\n</code></pre></div>\n<p dir=\"auto\">However this ran into a state where the method needed to be defined and run when the concern was included instead of being available later in the job. It would be very fragile to have to define the method before including the concern. This lead to me to looking at if attempts accepted anything besides an integer. It did not but I saw there was already a pattern in place for wait to accept a Proc. I thought if that pattern was repeated for attempts than it would allow more flexibility for configuring attempts.</p>\n<p dir=\"auto\">My original thought was to have the Proc for attempts return a number similar to what the Proc for wait does. However, on thinking about it I decided that still did not leave much flexibility because attempts would still be determined by a number. Instead I switched it to return true/false so if the next attempt occurred could be determined by whatever logic was implemented in the Proc.</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This Pull Request changes ActiveJob retry_on attempts so it will accept a Proc.</p>\n<p dir=\"auto\">ActiveJob retry_on allowed the wait option to be set as a Proc that calculates the wait but did not give the same option for attempts. attempts could be set to only a number of times to attempt or unlimited. However, jobs sometimes need different logic than number of executions to determine if they should try again.</p>\n<p dir=\"auto\">This PR adds support for setting attempts to a Proc that returns either true or false. On true the retry will occur.</p>\n<p dir=\"auto\">As a an example:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"retry_on ProcRetryError, attempts: -&gt;(executions) { executions &lt; 2 }\"><pre class=\"notranslate\"><code class=\"notranslate\">retry_on ProcRetryError, attempts: -&gt;(executions) { executions &lt; 2 }\n</code></pre></div>\n<h3 dir=\"auto\">Additional information</h3>\n\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> There are no typos in commit messages and comments.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Feature branch is up-to-date with <code class=\"notranslate\">main</code> (if not - rebase it).</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> PR is not in a draft state.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> CI is passing.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/46245",
            "title": "Add Proc as a type for ActiveJob retry_on attempts",
            "date_modified": "2025-01-03T20:24:44.000Z",
            "date_published": "2022-10-14T14:32:44.000Z",
            "author": {
                "name": "rosew",
                "url": "https://github.com/rosew"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/295329?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">This Pull Request has been created because: I was reviewing a PR that used the callback chain halt technique but couldn't see any details in the ActiveJob docs on how these worked. I figure this change will be useful for someone else and avoid them having to read the source / other docs to find this info.</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This Pull Request changes the ActiveJob docs, to explain how job callback chain halting works. I coped the details from Active Record and provided a link to <a href=\"https://api.rubyonrails.org/classes/ActiveSupport/Callbacks.html\" rel=\"nofollow\">https://api.rubyonrails.org/classes/ActiveSupport/Callbacks.html</a> for more details.</p>\n<h3 dir=\"auto\">Additional information</h3>\n<p dir=\"auto\">Seems the main place rails docs the <a href=\"https://github.com/rails/rails/blob/a6dee8c5b1baffa0ac9e57016b90d8c88a8db1f6/activesupport/lib/active_support/callbacks.rb\">ActiveSupport callbacks</a> are in <a href=\"https://guides.rubyonrails.org/active_record_callbacks.html\" rel=\"nofollow\">https://guides.rubyonrails.org/active_record_callbacks.html</a>. There is some information in the <a href=\"https://api.rubyonrails.org/classes/ActiveSupport/Callbacks.html\" rel=\"nofollow\">ActiveSupport docs</a></p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Unrelated changes should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/53541",
            "title": "Update ActiveJob docs to show how to halt the callback chain",
            "date_modified": "2024-12-08T16:31:19.000Z",
            "date_published": "2024-11-05T23:54:27.000Z",
            "author": {
                "name": "camallen",
                "url": "https://github.com/camallen"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/4672858?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Summary</h3>\n<p dir=\"auto\">At Shopify, we have been using different flavours of concurrency within <code class=\"notranslate\">ActiveJob</code> for several years.<br>\nThis year we have consolidated all of this functionality into one API method called <code class=\"notranslate\">concurrency</code>.<br>\nAfter validating that this works for the scale of Shopify we decided to port the API upstream.</p>\n<p dir=\"auto\">There have been others attempt to add locking to <code class=\"notranslate\">ActiveJob</code> <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"354337924\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/33728\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/33728/hovercard\" href=\"https://github.com/rails/rails/pull/33728\">#33728</a></p>\n<p dir=\"auto\">While that functionality has nothing wrong, we have identified that locking is not enough as a concurrency primitive.</p>\n<p dir=\"auto\">At Shopify, we allow developers to specify multiple concurrency options for there jobs:</p>\n<p dir=\"auto\">In all examples below, <code class=\"notranslate\">keys</code> is the array of keys that will help build a unique concurrency key from the job arguments.</p>\n<ul dir=\"auto\">\n<li><code class=\"notranslate\">EndToEnd</code> where a job holds a concurrency ticket from the moment gets enqueue until the job is performed. When any jobs that try to enter the queue, we check if the concurrent limit is reached, and if it is, we drop the job.<br>\n<code class=\"notranslate\">concurrency(limit: 1, keys: ['checkout_id'])</code></li>\n</ul>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class PaymentProcessingJob &lt; ActiveJob\n  # We only allow one job to be in the queue and processing at all times.\n  # If a job tries to enter the queue while another job with the same checkout_id\n  # is in the queue or performing, we drop the new job.\n\n  # Do not want to charge the same checkout twice :)\n  concurrency(limit: 1, keys: ['checkout_id'])\n\n  def perform(params)\n    # Logic\n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">PaymentProcessingJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>\n  <span class=\"pl-c\"># We only allow one job to be in the queue and processing at all times.</span>\n  <span class=\"pl-c\"># If a job tries to enter the queue while another job with the same checkout_id</span>\n  <span class=\"pl-c\"># is in the queue or performing, we drop the new job.</span>\n\n  <span class=\"pl-c\"># Do not want to charge the same checkout twice :)</span>\n  <span class=\"pl-en\">concurrency</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">limit</span>: <span class=\"pl-c1\">1</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">keys</span>: <span class=\"pl-kos\">[</span><span class=\"pl-s\">'checkout_id'</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">)</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">params</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-c\"># Logic</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<ul dir=\"auto\">\n<li>\n<p dir=\"auto\"><code class=\"notranslate\">EnqueueLimit</code> where a job holds a concurrency ticket from the moment gets enqueue until the jobs get dequeued. When any jobs that try to enter the queue, we check if the concurrent limit is reached and if it is, we drop the job.<br>\n<code class=\"notranslate\">concurrency(limit: { enqueue: 1 }, keys: ['checkout_id'])</code></p>\n</li>\n<li>\n<p dir=\"auto\"><code class=\"notranslate\">PerformLimit</code> where a job holds a concurrency ticket from the moment gets dequeued until the jobs get performed. At the time of the dequeue, we check if the concurrency limit is reached and if so we put that job back into the Delayed queue<br>\n<code class=\"notranslate\">concurrency(limit: { performed: 1 }, keys: ['checkout_id'])</code></p>\n</li>\n</ul>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class UpdateThemeSettingsReferencesJob &lt; ActiveJob\n  # We only allow one job to perform at any moment. \n  # This is often used as a form of throttling for expensive operations.\n  # When a job from the head of the queue tries to start performing while another job \n  # with the same key is already performing, we re-enqueue the new job with a delay.\n  concurrency(\n    limit: { perform: 1 },\n    keys: ['shop_id', 'model', 'model_id']\n  )\n\n  def perform(params)\n    # Logic \n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">UpdateThemeSettingsReferencesJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>\n  <span class=\"pl-c\"># We only allow one job to perform at any moment. </span>\n  <span class=\"pl-c\"># This is often used as a form of throttling for expensive operations.</span>\n  <span class=\"pl-c\"># When a job from the head of the queue tries to start performing while another job </span>\n  <span class=\"pl-c\"># with the same key is already performing, we re-enqueue the new job with a delay.</span>\n  <span class=\"pl-en\">concurrency</span><span class=\"pl-kos\">(</span>\n    <span class=\"pl-pds\">limit</span>: <span class=\"pl-kos\">{</span> <span class=\"pl-pds\">perform</span>: <span class=\"pl-c1\">1</span> <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-pds\">keys</span>: <span class=\"pl-kos\">[</span><span class=\"pl-s\">'shop_id'</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">'model'</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">'model_id'</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-kos\">)</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">params</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-c\"># Logic </span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<ul dir=\"auto\">\n<li><code class=\"notranslate\">BoundedStages</code> is the combination of <code class=\"notranslate\">EnqueueLimit</code> and <code class=\"notranslate\">PerformLimit</code><br>\n<code class=\"notranslate\">concurrency(limit: { enqueue: 1, perform:1  }, keys: ['checkout_id'])</code></li>\n</ul>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class ExpensiveIdempotentSyncJob &lt; ActiveJob\n  # This job syncs the data of this shop with an external service.\n  # Since it is expensive, we want only one sync running at a time for each shop.\n  # We need to enqueue this job whenever something changes that requires syncing.\n  # However, if there is already an ExpensiveSyncJob in the queue, that job will sync all the changes made\n  # before it starts running, so there is no need to enqueue duplicates.\n  concurrency(limit: { enqueue: 1, perform: 1 }, keys: ['shop_id'])\n\n  def perform(params)\n    # Logic \n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">ExpensiveIdempotentSyncJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>\n  <span class=\"pl-c\"># This job syncs the data of this shop with an external service.</span>\n  <span class=\"pl-c\"># Since it is expensive, we want only one sync running at a time for each shop.</span>\n  <span class=\"pl-c\"># We need to enqueue this job whenever something changes that requires syncing.</span>\n  <span class=\"pl-c\"># However, if there is already an ExpensiveSyncJob in the queue, that job will sync all the changes made</span>\n  <span class=\"pl-c\"># before it starts running, so there is no need to enqueue duplicates.</span>\n  <span class=\"pl-en\">concurrency</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">limit</span>: <span class=\"pl-kos\">{</span> <span class=\"pl-pds\">enqueue</span>: <span class=\"pl-c1\">1</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">perform</span>: <span class=\"pl-c1\">1</span> <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">keys</span>: <span class=\"pl-kos\">[</span><span class=\"pl-s\">'shop_id'</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">)</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">params</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-c\"># Logic </span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\"><strong><code class=\"notranslate\">ActiveJob</code> only care about the concurrency at the <code class=\"notranslate\">enqueue</code> (EndToEnd and EnqueueLimit) steps for the <code class=\"notranslate\">perform</code> cases (PerformLimit and BoundedStages) is up to the job adapters to implement it internally. So the adapters can decide to add the functionality or not 😄</strong></p>\n<h3 dir=\"auto\">Other Information</h3>\n<p dir=\"auto\">The <code class=\"notranslate\">timeout</code> option allows specifying for how long a job can hold a concurrency ticket.</p>\n<p dir=\"auto\">At Shopify, we allow other API options like <code class=\"notranslate\">perform_delay</code> which configures the delay in which the job is placed back in the delayed queue when the <code class=\"notranslate\">PerformLimit</code> is reached.</p>\n<p dir=\"auto\">Here is an example of the API in use in one of our jobs:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"concurrency(limit: { perform: 8, perform_delay: 300 }, keys: ['task_name'])\"><pre class=\"notranslate\"><code class=\"notranslate\">concurrency(limit: { perform: 8, perform_delay: 300 }, keys: ['task_name'])\n</code></pre></div>",
            "url": "https://github.com/rails/rails/pull/40337",
            "title": "Add concurrency to ActiveJob",
            "date_modified": "2023-12-23T23:07:32.000Z",
            "date_published": "2020-10-05T18:27:44.000Z",
            "author": {
                "name": "GustavoCaso",
                "url": "https://github.com/GustavoCaso"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/139634?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">Resque workers can be killed.</p>\n<p dir=\"auto\">If they are killed with SIGKILL, the error handling in ActiveJob doesn't kick in, because it's not raised as an exception within the job code.</p>\n<p dir=\"auto\">The failures <em>can</em> be detected in Resque because other workers call <code class=\"notranslate\">prune_dead_workers</code> and trigger <code class=\"notranslate\">on_failure_XXX</code> hooks on the job class, which can be handled, but ActiveJob currently misses these exceptions and cannot trigger retry logic.</p>\n<h3 dir=\"auto\">Steps to reproduce</h3>\n\n<ol dir=\"auto\">\n<li>Create an ActiveJob instance</li>\n<li>Add <code class=\"notranslate\">rescue_from(Resque::DirtyExit) { retry_job } </code></li>\n<li>Enqueue in resque, and kill it mid-job with SIGKILL</li>\n<li>Wait for the worker to be pruned</li>\n<li>The error will be visible in the resque failure queue, but the retry will never happen.</li>\n</ol>\n\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"# frozen_string_literal: true\n\nrequire &quot;bundler/inline&quot;\n\n# this requires redis-server to be in PATH\n\ngemfile(true) do\n  source &quot;https://rubygems.org&quot;\n\n  git_source(:github) { |repo| &quot;https://github.com/#{repo}.git&quot; }\n\n  gem &quot;rails&quot;, github: &quot;rails/rails&quot;, branch: &quot;main&quot;\n  # gem &quot;rails&quot;, github: &quot;geoffyoungs/rails&quot;, branch: &quot;resque-dirty-exit-active-job&quot;\n  gem 'redis'\n  gem 'resque'\nend\n\nrequire &quot;active_support&quot;\nrequire &quot;active_support/core_ext/object/blank&quot;\nrequire &quot;active_job&quot;\nrequire &quot;resque&quot;\nrequire &quot;minitest/autorun&quot;\n\nENV['QUEUE'] = 'std'\nENV['FORK_PER_JOB'] = 'false'\nREDIS_PORT = 8765\nREDIS_DB = 'resque_dirty_exit_active_job.rdb'+$$.to_s\nActiveJob::Base.queue_adapter = :resque\n\nclass BugTest &lt; Minitest::Test\n  class Job &lt; ActiveJob::Base\n    def self.status=(value)\n      Resque.redis.set('job_status', value)\n    end\n\n    def self.status\n      Resque.redis.get('job_status')\n    end\n\n    queue_as ENV['QUEUE']\n\n    rescue_from(Resque::DirtyExit) do |exception|\n      Job.status = 'retry'\n      retry_job\n    end\n\n    def perform\n      sleep 2\n      Job.status = 'done'\n    end\n  end\n\n  def setup\n    spawn_redis\n    connect_to_redis\n    clear_redis\n    FileUtils.rm_f(REDIS_DB)\n  end\n\n  def teardown\n    kill_redis\n    FileUtils.rm_f(REDIS_DB)\n  end\n\n  def test_whether_job_is_retried_after_dirty_exit\n    Job.status = 'start'\n\n    Job.perform_later\n\n    assert Job.status.eql?('start')\n\n    work_for(1)\n\n    wait_for_workers_to_be_pruned\n\n    assert Job.status.eql?('retry')\n\n    work_for(3)\n\n    assert Job.status.eql?('done')\n  end\n\n  private\n\n  def work_for(time=0.5)\n    pid = fork {\n      connect_to_redis\n      worker = Resque::Worker.new\n      worker.prepare\n      worker.heartbeat\n      worker.work(1)\n      exit!\n    }\n    sleep(time)\n    kill('KILL', pid)\n  end\n\n  def spawn_redis\n    @redis ||= spawn(['redis-server', '--port', REDIS_PORT.to_s, '--dbfilename', REDIS_DB].join(' '), out: File.open('/dev/null', 'w'))\n  end\n\n  def clear_redis\n    Resque::Failure.clear\n    Resque.remove_queue('std')\n    Job.status = ''\n  end\n\n  def kill_redis\n    kill('INT', @redis)\n    @redis = nil\n  end\n\n  def kill(signal, pid)\n    Process.kill(signal, pid)\n    Process.waitpid(pid)\n  end\n\n  def connect_to_redis\n    Resque.redis = Redis.new(port: REDIS_PORT)\n  end\n\n  def wait_for_workers_to_be_pruned\n    while (workers = Resque::Worker.all).any?\n      sleep(0.1)\n      workers.first.prune_dead_workers\n    end\n  end\nend\n\"><pre class=\"notranslate\"><span class=\"pl-c\"># frozen_string_literal: true</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"bundler/inline\"</span>\n\n<span class=\"pl-c\"># this requires redis-server to be in PATH</span>\n\n<span class=\"pl-en\">gemfile</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">true</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n  <span class=\"pl-en\">source</span> <span class=\"pl-s\">\"https://rubygems.org\"</span>\n\n  <span class=\"pl-en\">git_source</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">:github</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> |<span class=\"pl-s1\">repo</span>| <span class=\"pl-s\">\"https://github.com/<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-s1\">repo</span><span class=\"pl-kos\">}</span></span>.git\"</span> <span class=\"pl-kos\">}</span>\n\n  <span class=\"pl-en\">gem</span> <span class=\"pl-s\">\"rails\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">github</span>: <span class=\"pl-s\">\"rails/rails\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">branch</span>: <span class=\"pl-s\">\"main\"</span>\n  <span class=\"pl-c\"># gem \"rails\", github: \"geoffyoungs/rails\", branch: \"resque-dirty-exit-active-job\"</span>\n  <span class=\"pl-en\">gem</span> <span class=\"pl-s\">'redis'</span>\n  <span class=\"pl-en\">gem</span> <span class=\"pl-s\">'resque'</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"active_support\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"active_support/core_ext/object/blank\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"active_job\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"resque\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"minitest/autorun\"</span>\n\n<span class=\"pl-c1\">ENV</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">'QUEUE'</span><span class=\"pl-kos\">]</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">'std'</span>\n<span class=\"pl-c1\">ENV</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">'FORK_PER_JOB'</span><span class=\"pl-kos\">]</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">'false'</span>\n<span class=\"pl-c1\">REDIS_PORT</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">8765</span>\n<span class=\"pl-c1\">REDIS_DB</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">'resque_dirty_exit_active_job.rdb'</span>+$$<span class=\"pl-kos\">.</span><span class=\"pl-en\">to_s</span>\n<span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">queue_adapter</span> <span class=\"pl-c1\">=</span> <span class=\"pl-pds\">:resque</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">BugTest</span> &lt; <span class=\"pl-v\">Minitest</span>::<span class=\"pl-v\">Test</span>\n  <span class=\"pl-k\">class</span> <span class=\"pl-v\">Job</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span><span class=\"pl-c1\">=</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">value</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-v\">Resque</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">redis</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'job_status'</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">value</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span>\n      <span class=\"pl-v\">Resque</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">redis</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">get</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'job_status'</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-en\">queue_as</span> <span class=\"pl-c1\">ENV</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">'QUEUE'</span><span class=\"pl-kos\">]</span>\n\n    <span class=\"pl-en\">rescue_from</span><span class=\"pl-kos\">(</span><span class=\"pl-v\">Resque</span>::<span class=\"pl-v\">DirtyExit</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span> |<span class=\"pl-s1\">exception</span>|\n      <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">'retry'</span>\n      <span class=\"pl-en\">retry_job</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span>\n      <span class=\"pl-en\">sleep</span> <span class=\"pl-c1\">2</span>\n      <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">'done'</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">setup</span>\n    <span class=\"pl-en\">spawn_redis</span>\n    <span class=\"pl-en\">connect_to_redis</span>\n    <span class=\"pl-en\">clear_redis</span>\n    <span class=\"pl-v\">FileUtils</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">rm_f</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">REDIS_DB</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">teardown</span>\n    <span class=\"pl-en\">kill_redis</span>\n    <span class=\"pl-v\">FileUtils</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">rm_f</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">REDIS_DB</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_whether_job_is_retried_after_dirty_exit</span>\n    <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">'start'</span>\n\n    <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n\n    <span class=\"pl-en\">assert</span> <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">eql?</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'start'</span><span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">work_for</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">1</span><span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">wait_for_workers_to_be_pruned</span>\n\n    <span class=\"pl-en\">assert</span> <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">eql?</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'retry'</span><span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">work_for</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">3</span><span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">assert</span> <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">eql?</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'done'</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">private</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">work_for</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">time</span><span class=\"pl-c1\">=</span><span class=\"pl-c1\">0.5</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-s1\">pid</span> <span class=\"pl-c1\">=</span> <span class=\"pl-en\">fork</span> <span class=\"pl-kos\">{</span>\n      <span class=\"pl-en\">connect_to_redis</span>\n      <span class=\"pl-s1\">worker</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Resque</span>::<span class=\"pl-v\">Worker</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span>\n      <span class=\"pl-s1\">worker</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">prepare</span>\n      <span class=\"pl-s1\">worker</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">heartbeat</span>\n      <span class=\"pl-s1\">worker</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">work</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">1</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-en\">exit!</span>\n    <span class=\"pl-kos\">}</span>\n    <span class=\"pl-en\">sleep</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">time</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">kill</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'KILL'</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">pid</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">spawn_redis</span>\n    <span class=\"pl-c1\">@redis</span> ||= <span class=\"pl-en\">spawn</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">'redis-server'</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">'--port'</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">REDIS_PORT</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">to_s</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">'--dbfilename'</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">REDIS_DB</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">join</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">' '</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">out</span>: <span class=\"pl-v\">File</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">open</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'/dev/null'</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">'w'</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">clear_redis</span>\n    <span class=\"pl-v\">Resque</span>::<span class=\"pl-v\">Failure</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">clear</span>\n    <span class=\"pl-v\">Resque</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">remove_queue</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'std'</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-v\">Job</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">status</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">''</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">kill_redis</span>\n    <span class=\"pl-en\">kill</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'INT'</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">@redis</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-c1\">@redis</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">nil</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">kill</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">signal</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">pid</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-v\">Process</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">kill</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">signal</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">pid</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-v\">Process</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">waitpid</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">pid</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">connect_to_redis</span>\n    <span class=\"pl-v\">Resque</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">redis</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Redis</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">port</span>: <span class=\"pl-c1\">REDIS_PORT</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">wait_for_workers_to_be_pruned</span>\n    <span class=\"pl-k\">while</span> <span class=\"pl-kos\">(</span><span class=\"pl-s1\">workers</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Resque</span>::<span class=\"pl-v\">Worker</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">all</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">any?</span>\n      <span class=\"pl-en\">sleep</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-s1\">workers</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">first</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">prune_dead_workers</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3 dir=\"auto\">Expected behavior</h3>\n\n<p dir=\"auto\">It should be possible to handle the exception in the ActiveJob class.</p>\n<h3 dir=\"auto\">Actual behavior</h3>\n\n<p dir=\"auto\">It's not possible to handle the exception in ActiveJob without additional resque behaviour added to the JobWrapper class.</p>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: 7.0.0-7.2.0pre (at least)</p>\n<p dir=\"auto\"><strong>Ruby version</strong>: Any</p>",
            "url": "https://github.com/rails/rails/issues/49734",
            "title": "Killed Resque jobs cannot be retried using ActiveJob",
            "date_modified": "2023-10-30T12:53:05.000Z",
            "date_published": "2023-10-21T19:25:48.000Z",
            "author": {
                "name": "geoffyoungs",
                "url": "https://github.com/geoffyoungs"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/2741?u=ce0dd0173c534e7e8b72e1cb393fed76e904a91c&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">We used to ship with a million database adapters in the box, but eventually settled on just offering official support for mysql/pgsql/sqlite. Folks can of course use whatever database they desire, but the work to maintain db2 or sqlserver or oracle falls to those vendors or the broader community.</p>\n<p dir=\"auto\">With Solid Queue becoming the default for Rails 8, it's time to do the same for Active Job. For starters, I think we can boil it down to the single-process adapters (inline/async/test) and then adapters for resque, sidekiq, and then of course Solid Queue (which actually just has the adapter in the gem!). Everything else should be extracted into separate adapter gems, like activejob-suckerpunch or whatever.</p>\n<p dir=\"auto\">Tracking the work:</p>\n<markdown-accessiblity-table><table role=\"table\">\n<thead>\n<tr>\n<th>Adapter</th>\n<th>Task</th>\n<th>PR</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>backburner_adapter</td>\n<td>Extract</td>\n<td>PDI</td>\n</tr>\n<tr>\n<td>resque_adapter</td>\n<td>Upstream</td>\n<td>PDI</td>\n</tr>\n<tr>\n<td>sneakers_adapter</td>\n<td>Extract</td>\n<td>PDI</td>\n</tr>\n<tr>\n<td>delayed_job_adapter</td>\n<td>Extract</td>\n<td>PDI</td>\n</tr>\n<tr>\n<td>queue_classic_adapter</td>\n<td>Extract</td>\n<td>PDI</td>\n</tr>\n<tr>\n<td>sidekiq_adapter</td>\n<td>Depends</td>\n<td>PDI</td>\n</tr>\n<tr>\n<td>sucker_punch_adapter</td>\n<td>Remove</td>\n<td><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"2526614555\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/52935\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/52935/hovercard\" href=\"https://github.com/rails/rails/pull/52935\">#52935</a></td>\n</tr>\n</tbody>\n</table></markdown-accessiblity-table>",
            "url": "https://github.com/rails/rails/issues/52929",
            "title": "Eject most Active Job adapters into separate gems",
            "date_modified": "2024-10-18T04:32:19.000Z",
            "date_published": "2024-09-14T15:18:06.000Z",
            "author": {
                "name": "dhh",
                "url": "https://github.com/dhh"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/12185788?u=811e797d549d1fe7e32162419ea075ceaaa9eb1d&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Steps to reproduce</h3>\n<p dir=\"auto\">I have created a <a href=\"https://github.com/beauraF/active-storage-bug-reproduction\">repository</a> with a <a href=\"https://github.com/beauraF/active-storage-bug-reproduction/blob/main/test/models/message_test.rb\">test</a> that reproduce the issue.</p>\n<h3 dir=\"auto\">Expected behavior</h3>\n<p dir=\"auto\">Nothing should be raised, upload of the image should be done before the <code class=\"notranslate\">ActiveStorage::AnalyzeJob</code> being enqueued.</p>\n<h3 dir=\"auto\">Actual behavior</h3>\n<p dir=\"auto\">An <code class=\"notranslate\">ActiveStorage::FileNotFoundError</code> is raised in the <code class=\"notranslate\">ActiveStorage::AnalyzeJob</code>. This is because the <code class=\"notranslate\">ActiveStorage::AnalyzeJob</code> is being enqueued before the <a href=\"https://github.com/rails/rails/blob/5287cfa17681527761c50fd8c6ae169f4500bd97/activestorage/lib/active_storage/attached/model.rb#L144\">upload</a> has been perform.</p>\n<p dir=\"auto\">This happens in a multi database setup only, because in this setup transaction are different. Leading to this <a href=\"https://github.com/rails/rails/blob/5287cfa17681527761c50fd8c6ae169f4500bd97/activestorage/lib/active_storage/attached/model.rb#L144\">hook</a> and this <a href=\"https://github.com/rails/rails/blob/5287cfa17681527761c50fd8c6ae169f4500bd97/activestorage/app/models/active_storage/attachment.rb#L36\">hook</a> being triggered not in the right order.</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"  TRANSACTION (0.2ms)  SAVEPOINT active_record_1\n  ActiveStorage::Blob Create (0.5ms)  INSERT INTO &quot;active_storage_blobs&quot; (&quot;key&quot;, &quot;filename&quot;, &quot;content_type&quot;, &quot;metadata&quot;, &quot;service_name&quot;, &quot;byte_size&quot;, &quot;checksum&quot;, &quot;created_at&quot;) VALUES (?, ?, ?, ?, ?, ?, ?, ?) RETURNING &quot;id&quot;  [[&quot;key&quot;, &quot;q2rj6gpsnyqxh5muc46pxwwqoedk&quot;], [&quot;filename&quot;, &quot;boris.jpeg&quot;], [&quot;content_type&quot;, &quot;image/jpeg&quot;], [&quot;metadata&quot;, &quot;{\\&quot;identified\\&quot;:true}&quot;], [&quot;service_name&quot;, &quot;test&quot;], [&quot;byte_size&quot;, 134525], [&quot;checksum&quot;, &quot;Vr1SvE5KCX4JXd2fHvAeMg==&quot;], [&quot;created_at&quot;, &quot;2024-11-21 16:58:42.981062&quot;]]\n  ActiveStorage::Attachment Create (0.0ms)  INSERT INTO &quot;active_storage_attachments&quot; (&quot;name&quot;, &quot;record_type&quot;, &quot;record_id&quot;, &quot;blob_id&quot;, &quot;created_at&quot;) VALUES (?, ?, ?, ?, ?) RETURNING &quot;id&quot;  [[&quot;name&quot;, &quot;images&quot;], [&quot;record_type&quot;, &quot;Message&quot;], [&quot;record_id&quot;, 1], [&quot;blob_id&quot;, 1], [&quot;created_at&quot;, &quot;2024-11-21 16:58:42.984205&quot;]]\n  TRANSACTION (0.0ms)  RELEASE SAVEPOINT active_record_1\n[ActiveJob] [ActiveStorage::AnalyzeJob] [b40331b6-d252-41b1-a53a-ace64e777b23]   ActiveStorage::Blob Load (0.1ms)  SELECT &quot;active_storage_blobs&quot;.* FROM &quot;active_storage_blobs&quot; WHERE &quot;active_storage_blobs&quot;.&quot;id&quot; = ? LIMIT ?  [[&quot;id&quot;, 1], [&quot;LIMIT&quot;, 1]]\n[ActiveJob] [ActiveStorage::AnalyzeJob] [b40331b6-d252-41b1-a53a-ace64e777b23] Performing ActiveStorage::AnalyzeJob (Job ID: b40331b6-d252-41b1-a53a-ace64e777b23) from Inline(default) enqueued at 2024-11-21T16:58:43.003033000Z with arguments: #&lt;GlobalID:0x00000001232b63e8 @uri=#&lt;URI::GID gid://active-storage-bug-reproduction/ActiveStorage::Blob/1&gt;&gt;\"><pre class=\"notranslate\">  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.2</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">SAVEPOINT</span> <span class=\"pl-en\">active_record_1</span>\n  <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">Blob</span> <span class=\"pl-v\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.5</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">INSERT</span> <span class=\"pl-c1\">INTO</span> <span class=\"pl-s\">\"active_storage_blobs\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"key\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"filename\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"content_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"metadata\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"service_name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"byte_size\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"checksum\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-c1\">VALUES</span> <span class=\"pl-kos\">(</span>?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">)</span> <span class=\"pl-c1\">RETURNING</span> <span class=\"pl-s\">\"id\"</span>  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"key\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"q2rj6gpsnyqxh5muc46pxwwqoedk\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"filename\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"boris.jpeg\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"content_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"image/jpeg\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"metadata\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"{<span class=\"pl-cce\">\\\"</span>identified<span class=\"pl-cce\">\\\"</span>:true}\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"service_name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"test\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"byte_size\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">134525</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"checksum\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"Vr1SvE5KCX4JXd2fHvAeMg==\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"2024-11-21 16:58:42.981062\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">Attachment</span> <span class=\"pl-v\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.0</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">INSERT</span> <span class=\"pl-c1\">INTO</span> <span class=\"pl-s\">\"active_storage_attachments\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"record_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"record_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"blob_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-c1\">VALUES</span> <span class=\"pl-kos\">(</span>?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">,</span> ?) <span class=\"pl-c1\">RETURNING</span> <span class=\"pl-s\">\"id\"</span>  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"images\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"record_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"Message\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"record_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"blob_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"2024-11-21 16:58:42.984205\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.0</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">RELEASE</span> <span class=\"pl-c1\">SAVEPOINT</span> <span class=\"pl-en\">active_record_1</span>\n<span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">AnalyzeJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-en\">b40331b6</span>-<span class=\"pl-en\">d252</span>-<span class=\"pl-c1\">41</span><span class=\"pl-en\">b1</span>-<span class=\"pl-en\">a53a</span>-<span class=\"pl-en\">ace64e777b23</span><span class=\"pl-kos\">]</span>   <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">Blob</span> <span class=\"pl-v\">Load</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">SELECT</span> <span class=\"pl-s\">\"active_storage_blobs\"</span><span class=\"pl-kos\">.</span>* <span class=\"pl-c1\">FROM</span> <span class=\"pl-s\">\"active_storage_blobs\"</span> <span class=\"pl-c1\">WHERE</span> <span class=\"pl-s\">\"active_storage_blobs\"</span><span class=\"pl-kos\">.</span><span class=\"pl-s\">\"id\"</span> <span class=\"pl-c1\">=</span> ? <span class=\"pl-c1\">LIMIT</span> ?  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"LIMIT\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n<span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">AnalyzeJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-en\">b40331b6</span>-<span class=\"pl-en\">d252</span>-<span class=\"pl-c1\">41</span><span class=\"pl-en\">b1</span>-<span class=\"pl-en\">a53a</span>-<span class=\"pl-en\">ace64e777b23</span><span class=\"pl-kos\">]</span> <span class=\"pl-v\">Performing</span> <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">AnalyzeJob</span> <span class=\"pl-kos\">(</span><span class=\"pl-v\">Job</span> <span class=\"pl-pds\">ID</span>: <span class=\"pl-en\">b40331b6</span>-<span class=\"pl-en\">d252</span>-<span class=\"pl-c1\">41</span><span class=\"pl-en\">b1</span>-<span class=\"pl-en\">a53a</span>-<span class=\"pl-en\">ace64e777b23</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Inline</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">default</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">enqueued</span> <span class=\"pl-en\">at</span> <span class=\"pl-c1\">2024</span>-<span class=\"pl-c1\">11</span>-<span class=\"pl-c1\">21</span><span class=\"pl-pds\">T16</span><span class=\"pl-pds\">:58</span>:<span class=\"pl-c1\">43.003033000</span><span class=\"pl-c1\">Z</span> <span class=\"pl-en\">with</span> <span class=\"pl-pds\">arguments</span>: <span class=\"pl-c\">#&lt;GlobalID:0x00000001232b63e8 @uri=#&lt;URI::GID gid://active-storage-bug-reproduction/ActiveStorage::Blob/1&gt;&gt;</span></pre></div>\n<p dir=\"auto\">As you can see, in this configuration, the <code class=\"notranslate\">ActiveStorage::Blob Create</code> and <code class=\"notranslate\">ActiveStorage::Attachment Create</code> are being wrapped in their own transaction leading to this <a href=\"https://github.com/rails/rails/blob/5287cfa17681527761c50fd8c6ae169f4500bd97/activestorage/app/models/active_storage/attachment.rb#L36\">hook</a> being triggered first.</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"  TRANSACTION (0.3ms)  SAVEPOINT active_record_1\n  ActiveStorage::Attachment Load (0.5ms)  SELECT &quot;active_storage_attachments&quot;.* FROM &quot;active_storage_attachments&quot; WHERE &quot;active_storage_attachments&quot;.&quot;record_id&quot; = ? AND &quot;active_storage_attachments&quot;.&quot;record_type&quot; = ? AND &quot;active_storage_attachments&quot;.&quot;name&quot; = ?  [[&quot;record_id&quot;, 1], [&quot;record_type&quot;, &quot;Profile&quot;], [&quot;name&quot;, &quot;images&quot;]]\n  ActiveStorage::Blob Create (0.1ms)  INSERT INTO &quot;active_storage_blobs&quot; (&quot;key&quot;, &quot;filename&quot;, &quot;content_type&quot;, &quot;metadata&quot;, &quot;service_name&quot;, &quot;byte_size&quot;, &quot;checksum&quot;, &quot;created_at&quot;) VALUES (?, ?, ?, ?, ?, ?, ?, ?) RETURNING &quot;id&quot;  [[&quot;key&quot;, &quot;75gy2pl6bpgaiq4zeb30cgf71rcz&quot;], [&quot;filename&quot;, &quot;boris.jpeg&quot;], [&quot;content_type&quot;, &quot;image/jpeg&quot;], [&quot;metadata&quot;, &quot;{\\&quot;identified\\&quot;:true}&quot;], [&quot;service_name&quot;, &quot;test&quot;], [&quot;byte_size&quot;, 134525], [&quot;checksum&quot;, &quot;Vr1SvE5KCX4JXd2fHvAeMg==&quot;], [&quot;created_at&quot;, &quot;2024-11-21 16:57:03.344937&quot;]]\n  ActiveStorage::Attachment Create (0.0ms)  INSERT INTO &quot;active_storage_attachments&quot; (&quot;name&quot;, &quot;record_type&quot;, &quot;record_id&quot;, &quot;blob_id&quot;, &quot;created_at&quot;) VALUES (?, ?, ?, ?, ?) RETURNING &quot;id&quot;  [[&quot;name&quot;, &quot;images&quot;], [&quot;record_type&quot;, &quot;Profile&quot;], [&quot;record_id&quot;, 1], [&quot;blob_id&quot;, 1], [&quot;created_at&quot;, &quot;2024-11-21 16:57:03.347488&quot;]]\n  Profile Update (0.0ms)  UPDATE &quot;profiles&quot; SET &quot;updated_at&quot; = ? WHERE &quot;profiles&quot;.&quot;id&quot; = ?  [[&quot;updated_at&quot;, &quot;2024-11-21 16:57:03.351208&quot;], [&quot;id&quot;, 1]]\n  TRANSACTION (0.0ms)  RELEASE SAVEPOINT active_record_1\n  Disk Storage (1.2ms) Uploaded file to key: 75gy2pl6bpgaiq4zeb30cgf71rcz (checksum: Vr1SvE5KCX4JXd2fHvAeMg==)\n[ActiveJob] [ActiveStorage::AnalyzeJob] [e7d8b3a0-4a6a-4311-acf0-69ae2b3e3d8b]   ActiveStorage::Blob Load (0.1ms)  SELECT &quot;active_storage_blobs&quot;.* FROM &quot;active_storage_blobs&quot; WHERE &quot;active_storage_blobs&quot;.&quot;id&quot; = ? LIMIT ?  [[&quot;id&quot;, 1], [&quot;LIMIT&quot;, 1]]\n[ActiveJob] [ActiveStorage::AnalyzeJob] [e7d8b3a0-4a6a-4311-acf0-69ae2b3e3d8b] Performing ActiveStorage::AnalyzeJob (Job ID: e7d8b3a0-4a6a-4311-acf0-69ae2b3e3d8b) from Inline(default) enqueued at 2024-11-21T16:57:03.374240000Z with arguments: #&lt;GlobalID:0x000000011e93f340 @uri=#&lt;URI::GID gid://active-storage-bug-reproduction/ActiveStorage::Blob/1&gt;&gt;\"><pre class=\"notranslate\">  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.3</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">SAVEPOINT</span> <span class=\"pl-en\">active_record_1</span>\n  <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">Attachment</span> <span class=\"pl-v\">Load</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.5</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">SELECT</span> <span class=\"pl-s\">\"active_storage_attachments\"</span><span class=\"pl-kos\">.</span>* <span class=\"pl-c1\">FROM</span> <span class=\"pl-s\">\"active_storage_attachments\"</span> <span class=\"pl-c1\">WHERE</span> <span class=\"pl-s\">\"active_storage_attachments\"</span><span class=\"pl-kos\">.</span><span class=\"pl-en\"></span><span class=\"pl-s\">\"record_id\"</span> <span class=\"pl-c1\">=</span> ? <span class=\"pl-c1\">AND</span> <span class=\"pl-s\">\"active_storage_attachments\"</span><span class=\"pl-kos\">.</span><span class=\"pl-s\">\"record_type\"</span> <span class=\"pl-c1\">=</span> ? <span class=\"pl-c1\">AND</span> <span class=\"pl-s\">\"active_storage_attachments\"</span><span class=\"pl-kos\">.</span><span class=\"pl-s\">\"name\"</span> <span class=\"pl-c1\">=</span> ?  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"record_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"record_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"Profile\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"images\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">Blob</span> <span class=\"pl-v\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">INSERT</span> <span class=\"pl-c1\">INTO</span> <span class=\"pl-s\">\"active_storage_blobs\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"key\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"filename\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"content_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"metadata\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"service_name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"byte_size\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"checksum\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-c1\">VALUES</span> <span class=\"pl-kos\">(</span>?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">)</span> <span class=\"pl-c1\">RETURNING</span> <span class=\"pl-s\">\"id\"</span>  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"key\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"75gy2pl6bpgaiq4zeb30cgf71rcz\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"filename\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"boris.jpeg\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"content_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"image/jpeg\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"metadata\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"{<span class=\"pl-cce\">\\\"</span>identified<span class=\"pl-cce\">\\\"</span>:true}\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"service_name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"test\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"byte_size\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">134525</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"checksum\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"Vr1SvE5KCX4JXd2fHvAeMg==\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"2024-11-21 16:57:03.344937\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">Attachment</span> <span class=\"pl-v\">Create</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.0</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">INSERT</span> <span class=\"pl-c1\">INTO</span> <span class=\"pl-s\">\"active_storage_attachments\"</span> <span class=\"pl-kos\">(</span><span class=\"pl-s\">\"name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"record_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"record_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"blob_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-c1\">VALUES</span> <span class=\"pl-kos\">(</span>?, ?<span class=\"pl-kos\">,</span> ?, ?<span class=\"pl-kos\">,</span> ?) <span class=\"pl-c1\">RETURNING</span> <span class=\"pl-s\">\"id\"</span>  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"name\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"images\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"record_type\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"Profile\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"record_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"blob_id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"created_at\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"2024-11-21 16:57:03.347488\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-v\">Profile</span> <span class=\"pl-v\">Update</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.0</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">UPDATE</span> <span class=\"pl-s\">\"profiles\"</span> <span class=\"pl-c1\">SET</span> <span class=\"pl-s\">\"updated_at\"</span> <span class=\"pl-c1\">=</span> ? <span class=\"pl-c1\">WHERE</span> <span class=\"pl-s\">\"profiles\"</span><span class=\"pl-kos\">.</span><span class=\"pl-s\">\"id\"</span> <span class=\"pl-c1\">=</span> ?  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"updated_at\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"2024-11-21 16:57:03.351208\"</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n  <span class=\"pl-c1\">TRANSACTION</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.0</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">RELEASE</span> <span class=\"pl-c1\">SAVEPOINT</span> <span class=\"pl-en\">active_record_1</span>\n  <span class=\"pl-v\">Disk</span> <span class=\"pl-v\">Storage</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">1.2</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span> <span class=\"pl-v\">Uploaded</span> <span class=\"pl-en\">file</span> <span class=\"pl-en\">to</span> <span class=\"pl-en\">key</span>: <span class=\"pl-c1\">75</span><span class=\"pl-en\">gy2pl6bpgaiq4zeb30cgf71rcz</span> <span class=\"pl-kos\">(</span><span class=\"pl-en\">checksum</span>: <span class=\"pl-v\">Vr1SvE5KCX4JXd2fHvAeMg</span>==<span class=\"pl-kos\">)</span>\n<span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">AnalyzeJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-en\">e7d8b3a0</span>-<span class=\"pl-c1\">4</span><span class=\"pl-en\">a6a</span>-<span class=\"pl-c1\">4311</span>-<span class=\"pl-en\">acf0</span>-<span class=\"pl-c1\">69</span><span class=\"pl-en\">ae2b3e3d8b</span><span class=\"pl-kos\">]</span>   <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">Blob</span> <span class=\"pl-v\">Load</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.1</span><span class=\"pl-en\">ms</span><span class=\"pl-kos\">)</span>  <span class=\"pl-c1\">SELECT</span> <span class=\"pl-s\">\"active_storage_blobs\"</span><span class=\"pl-kos\">.</span>* <span class=\"pl-c1\">FROM</span> <span class=\"pl-s\">\"active_storage_blobs\"</span> <span class=\"pl-c1\">WHERE</span> <span class=\"pl-s\">\"active_storage_blobs\"</span><span class=\"pl-kos\">.</span><span class=\"pl-s\">\"id\"</span> <span class=\"pl-c1\">=</span> ? <span class=\"pl-c1\">LIMIT</span> ?  <span class=\"pl-kos\">[</span><span class=\"pl-kos\">[</span><span class=\"pl-s\">\"id\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">[</span><span class=\"pl-s\">\"LIMIT\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-c1\">1</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">]</span>\n<span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">AnalyzeJob</span><span class=\"pl-kos\">]</span> <span class=\"pl-kos\">[</span><span class=\"pl-en\">e7d8b3a0</span>-<span class=\"pl-c1\">4</span><span class=\"pl-en\">a6a</span>-<span class=\"pl-c1\">4311</span>-<span class=\"pl-en\">acf0</span>-<span class=\"pl-c1\">69</span><span class=\"pl-en\">ae2b3e3d8b</span><span class=\"pl-kos\">]</span> <span class=\"pl-v\">Performing</span> <span class=\"pl-v\">ActiveStorage</span>::<span class=\"pl-v\">AnalyzeJob</span> <span class=\"pl-kos\">(</span><span class=\"pl-v\">Job</span> <span class=\"pl-pds\">ID</span>: <span class=\"pl-en\">e7d8b3a0</span>-<span class=\"pl-c1\">4</span><span class=\"pl-en\">a6a</span>-<span class=\"pl-c1\">4311</span>-<span class=\"pl-en\">acf0</span>-<span class=\"pl-c1\">69</span><span class=\"pl-en\">ae2b3e3d8b</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">from</span> <span class=\"pl-en\">Inline</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">default</span><span class=\"pl-kos\">)</span> <span class=\"pl-en\">enqueued</span> <span class=\"pl-en\">at</span> <span class=\"pl-c1\">2024</span>-<span class=\"pl-c1\">11</span>-<span class=\"pl-c1\">21</span><span class=\"pl-pds\">T16</span><span class=\"pl-pds\">:57</span>:<span class=\"pl-c1\">03.374240000</span><span class=\"pl-c1\">Z</span> <span class=\"pl-en\">with</span> <span class=\"pl-pds\">arguments</span>: <span class=\"pl-c\">#&lt;GlobalID:0x000000011e93f340 @uri=#&lt;URI::GID gid://active-storage-bug-reproduction/ActiveStorage::Blob/1&gt;&gt;</span></pre></div>\n<p dir=\"auto\">While in a single database setup, everything is wrapped in a single transaction, leading to the <a href=\"https://github.com/rails/rails/blob/main/activestorage/lib/active_storage/attached/model.rb#L144\">upload hook</a> being triggered before the <a href=\"https://github.com/rails/rails/blob/main/activestorage/app/models/active_storage/attachment.rb#L36\">enqueue</a> of the <code class=\"notranslate\">ActiveStorage::AnalyzeJob</code>.</p>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: 8.0.0</p>\n<p dir=\"auto\"><strong>Ruby version</strong>: 3.3.6</p>",
            "url": "https://github.com/rails/rails/issues/53694",
            "title": "`ActiveStorage::AnalyzeJob` is failing with `ActiveStorage::FileNotFoundError` in a multi database setup",
            "date_modified": "2024-12-23T14:31:47.000Z",
            "date_published": "2024-11-21T17:02:07.000Z",
            "author": {
                "name": "beauraF",
                "url": "https://github.com/beauraF"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/99586?u=b4abd791d83e768c72cb832147b4a210caecf47d&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Steps to reproduce</h3>\n<p dir=\"auto\">Run a job with retry attempt 1. The won't be retried.</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class FooJob &lt; ApplicationJob\n  class FooError &lt; StandardError; end\n\n  retry_on FooError, attempts: 1\n\n  def perform\n    raise FooError\n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">FooJob</span> &lt; <span class=\"pl-v\">ApplicationJob</span>\n  <span class=\"pl-k\">class</span> <span class=\"pl-v\">FooError</span> &lt; <span class=\"pl-v\">StandardError</span><span class=\"pl-kos\">;</span> <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-en\">retry_on</span> <span class=\"pl-v\">FooError</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">attempts</span>: <span class=\"pl-c1\">1</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span>\n    <span class=\"pl-en\">raise</span> <span class=\"pl-v\">FooError</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3 dir=\"auto\">Expected behavior</h3>\n<p dir=\"auto\">ActiveJob should retry at most the number of times specified by the attempts option.</p>\n<h3 dir=\"auto\">Actual behavior</h3>\n<p dir=\"auto\"><code class=\"notranslate\">attempts: 0</code>: runs once, no retry<br>\n<code class=\"notranslate\">attempts: 1</code>: runs once, no retry<br>\n<code class=\"notranslate\">attempts: 2</code>: runs once, one retry<br>\n<code class=\"notranslate\">attempts: 3</code>: runs once, two retries</p>\n<p dir=\"auto\">The behavior is not consistent. We can either change the behavior to be consistent (won't happen?) or at least document it very clearly.</p>\n<p dir=\"auto\"><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"358130415\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/33816\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/33816/hovercard\" href=\"https://github.com/rails/rails/issues/33816\">#33816</a> also pointed out the problem.</p>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: Rails 7.0.4</p>\n<p dir=\"auto\"><strong>Ruby version</strong>: ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-linux]</p>",
            "url": "https://github.com/rails/rails/issues/46419",
            "title": "ActiveJob's retry behavior is not consistent",
            "date_modified": "2023-07-25T22:51:14.000Z",
            "date_published": "2022-11-04T10:37:42.000Z",
            "author": {
                "name": "shouichi",
                "url": "https://github.com/shouichi"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/5122678?u=204301f9f9fe8930fd26fe3bfe65b6ffaffd8b59&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Steps to reproduce</h3>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"# frozen_string_literal: true\n\nrequire &quot;bundler/inline&quot;\n\ngemfile(true) do\n  source &quot;https://rubygems.org&quot;\n\n  gem &quot;rails&quot;\n  # If you want to test against edge Rails replace the previous line with this:\n  # gem &quot;rails&quot;, github: &quot;rails/rails&quot;, branch: &quot;main&quot;\nend\n\nrequire &quot;active_job&quot;\nrequire &quot;minitest/autorun&quot;\n\nclass BuggyJob &lt; ActiveJob::Base\n  def perform\n    puts &quot;performed&quot;\n  end\nend\n\nclass BuggyJobTest &lt; ActiveJob::TestCase\n  def test_should_not_find_job\n    at =  Time.new(&quot;1989-12-31T12:00:01&quot;)\n    wait_until = Time.new(&quot;1989-12-31T12:00:02&quot;)\n\n    assert_raise ActiveSupport::TestCase::Assertion do\n      assert_enqueued_with(job: BuggyJob, at:) do\n        BuggyJob.set(wait_until:).perform_later\n      end\n    end\n  end\n\n  def test_assert_enqueued_with_date\n    at = Date.tomorrow.noon\n    wait_until = Date.tomorrow.noon\n\n    assert_enqueued_with(job: BuggyJob, at:) do\n      BuggyJob.set(wait_until:).perform_later\n    end\n  end\n\n  def test_assert_enqueued_with_date_range\n    at_matcher = -&gt;(job_at) { (Date.yesterday..Date.tomorrow).cover?(job_at) }\n\n    BuggyJob.set(wait_until: Date.today.noon).perform_later\n\n    assert_enqueued_with(job: BuggyJob, at: at_matcher)\n  end\nend\n\"><pre class=\"notranslate\"><span class=\"pl-c\"># frozen_string_literal: true</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"bundler/inline\"</span>\n\n<span class=\"pl-en\">gemfile</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">true</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n  <span class=\"pl-en\">source</span> <span class=\"pl-s\">\"https://rubygems.org\"</span>\n\n  <span class=\"pl-en\">gem</span> <span class=\"pl-s\">\"rails\"</span>\n  <span class=\"pl-c\"># If you want to test against edge Rails replace the previous line with this:</span>\n  <span class=\"pl-c\"># gem \"rails\", github: \"rails/rails\", branch: \"main\"</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"active_job\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"minitest/autorun\"</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">BuggyJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span>\n    <span class=\"pl-en\">puts</span> <span class=\"pl-s\">\"performed\"</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">BuggyJobTest</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">TestCase</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_should_not_find_job</span>\n    <span class=\"pl-s1\">at</span> <span class=\"pl-c1\">=</span>  <span class=\"pl-v\">Time</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"1989-12-31T12:00:01\"</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-s1\">wait_until</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Time</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"1989-12-31T12:00:02\"</span><span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">assert_raise</span> <span class=\"pl-v\">ActiveSupport</span>::<span class=\"pl-v\">TestCase</span>::<span class=\"pl-v\">Assertion</span> <span class=\"pl-k\">do</span>\n      <span class=\"pl-en\">assert_enqueued_with</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">job</span>: <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">at</span>:<span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n        <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">wait_until</span>:<span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n      <span class=\"pl-k\">end</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_assert_enqueued_with_date</span>\n    <span class=\"pl-s1\">at</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Date</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">tomorrow</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">noon</span>\n    <span class=\"pl-s1\">wait_until</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Date</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">tomorrow</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">noon</span>\n\n    <span class=\"pl-en\">assert_enqueued_with</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">job</span>: <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">at</span>:<span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n      <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">wait_until</span>:<span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_assert_enqueued_with_date_range</span>\n    <span class=\"pl-s1\">at_matcher</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">-&gt;</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">job_at</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> <span class=\"pl-kos\">(</span><span class=\"pl-v\">Date</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">yesterday</span>..<span class=\"pl-v\">Date</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">tomorrow</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">cover?</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">job_at</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">}</span>\n\n    <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">wait_until</span>: <span class=\"pl-v\">Date</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">today</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">noon</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n\n    <span class=\"pl-en\">assert_enqueued_with</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">job</span>: <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">at</span>: <span class=\"pl-s1\">at_matcher</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3 dir=\"auto\">Expected behavior</h3>\n<p dir=\"auto\">The test should fail, since the values are different.</p>\n<h3 dir=\"auto\">Actual behavior</h3>\n<p dir=\"auto\">The test passes</p>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: <code class=\"notranslate\">7.1.3.4</code></p>\n<p dir=\"auto\"><strong>Ruby version</strong>: <code class=\"notranslate\">ruby 3.3.3 (2024-06-12 revision f1c7b6f435) [arm64-darwin23]</code></p>",
            "url": "https://github.com/rails/rails/issues/52478",
            "title": "ActiveJob: `assert_enqueued_with` does not support second-level granularity when asserting against the `at` argument  ",
            "date_modified": "2024-08-30T21:23:22.000Z",
            "date_published": "2024-08-01T14:34:51.000Z",
            "author": {
                "name": "stevepolitodesign",
                "url": "https://github.com/stevepolitodesign"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/75187597?u=97791928a7e78e7a393a98d42708cdcf71545238&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">ActiveJob produces a large amount of log noise, because errors that are emitted from ActiveJob don't have the standard Rails BacktraceCleaner applied. This is especially apparent when using Sorbet for Ruby types, since each application method call is wrapped by multiple Sorbet typechecking functions. My application's activejob error backtraces would typically log 4 non-relevant Sorbet function calls for each application function call. My workaround has been to monkey-patch Rails in our application. However, it seems to make sense to simply bring this behavior into ActiveJob as the default, as the backtrace cleaner is a pretty standard piece of Rails machinery that is used for most other backtraces in Rails.</p>\n<h3 dir=\"auto\">Additional information</h3>\n<p dir=\"auto\">When ActiveJob encounters an error performing a job, rather than printing the full unfiltered (and noisy) exception backtrace, print the cleaned backtrace using Rails's BacktraceCleaner.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CI is passing.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/46555",
            "title": "Small PR: Apply Rails backtrace cleaner to ActiveJob backtrace printout",
            "date_modified": "2024-09-19T23:30:07.000Z",
            "date_published": "2022-11-23T00:45:44.000Z",
            "author": {
                "name": "warrenbhw",
                "url": "https://github.com/warrenbhw"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/5122678?u=204301f9f9fe8930fd26fe3bfe65b6ffaffd8b59&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\"><span class=\"issue-keyword tooltipped tooltipped-se\" aria-label=\"This pull request closes issue #52478.\">Closes</span> <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"2442642275\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/52478\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/52478/hovercard\" href=\"https://github.com/rails/rails/issues/52478\">#52478</a></p>\n<p dir=\"auto\">Prior to this commit, tests using <a href=\"https://edgeapi.rubyonrails.org/classes/ActiveJob/TestHelper.html#method-i-assert_enqueued_with\" rel=\"nofollow\">assert_enqueued_with</a> asserting against the <code class=\"notranslate\">at</code> argument would incorrectly pass if testing with values that used second-level precision.</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class BuggyJobTest &lt; ActiveJob::TestCase\n  def test_should_not_find_job\n    at =  Time.new(&quot;1989-12-31T12:00:01&quot;)\n    wait_until = Time.new(&quot;1989-12-31T12:00:02&quot;)\n\n    assert_enqueued_with(job: BuggyJob, at:) do\n      BuggyJob.set(wait_until:).perform_later\n    end\n\n    fail &quot;Should not reach this line because assert_enqueued_with should have failed&quot;\n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">BuggyJobTest</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">TestCase</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_should_not_find_job</span>\n    <span class=\"pl-s1\">at</span> <span class=\"pl-c1\">=</span>  <span class=\"pl-v\">Time</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"1989-12-31T12:00:01\"</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-s1\">wait_until</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Time</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"1989-12-31T12:00:02\"</span><span class=\"pl-kos\">)</span>\n\n    <span class=\"pl-en\">assert_enqueued_with</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">job</span>: <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">at</span>:<span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n      <span class=\"pl-v\">BuggyJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">set</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">wait_until</span>:<span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_later</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-en\">fail</span> <span class=\"pl-s\">\"Should not reach this line because assert_enqueued_with should have failed\"</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Unrelated changes should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/52479",
            "title": "Support second-level precision for `assert_enqueued_with`",
            "date_modified": "2024-11-11T19:37:32.000Z",
            "date_published": "2024-08-01T14:45:12.000Z",
            "author": {
                "name": "stevepolitodesign",
                "url": "https://github.com/stevepolitodesign"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/94129?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">On latest main, tests for an application of mine reliably stall locally and in CI. Sometimes warnings like the following are printed:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"WARNING:  there is already a transaction in progress\nmessage type 0x43 arrived from server while idle\nmessage type 0x5a arrived from server while idle\"><pre class=\"notranslate\"><code class=\"notranslate\">WARNING:  there is already a transaction in progress\nmessage type 0x43 arrived from server while idle\nmessage type 0x5a arrived from server while idle\n</code></pre></div>\n<p dir=\"auto\">Environment:</p>\n<ul dir=\"auto\">\n<li>\n<p dir=\"auto\">The app uses a single Postgres DB and AR’s Postgres adapter.</p>\n</li>\n<li>\n<p dir=\"auto\">It uses RSpec and FactoryBot, not Minitest or AR fixtures.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"rspec-core (3.12.0)\n  rspec-support (~&gt; 3.12.0)\nrspec-expectations (3.12.0)\n  diff-lcs (&gt;= 1.2.0, &lt; 2.0)\n  rspec-support (~&gt; 3.12.0)\nrspec-mocks (3.12.0)\n  diff-lcs (&gt;= 1.2.0, &lt; 2.0)\n  rspec-support (~&gt; 3.12.0)\nrspec-rails (6.0.1)\n  actionpack (&gt;= 6.1)\n  activesupport (&gt;= 6.1)\n  railties (&gt;= 6.1)\n  rspec-core (~&gt; 3.11)\n  rspec-expectations (~&gt; 3.11)\n  rspec-mocks (~&gt; 3.11)\n  rspec-support (~&gt; 3.11)\nrspec-support (3.12.0)\"><pre class=\"notranslate\"><code class=\"notranslate\">rspec-core (3.12.0)\n  rspec-support (~&gt; 3.12.0)\nrspec-expectations (3.12.0)\n  diff-lcs (&gt;= 1.2.0, &lt; 2.0)\n  rspec-support (~&gt; 3.12.0)\nrspec-mocks (3.12.0)\n  diff-lcs (&gt;= 1.2.0, &lt; 2.0)\n  rspec-support (~&gt; 3.12.0)\nrspec-rails (6.0.1)\n  actionpack (&gt;= 6.1)\n  activesupport (&gt;= 6.1)\n  railties (&gt;= 6.1)\n  rspec-core (~&gt; 3.11)\n  rspec-expectations (~&gt; 3.11)\n  rspec-mocks (~&gt; 3.11)\n  rspec-support (~&gt; 3.11)\nrspec-support (3.12.0)\n</code></pre></div>\n</li>\n<li>\n<p dir=\"auto\">It’s on Ruby 3.1.3.</p>\n</li>\n</ul>\n<p dir=\"auto\">A <code class=\"notranslate\">git bisect</code> pointed to <a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/rails/rails/commit/1a2ca1920c62abdd08c809df1fa98fe0acf14bc3/hovercard\" href=\"https://github.com/rails/rails/commit/1a2ca1920c62abdd08c809df1fa98fe0acf14bc3\"><tt>1a2ca19</tt></a> (cc <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/byroot/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/byroot\">@byroot</a>). That change does seem relevant, but I haven’t been able to reproduce the issue in a minimal app yet. I’ve tried with both Minitest and RSpec.</p>\n<p dir=\"auto\">The tests usually stall in around the same place with the same seed, but not <em>exactly</em> the same place. And I looked at two stalled runs with different seeds that didn’t run any common tests before their stalls.</p>\n<p dir=\"auto\">This has been difficult to pin down so far but I will keep looking.</p>",
            "url": "https://github.com/rails/rails/issues/46797",
            "title": "Active Job async adapter may use connections without a lease",
            "date_modified": "2024-06-06T16:57:27.000Z",
            "date_published": "2022-12-23T04:15:25.000Z",
            "author": {
                "name": "georgeclaghorn",
                "url": "https://github.com/georgeclaghorn"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/5657035?u=48dc5950e98b199e1ed1e8c5c3f1e4bfd2b39691&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">Reference <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"2526470615\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/52929\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/52929/hovercard\" href=\"https://github.com/rails/rails/issues/52929\">#52929</a>.</p>\n<p dir=\"auto\">Opening this to not miss out.</p>\n<p dir=\"auto\">The next sidekiq release will add an Active Job adapter by default - <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"2527248131\" data-permission-text=\"Title is private\" data-url=\"https://github.com/sidekiq/sidekiq/issues/6430\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/sidekiq/sidekiq/pull/6430/hovercard\" href=\"https://github.com/sidekiq/sidekiq/pull/6430\">sidekiq/sidekiq#6430</a>.</p>",
            "url": "https://github.com/rails/rails/pull/53058",
            "title": "Deprecate built-in `sidekiq` adapter",
            "date_modified": "2024-10-24T08:45:04.000Z",
            "date_published": "2024-09-26T21:03:43.000Z",
            "author": {
                "name": "fatkodima",
                "url": "https://github.com/fatkodima"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/139634?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\"><span class=\"issue-keyword tooltipped tooltipped-se\" aria-label=\"This pull request closes issue #49734.\">Fixes</span> <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1955634814\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/49734\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/49734/hovercard\" href=\"https://github.com/rails/rails/issues/49734\">#49734</a></p>\n\n<h3 dir=\"auto\">Motivation / Background</h3>\n\n<p dir=\"auto\">This allows Resque::DirtyExit exceptions to be handled in the same way as other exceptions in ActiveJobs.</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This adds an <code class=\"notranslate\">on_failure</code> hook to the Resque JobWrapper class so that when a job is detected as having been killed (via prune_dead_workers) standard ActiveJob retry logic can be used to determine what to do next.</p>\n<h3 dir=\"auto\">Additional information</h3>\n\n<p dir=\"auto\">Because the Resque::DirtyExit exception is generated in the thread that sees that another worker has died (ie. the pruning thread) it's not visible to existing exception handling code in ActiveJob - it requires resque specific code to detect that this has happened and trigger the exception handler.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li>[?] Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/49735",
            "title": "Catch and handle Resque::DirtyExit exceptions in ActiveJob",
            "date_modified": "2023-11-01T10:12:15.000Z",
            "date_published": "2023-10-21T19:31:07.000Z",
            "author": {
                "name": "geoffyoungs",
                "url": "https://github.com/geoffyoungs"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/107635?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">I've been stuck on a failing test about a job that was supposed to be rescued from exceptions, and after an embarrassing amount of time I came to realise that using <code class=\"notranslate\">perform</code> shortcuts all of the ActiveJob niceties.</p>\n<p dir=\"auto\">This Pull Request has been created because I don't want other people to confuse the <code class=\"notranslate\">perform</code>, <code class=\"notranslate\">perform_now</code> or <code class=\"notranslate\">perform_later</code> altogether and waste valuable time trying to understand why the first one doesn't behave like the two others.</p>\n<p dir=\"auto\">Feel free to challenge the wording as you please ✌️</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This Pull Request changes the ActiveJob guide.</p>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/49301",
            "title": "[ci skip] clarify the benefits of using ActiveJob's execution wrappers",
            "date_modified": "2023-09-23T12:55:07.000Z",
            "date_published": "2023-09-16T10:36:45.000Z",
            "author": {
                "name": "freesteph",
                "url": "https://github.com/freesteph"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/1869157?u=0e7c06978383aaf02a8b456de829e330a5e955a6&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">Originally <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"2768081812\" data-permission-text=\"Title is private\" data-url=\"https://github.com/bensheldon/good_job/issues/1570\" data-hovercard-type=\"issue\" data-hovercard-url=\"/bensheldon/good_job/issues/1570/hovercard\" href=\"https://github.com/bensheldon/good_job/issues/1570\">bensheldon/good_job#1570</a></p>\n<p dir=\"auto\">When calling a job synchronously with <code class=\"notranslate\">perform_now</code>, <code class=\"notranslate\">retry_on</code> will result in asynchronous retries despite returning the failure.</p>\n<h3 dir=\"auto\">Steps to reproduce</h3>\n\n\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class ApplicationJob &lt; ActiveJob::Base\n  queue_as :slo_30mins\n  retry_on ActiveRecord::Deadlocked\n  retry_on StandardError, wait: :polynomially_longer, jitter: 0.30, attempts: 4\n  discard_on ActiveJob::DeserializationError\nend\n\nclass TestErrorHandlingJob &lt; ApplicationJob\n  queue_as :slo_30mins\n\n  TAG = &quot;[#{name}]&quot;.freeze\n\n  def perform(failure_rate: 0.5, **_args)\n    Rails.logger.info(&quot;#{TAG} | Starting job attempt=#{executions}&quot;)\n    sleep(0.5)\n    raise StandardError, 'Encountered failure' if rand &lt; failure_rate\n\n    Rails.logger.info(&quot;#{TAG} | Completed job attempt=#{executions}&quot;)\n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">ApplicationJob</span> &lt; <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-en\">queue_as</span> <span class=\"pl-pds\">:slo_30mins</span>\n  <span class=\"pl-en\">retry_on</span> <span class=\"pl-v\">ActiveRecord</span>::<span class=\"pl-v\">Deadlocked</span>\n  <span class=\"pl-en\">retry_on</span> <span class=\"pl-v\">StandardError</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">wait</span>: <span class=\"pl-pds\">:polynomially_longer</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">jitter</span>: <span class=\"pl-c1\">0.30</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">attempts</span>: <span class=\"pl-c1\">4</span>\n  <span class=\"pl-en\">discard_on</span> <span class=\"pl-v\">ActiveJob</span>::<span class=\"pl-v\">DeserializationError</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">TestErrorHandlingJob</span> &lt; <span class=\"pl-v\">ApplicationJob</span>\n  <span class=\"pl-en\">queue_as</span> <span class=\"pl-pds\">:slo_30mins</span>\n\n  <span class=\"pl-c1\">TAG</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">\"[<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-en\">name</span><span class=\"pl-kos\">}</span></span>]\"</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">freeze</span>\n\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">perform</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">failure_rate</span>: <span class=\"pl-c1\">0.5</span><span class=\"pl-kos\">,</span> **<span class=\"pl-s1\">_args</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-v\">Rails</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">logger</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">info</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-c1\">TAG</span><span class=\"pl-kos\">}</span></span> | Starting job attempt=<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-en\">executions</span><span class=\"pl-kos\">}</span></span>\"</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">sleep</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">0.5</span><span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">raise</span> <span class=\"pl-v\">StandardError</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">'Encountered failure'</span> <span class=\"pl-k\">if</span> <span class=\"pl-en\">rand</span> &lt; <span class=\"pl-s1\">failure_rate</span>\n\n    <span class=\"pl-v\">Rails</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">logger</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">info</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-c1\">TAG</span><span class=\"pl-kos\">}</span></span> | Completed job attempt=<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-en\">executions</span><span class=\"pl-kos\">}</span></span>\"</span><span class=\"pl-kos\">)</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"TestErrorHandlingJob.perform_now(failure_rate: 0.6)\n=&gt; #&lt;StandardError: Encountered failure&gt;\"><pre class=\"notranslate\"><span class=\"pl-v\">TestErrorHandlingJob</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">perform_now</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">failure_rate</span>: <span class=\"pl-c1\">0.6</span><span class=\"pl-kos\">)</span>\n<span class=\"pl-c1\">=&gt;</span> <span class=\"pl-c\">#&lt;StandardError: Encountered failure&gt;</span></pre></div>\n<h3 dir=\"auto\">Expected behavior</h3>\n\n<p dir=\"auto\">Either:<br>\na. retries occur synchronously<br>\nb. no retries occur</p>\n<h3 dir=\"auto\">Actual behavior</h3>\n\n<p dir=\"auto\">Rails enqueues the job to be processed asynchronously</p>\n<p dir=\"auto\">This seems to be the relevant code:</p>\n<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/rails/rails/blob/6d5633ff32147d59f43da4a4a88247586a66a696/activejob/lib/active_job/exceptions.rb#L151-L155\">rails/activejob/lib/active_job/exceptions.rb</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 151 to 155\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/rails/rails/commit/6d5633ff32147d59f43da4a4a88247586a66a696\">6d5633f</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L151\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"151\"></td>\n          <td id=\"LC151\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">def</span> <span class=\"pl-en\">retry_job</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">options</span> <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">{</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L152\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"152\"></td>\n          <td id=\"LC152\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-en\">instrument</span> <span class=\"pl-pds\">:enqueue_retry</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">options</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">slice</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">:error</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:wait</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L153\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"153\"></td>\n          <td id=\"LC153\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-en\">enqueue</span> <span class=\"pl-s1\">options</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L154\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"154\"></td>\n          <td id=\"LC154\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-k\">end</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L155\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"155\"></td>\n          <td id=\"LC155\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">end</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/rails/rails/blob/6d5633ff32147d59f43da4a4a88247586a66a696/activejob/lib/active_job/exceptions.rb#L62-L80\">rails/activejob/lib/active_job/exceptions.rb</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 62 to 80\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/rails/rails/commit/6d5633ff32147d59f43da4a4a88247586a66a696\">6d5633f</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L62\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"62\"></td>\n          <td id=\"LC62\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">def</span> <span class=\"pl-en\">retry_on</span><span class=\"pl-kos\">(</span>*<span class=\"pl-s1\">exceptions</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">wait</span>: <span class=\"pl-c1\">3</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">seconds</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">attempts</span>: <span class=\"pl-c1\">5</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">queue</span>: <span class=\"pl-c1\">nil</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">priority</span>: <span class=\"pl-c1\">nil</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">jitter</span>: <span class=\"pl-c1\">JITTER_DEFAULT</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L63\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"63\"></td>\n          <td id=\"LC63\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-en\">rescue_from</span><span class=\"pl-kos\">(</span>*<span class=\"pl-s1\">exceptions</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span> |<span class=\"pl-s1\">error</span>| </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L64\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"64\"></td>\n          <td id=\"LC64\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-s1\">executions</span> <span class=\"pl-c1\">=</span> <span class=\"pl-en\">executions_for</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">exceptions</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L65\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"65\"></td>\n          <td id=\"LC65\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">if</span> <span class=\"pl-s1\">attempts</span> == <span class=\"pl-pds\">:unlimited</span> || <span class=\"pl-s1\">executions</span> &lt; <span class=\"pl-s1\">attempts</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L66\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"66\"></td>\n          <td id=\"LC66\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">       <span class=\"pl-en\">retry_job</span> <span class=\"pl-pds\">wait</span>: <span class=\"pl-en\">determine_delay</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">seconds_or_duration_or_algorithm</span>: <span class=\"pl-s1\">wait</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">executions</span>: <span class=\"pl-s1\">executions</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">jitter</span>: <span class=\"pl-s1\">jitter</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">queue</span>: <span class=\"pl-s1\">queue</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">priority</span>: <span class=\"pl-s1\">priority</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">error</span>: <span class=\"pl-s1\">error</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L67\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"67\"></td>\n          <td id=\"LC67\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">else</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L68\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"68\"></td>\n          <td id=\"LC68\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">       <span class=\"pl-k\">if</span> <span class=\"pl-en\">block_given?</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L69\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"69\"></td>\n          <td id=\"LC69\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-en\">instrument</span> <span class=\"pl-pds\">:retry_stopped</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">error</span>: <span class=\"pl-s1\">error</span> <span class=\"pl-k\">do</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L70\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"70\"></td>\n          <td id=\"LC70\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">           <span class=\"pl-k\">yield</span> <span class=\"pl-smi\">self</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">error</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L71\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"71\"></td>\n          <td id=\"LC71\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">end</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L72\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"72\"></td>\n          <td id=\"LC72\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-en\">run_after_discard_procs</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">error</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L73\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"73\"></td>\n          <td id=\"LC73\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">       <span class=\"pl-k\">else</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L74\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"74\"></td>\n          <td id=\"LC74\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-en\">instrument</span> <span class=\"pl-pds\">:retry_stopped</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">error</span>: <span class=\"pl-s1\">error</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L75\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"75\"></td>\n          <td id=\"LC75\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-en\">run_after_discard_procs</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">error</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L76\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"76\"></td>\n          <td id=\"LC76\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-en\">raise</span> <span class=\"pl-s1\">error</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L77\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"77\"></td>\n          <td id=\"LC77\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">       <span class=\"pl-k\">end</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L78\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"78\"></td>\n          <td id=\"LC78\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">end</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L79\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"79\"></td>\n          <td id=\"LC79\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-k\">end</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L80\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"80\"></td>\n          <td id=\"LC80\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">end</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: 7.2.2.1</p>\n<p dir=\"auto\"><strong>Ruby version</strong>: 3.3.6</p>",
            "url": "https://github.com/rails/rails/issues/54146",
            "title": "[ActiveJob] perform_now enqueues a job when raising exception with retry_on",
            "date_modified": "2025-01-07T23:30:56.000Z",
            "date_published": "2025-01-07T20:26:14.000Z",
            "author": {
                "name": "nickstanish",
                "url": "https://github.com/nickstanish"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/951433?u=dbf5caebb18538ad106aa392f591c1a5a91af550&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Steps to reproduce</h3>\n<p dir=\"auto\">We have a project with a multi-database (2 databases) configuration.<br>\nWhen executing the test suite like follows the tests hang after some time.</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"PARALLEL_WORKERS=1 bin/rails test\"><pre class=\"notranslate\"><span class=\"pl-c1\">PARALLEL_WORKERS</span><span class=\"pl-c1\">=</span><span class=\"pl-c1\">1</span> <span class=\"pl-en\">bin</span>/<span class=\"pl-en\">rails</span> <span class=\"pl-en\">test</span></pre></div>\n<p dir=\"auto\">As you can see in the sigdump all threads get stuck in <code class=\"notranslate\">load_interlock_aware_monitor.rb:17:in 'enter' </code><br>\nI am currently trying to create an example project to reproduce this issue but maybe this info is enough for now to make some conclusions.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Sigdump at 2023-06-14 10:11:32 +0200 process 90089 (bin/rails)\n  Thread #&lt;Thread:0x00000001023db0f0 run&gt; status=run priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:52:in `backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:52:in `dump_backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:34:in `block in dump_all_thread_backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:33:in `each'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:33:in `dump_all_thread_backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:16:in `block in dump'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:136:in `open'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:136:in `_open_dump_path'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:14:in `dump'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:7:in `block in setup'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:91:in `clear_query_cache'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:343:in `block in clear_on_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:342:in `each'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:342:in `clear_on_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:272:in `clear_query_caches_for_current_thread'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:21:in `insert'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:496:in `_insert_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:1096:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/counter_cache.rb:166:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/locking/optimistic.rb:79:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/attribute_methods/dirty.rb:222:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:459:in `block in _create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:107:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:929:in `_run_create_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:459:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/timestamp.rb:108:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:6:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:1067:in `create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:455:in `block in create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/autosave_association.rb:370:in `around_save_collection_association'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:929:in `_run_save_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:455:in `create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/timestamp.rb:126:in `create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:648:in `save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/validations.rb:53:in `save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:302:in `block in save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:354:in `block in with_transaction_returning_status'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/transaction.rb:319:in `block in within_new_transaction'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/transaction.rb:317:in `within_new_transaction'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/database_statements.rb:316:in `transaction'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:350:in `with_transaction_returning_status'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:302:in `save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/suppressor.rb:54:in `save!'\n      /Users/krebbl/Projects/ProCarement/care-center/app/models/medical_report.rb:121:in `save_report_as_document'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:167:in `block (3 levels) in &lt;class:MedicalReportTest&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:34:in `assert_nothing_raised'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:250:in `_assert_nothing_raised_or_warn'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:102:in `assert_difference'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:165:in `block (2 levels) in &lt;class:MedicalReportTest&gt;'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:172:in `instance_exec'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:172:in `block in create_test_from_should_hash'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:102:in `block (3 levels) in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:199:in `capture_exceptions'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:97:in `block (2 levels) in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:296:in `time_it'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:96:in `block in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:391:in `on_signal'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:247:in `with_info_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:95:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-reporters-1.4.3/lib/minitest/reporters.rb:48:in `run_with_hooks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:1051:in `run_one_method'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:365:in `run_one_method'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:352:in `block (2 levels) in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:351:in `each'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:351:in `block in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:391:in `on_signal'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:378:in `with_info_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:350:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/railties-7.0.5/lib/rails/test_unit/line_filtering.rb:10:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `block in __run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `map'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `__run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:159:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:83:in `block in autorun'\n  Thread #&lt;Thread:0x0000000109047888 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:40 sleep&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:46:in `sleep'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:46:in `block in spawn_thread'\n  Thread #&lt;Thread:0x0000000109443018@Timeout stdlib thread /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:101 sleep&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `sleep'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `wait'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `block (2 levels) in create_timeout_thread'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:111:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:111:in `block in create_timeout_thread'\n  Thread #&lt;Thread:0x000000010c94b918 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b800 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b710 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b620 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b530 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b440 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b350 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b260 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010ce4f180@worker-1 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:332 sleep_forever&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:128:in `cache_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:107:in `select_all'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:54:in `_query_by_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:942:in `block in exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:928:in `exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:914:in `block in exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:908:in `exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:695:in `load'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:250:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:46:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:520:in `find_take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:98:in `take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:473:in `find_one'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:457:in `find_with_ids'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:69:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:22:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/core.rb:271:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:129:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `block in locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `block in unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:881:in `_scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:428:in `scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/scoping/default.rb:43:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:16:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:148:in `deserialize_global_id'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:132:in `deserialize_argument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `block in deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `map'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:190:in `deserialize_arguments'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:180:in `deserialize_arguments_if_needed'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:44:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:25:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:35:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `block in tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:37:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:25:in `tag_logger'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:24:in `block in execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:54:in `block (4 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:72:in `block in wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:71:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:53:in `block (3 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `instance_exec'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:22:in `execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/queue_adapters/async_adapter.rb:70:in `perform'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:352:in `run_task'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:343:in `block (3 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `loop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `block (2 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `catch'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `block in create_worker'\n  Thread #&lt;Thread:0x000000010d989d20@worker-2 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:332 sleep_forever&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:128:in `cache_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:107:in `select_all'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:54:in `_query_by_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:942:in `block in exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:928:in `exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:914:in `block in exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:908:in `exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:695:in `load'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:250:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:46:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:520:in `find_take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:98:in `take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:473:in `find_one'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:457:in `find_with_ids'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:69:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:22:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/core.rb:271:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:129:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `block in locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `block in unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:881:in `_scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:428:in `scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/scoping/default.rb:43:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:16:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:148:in `deserialize_global_id'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:132:in `deserialize_argument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `block in deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `map'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:190:in `deserialize_arguments'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:180:in `deserialize_arguments_if_needed'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:44:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:25:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:35:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `block in tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:37:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:25:in `tag_logger'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:24:in `block in execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:54:in `block (4 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:72:in `block in wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:71:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:53:in `block (3 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `instance_exec'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:22:in `execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/queue_adapters/async_adapter.rb:70:in `perform'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:352:in `run_task'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:343:in `block (3 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `loop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `block (2 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `catch'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `block in create_worker'\n\"><pre class=\"notranslate\"><code class=\"notranslate\">Sigdump at 2023-06-14 10:11:32 +0200 process 90089 (bin/rails)\n  Thread #&lt;Thread:0x00000001023db0f0 run&gt; status=run priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:52:in `backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:52:in `dump_backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:34:in `block in dump_all_thread_backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:33:in `each'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:33:in `dump_all_thread_backtrace'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:16:in `block in dump'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:136:in `open'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:136:in `_open_dump_path'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:14:in `dump'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:7:in `block in setup'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:91:in `clear_query_cache'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:343:in `block in clear_on_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:342:in `each'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:342:in `clear_on_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:272:in `clear_query_caches_for_current_thread'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:21:in `insert'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:496:in `_insert_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:1096:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/counter_cache.rb:166:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/locking/optimistic.rb:79:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/attribute_methods/dirty.rb:222:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:459:in `block in _create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:107:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:929:in `_run_create_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:459:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/timestamp.rb:108:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:6:in `_create_record'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:1067:in `create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:455:in `block in create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/autosave_association.rb:370:in `around_save_collection_association'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:929:in `_run_save_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:455:in `create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/timestamp.rb:126:in `create_or_update'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:648:in `save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/validations.rb:53:in `save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:302:in `block in save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:354:in `block in with_transaction_returning_status'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/transaction.rb:319:in `block in within_new_transaction'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/transaction.rb:317:in `within_new_transaction'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/database_statements.rb:316:in `transaction'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:350:in `with_transaction_returning_status'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:302:in `save!'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/suppressor.rb:54:in `save!'\n      /Users/krebbl/Projects/ProCarement/care-center/app/models/medical_report.rb:121:in `save_report_as_document'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:167:in `block (3 levels) in &lt;class:MedicalReportTest&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:34:in `assert_nothing_raised'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:250:in `_assert_nothing_raised_or_warn'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:102:in `assert_difference'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:165:in `block (2 levels) in &lt;class:MedicalReportTest&gt;'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:172:in `instance_exec'\n      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:172:in `block in create_test_from_should_hash'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:102:in `block (3 levels) in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:199:in `capture_exceptions'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:97:in `block (2 levels) in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:296:in `time_it'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:96:in `block in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:391:in `on_signal'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:247:in `with_info_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:95:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-reporters-1.4.3/lib/minitest/reporters.rb:48:in `run_with_hooks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:1051:in `run_one_method'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:365:in `run_one_method'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:352:in `block (2 levels) in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:351:in `each'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:351:in `block in run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:391:in `on_signal'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:378:in `with_info_handler'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:350:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/railties-7.0.5/lib/rails/test_unit/line_filtering.rb:10:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `block in __run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `map'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `__run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:159:in `run'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:83:in `block in autorun'\n  Thread #&lt;Thread:0x0000000109047888 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:40 sleep&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:46:in `sleep'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:46:in `block in spawn_thread'\n  Thread #&lt;Thread:0x0000000109443018@Timeout stdlib thread /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:101 sleep&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `sleep'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `wait'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `block (2 levels) in create_timeout_thread'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:111:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:111:in `block in create_timeout_thread'\n  Thread #&lt;Thread:0x000000010c94b918 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b800 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b710 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b620 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b530 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b440 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b350 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010c94b260 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever&gt; status=sleep priority=0\n      &lt;internal:thread_sync&gt;:18:in `pop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'\n  Thread #&lt;Thread:0x000000010ce4f180@worker-1 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:332 sleep_forever&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:128:in `cache_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:107:in `select_all'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:54:in `_query_by_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:942:in `block in exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:928:in `exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:914:in `block in exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:908:in `exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:695:in `load'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:250:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:46:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:520:in `find_take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:98:in `take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:473:in `find_one'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:457:in `find_with_ids'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:69:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:22:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/core.rb:271:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:129:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `block in locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `block in unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:881:in `_scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:428:in `scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/scoping/default.rb:43:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:16:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:148:in `deserialize_global_id'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:132:in `deserialize_argument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `block in deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `map'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:190:in `deserialize_arguments'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:180:in `deserialize_arguments_if_needed'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:44:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:25:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:35:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `block in tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:37:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:25:in `tag_logger'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:24:in `block in execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:54:in `block (4 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:72:in `block in wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:71:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:53:in `block (3 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `instance_exec'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:22:in `execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/queue_adapters/async_adapter.rb:70:in `perform'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:352:in `run_task'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:343:in `block (3 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `loop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `block (2 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `catch'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `block in create_worker'\n  Thread #&lt;Thread:0x000000010d989d20@worker-2 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:332 sleep_forever&gt; status=sleep priority=0\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:128:in `cache_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:107:in `select_all'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:54:in `_query_by_sql'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:942:in `block in exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:928:in `exec_main_query'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:914:in `block in exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:908:in `exec_queries'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:695:in `load'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:250:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:46:in `records'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:520:in `find_take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:98:in `take'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:473:in `find_one'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:457:in `find_with_ids'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:69:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:22:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/core.rb:271:in `find'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:129:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `block in locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `block in unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:881:in `_scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:428:in `scoping'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/scoping/default.rb:43:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `unscoped'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:16:in `locate'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:148:in `deserialize_global_id'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:132:in `deserialize_argument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `block in deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `map'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `deserialize'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:190:in `deserialize_arguments'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:180:in `deserialize_arguments_if_needed'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:44:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:25:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `block in instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:35:in `instrument'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `block in perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `block in tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:37:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `tagged'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:25:in `tag_logger'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `perform_now'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:24:in `block in execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:54:in `block (4 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:72:in `block in wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:71:in `wrap'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:53:in `block (3 levels) in &lt;class:Railtie&gt;'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `instance_exec'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:22:in `execute'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/queue_adapters/async_adapter.rb:70:in `perform'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:352:in `run_task'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:343:in `block (3 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `loop'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `block (2 levels) in create_worker'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `catch'\n      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `block in create_worker'\n\n</code></pre></div>\n<h3 dir=\"auto\">Expected behavior</h3>\n<p dir=\"auto\">The tests should just run through</p>\n<h3 dir=\"auto\">Actual behavior</h3>\n<p dir=\"auto\">The tests get stuck after some while</p>\n<h3 dir=\"auto\">System configuration</h3>\n<p dir=\"auto\"><strong>Rails version</strong>: 7.0.5<br>\n<strong>Ruby version</strong>: 3.2.0</p>",
            "url": "https://github.com/rails/rails/issues/48468",
            "title": "Test suite hangs after upgrading from 6.1 to 7.0",
            "date_modified": "2024-11-26T13:08:58.000Z",
            "date_published": "2023-06-14T08:26:54.000Z",
            "author": {
                "name": "krebbl",
                "url": "https://github.com/krebbl"
            }
        }
    ]
}